<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Storefronts Manager</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Facebook SDK -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
    <!-- Config (Supabase credentials) -->
    <script src="/ui/config.js"></script>
    <!-- Secret API keys (not committed to git) -->
    <script src="/ui/secrets.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 500;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            padding: 0 30px;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px 30px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 15px;
            width: 300px;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 14px;
        }

        .search-box svg {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            color: #999;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9ff;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .ad-copy-item:hover {
            border-color: #667eea !important;
            background: #fafbff !important;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: #eef0f2;
        }

        th .sort-icon {
            margin-left: 5px;
            opacity: 0.3;
        }

        th.sorted .sort-icon {
            opacity: 1;
        }

        tr:hover {
            background: #f8f9ff;
        }

        td {
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #e7f1ff;
            color: #0056b3;
        }

        .likes-count {
            font-weight: 600;
            color: #e91e63;
        }

        .creator-link {
            color: #667eea;
            text-decoration: none;
        }

        .creator-link:hover {
            text-decoration: underline;
        }

        .checkbox-cell {
            width: 40px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination-btn:hover {
            background: #f5f5f5;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .selected-count {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-left: 10px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            border: 2px dashed #ddd;
        }

        .upload-section h3 {
            margin-bottom: 15px;
            color: #666;
        }

        .upload-section p {
            color: #999;
            margin-bottom: 20px;
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 14px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover, .filter-chip.active {
            background: #667eea;
            color: white;
        }

        .truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scraping Status Indicator */
        .scraping-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scraping-indicator:hover {
            background: rgba(255,255,255,0.25);
        }

        .scraping-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #888;
        }

        .scraping-dot.active {
            background: #4ade80;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(74, 222, 128, 0); }
        }

        .scraping-info {
            text-align: left;
        }

        .scraping-status-text {
            font-size: 12px;
            font-weight: 600;
        }

        .scraping-detail {
            font-size: 10px;
            opacity: 0.8;
        }

        /* Scraping Modal */
        .scraping-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .scraping-modal.show {
            display: flex;
        }

        .scraping-modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .scraping-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scraping-modal-header h2 {
            font-size: 18px;
            font-weight: 500;
        }

        .scraping-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .scraping-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .scraping-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .scraping-stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .scraping-stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
        }

        .scraping-stat-card .label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .scraping-progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .scraping-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .scraping-logs {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .scraping-logs .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .scraping-logs .log-entry.error {
            color: #f87171;
        }

        .scraping-logs .log-entry.success {
            color: #4ade80;
        }

        .scraping-logs .log-time {
            color: #888;
            margin-right: 8px;
        }

        /* Scraping Start Form */
        .scraping-start-form {
            padding: 20px;
        }

        .scraping-form-group {
            margin-bottom: 20px;
        }

        .scraping-form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .scraping-form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .scraping-presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .scraping-preset-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .scraping-preset-btn:hover, .scraping-preset-btn.active {
            background: #667eea;
            color: white;
        }

        .scraping-cost-estimate {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
        }

        .scraping-cost-estimate .cost-value {
            font-weight: 600;
            color: #d97706;
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 10000;">
        <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 100%; max-width: 400px;">
            <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Amazon Storefronts Manager</h2>
            <form id="loginForm" onsubmit="return handleLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">Username</label>
                    <input type="text" id="loginUsername" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Enter username">
                </div>
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">Password</label>
                    <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Enter password">
                </div>
                <div id="loginError" style="color: #dc3545; margin-bottom: 15px; text-align: center; display: none;">Invalid username or password</div>
                <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer;">Login</button>
            </form>
        </div>
    </div>

    <!-- Main App Container (hidden until login) -->
    <div id="mainApp" style="display: none;">
    <div class="header">
        <h1>Amazon Storefronts Manager</h1>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalStorefronts">-</div>
                <div class="stat-label">Storefronts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalLists">-</div>
                <div class="stat-label">Lists</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalLikes">-</div>
                <div class="stat-label">Total Likes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="topCreators">-</div>
                <div class="stat-label">Top Creators</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalProducts">-</div>
                <div class="stat-label">Products</div>
            </div>
            <!-- Scraping Status Indicator -->
            <div class="scraping-indicator" id="scrapingIndicator" onclick="openScrapingModal()">
                <div class="scraping-dot" id="scrapingDot"></div>
                <div class="scraping-info">
                    <div class="scraping-status-text" id="scrapingStatusText">Offline</div>
                    <div class="scraping-detail" id="scrapingDetail">Click to start</div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" data-tab="storefronts">Storefronts</div>
        <div class="nav-tab" data-tab="lists">Lists</div>
        <div class="nav-tab" data-tab="products">Products</div>
        <div class="nav-tab" data-tab="draft" id="draftTab">Create Campaign</div>
        <div class="nav-tab" data-tab="livecampaigns">Live Campaigns</div>
        <div class="nav-tab" data-tab="library">Image Library</div>
        <a href="import.html" class="nav-tab" style="margin-left: auto; text-decoration: none;">Import Data</a>
    </div>

    <!-- Storefronts Tab -->
    <div id="storefronts-tab" class="tab-content active">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="storefrontSearch" placeholder="Search storefronts...">
                    </div>
                    <div class="filter-chips">
                        <div class="filter-chip active" data-filter="all">All</div>
                        <div class="filter-chip" data-filter="top">Top Creators</div>
                        <div class="filter-chip" data-filter="high-likes">High Likes (100+)</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openAddStorefrontsModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Storefronts
                    </button>
                    <button class="btn btn-success" onclick="openUpdateDataModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Update Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportStorefronts()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="storefrontsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="selectAllStorefronts"></th>
                            <th data-sort="username">Username <span class="sort-icon">↕</span></th>
                            <th data-sort="name">Creator Name <span class="sort-icon">↕</span></th>
                            <th data-sort="isTop">Top Creator <span class="sort-icon">↕</span></th>
                            <th data-sort="likes">Storefront Likes <span class="sort-icon">↕</span></th>
                            <th data-sort="lists">Lists <span class="sort-icon">↕</span></th>
                            <th data-sort="totalListLikes">Total List Likes <span class="sort-icon">↕</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="storefrontsBody">
                        <tr><td colspan="8" class="loading"><div class="loading-spinner"></div>Loading storefronts...</td></tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="pagination-info" id="storefrontsPaginationInfo">Showing 0-0 of 0</div>
                    <div class="pagination-controls" id="storefrontsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lists Tab -->
    <div id="lists-tab" class="tab-content">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="listSearch" placeholder="Search lists...">
                    </div>
                    <select id="storefrontFilter" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">All Storefronts</option>
                    </select>
                </div>
                <div class="btn-group">
                    <span id="selectedListsCount" class="selected-count" style="display: none;">0 selected</span>
                    <button class="btn btn-primary" onclick="exportSelectedLists()" id="exportSelectedBtn" style="display: none;">
                        Export Selected
                    </button>
                    <button class="btn btn-secondary" onclick="exportLists()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export All CSV
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="listsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="selectAllLists"></th>
                            <th data-sort="storefront">Storefront <span class="sort-icon">↕</span></th>
                            <th data-sort="name">List Name <span class="sort-icon">↕</span></th>
                            <th data-sort="likes">Likes <span class="sort-icon">↕</span></th>
                            <th data-sort="products">Products <span class="sort-icon">↕</span></th>
                            <th data-sort="lastScraped">Last Scraped <span class="sort-icon">↕</span></th>
                            <th>List URL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="listsBody">
                        <tr><td colspan="8" class="loading"><div class="loading-spinner"></div>Loading lists...</td></tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="pagination-info" id="listsPaginationInfo">Showing 0-0 of 0</div>
                    <div class="pagination-controls" id="listsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Tab -->
    <div id="products-tab" class="tab-content">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="productSearch" placeholder="Search products by ASIN or title...">
                    </div>
                    <select id="productStorefrontFilter" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">All Storefronts</option>
                    </select>
                    <select id="productListFilter" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">All Lists</option>
                    </select>
                </div>
                <div class="btn-group">
                    <span id="selectedProductsCount" class="selected-count" style="display: none;">0 selected</span>
                    <button class="btn btn-primary" onclick="exportSelectedProducts()" id="exportSelectedProductsBtn" style="display: none;">
                        Export Selected
                    </button>
                    <select id="productExportFormat" style="padding: 10px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="txt">ASINs Only</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportAllProducts()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export All
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="selectAllProducts"></th>
                            <th data-sort="asin">ASIN <span class="sort-icon">↕</span></th>
                            <th data-sort="title">Product Title <span class="sort-icon">↕</span></th>
                            <th data-sort="price">Price <span class="sort-icon">↕</span></th>
                            <th data-sort="storefront">Storefront <span class="sort-icon">↕</span></th>
                            <th>Amazon URL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                        <tr><td colspan="7" class="loading"><div class="loading-spinner"></div>Loading products...</td></tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="pagination-info" id="productsPaginationInfo">Showing 0-0 of 0</div>
                    <div class="pagination-controls" id="productsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Draft Tab -->
    <div id="draft-tab" class="tab-content">
        <div class="container">
            <!-- Draft Step Indicator -->
            <div class="draft-steps" style="display: flex; justify-content: center; margin-bottom: 30px; gap: 0; flex-wrap: wrap;">
                <div class="draft-step active" id="draftStep1" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #667eea; position: relative;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">1</div>
                    <span>List Overview</span>
                </div>
                <div style="width: 30px; height: 2px; background: #ddd; align-self: center;"></div>
                <div class="draft-step" id="draftStep2" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #999;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">2</div>
                    <span>Campaign Setup</span>
                </div>
                <div style="width: 30px; height: 2px; background: #ddd; align-self: center;"></div>
                <div class="draft-step" id="draftStep3" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #999;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">3</div>
                    <span>Creatives</span>
                </div>
                <div style="width: 30px; height: 2px; background: #ddd; align-self: center;"></div>
                <div class="draft-step" id="draftStep4" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #999;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">4</div>
                    <span>Review & Upload</span>
                </div>
            </div>

            <!-- List Selector (shown when no list selected) -->
            <div id="draftListSelector" class="table-container" style="margin-bottom: 20px;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee;">
                    <h2 style="font-size: 18px; font-weight: 600;">Select a List for Campaign</h2>
                </div>
                <div style="padding: 25px;">
                    <p style="color: #666; margin-bottom: 20px;">Choose a list from your storefronts to start creating a Facebook campaign.</p>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; max-width: 800px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Storefront</label>
                            <select id="draftStorefrontSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" onchange="updateDraftListOptions()">
                                <option value="">Select storefront...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">List</label>
                            <select id="draftListSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" disabled>
                                <option value="">Select a storefront first...</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="startDraftFromSelector()" id="startDraftBtn" disabled>
                        Start Campaign
                    </button>
                </div>
            </div>

            <!-- Step 1: List Overview -->
            <div id="draftSection1" class="table-container" style="margin-bottom: 20px;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 18px; font-weight: 600;">List Overview</h2>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 1 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h3 id="draftListTitle" style="font-size: 24px; margin-bottom: 10px;">Select a list</h3>
                            <p id="draftListDesc" style="color: #666; line-height: 1.6; margin-bottom: 15px;">Click "Duplicate" on any list to start creating a campaign.</p>
                            <div style="display: flex; gap: 20px; margin-top: 15px;">
                                <div style="text-align: center; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                                    <div id="draftProductCount" style="font-size: 24px; font-weight: 600; color: #667eea;">0</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Products</div>
                                </div>
                                <div style="text-align: center; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                                    <div id="draftListLikes" style="font-size: 24px; font-weight: 600; color: #667eea;">0</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Likes</div>
                                </div>
                                <div style="text-align: center; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                                    <div id="draftStorefront" style="font-size: 14px; font-weight: 600; color: #667eea;">-</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Storefront</div>
                                </div>
                            </div>
                        </div>
                        <div id="draftProductsPreview" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                            <p style="color: #999; text-align: center; padding: 20px;">No list selected</p>
                        </div>
                    </div>

                    <!-- AI Prompts Section -->
                    <div style="margin-top: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div onclick="toggleDraftPrompt('titlePrompt')" style="padding: 15px 20px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>AI Title & Description Generator</span>
                            <span id="titlePromptToggle" style="font-size: 20px; color: #999;">▼</span>
                        </div>
                        <div id="titlePromptBody" style="display: none; padding: 20px; border-top: 1px solid #e0e0e0;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">System Prompt for Title</label>
                                <textarea id="draftTitlePrompt" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px;">Generate 3 catchy titles for this Amazon product list. Keep under 60 characters. Make it engaging and highlight value.

List: {{list_name}}
Products: {{products}}</textarea>
                            </div>
                            <button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="generateDraftTitles()">Generate Titles</button>
                            <div id="generatedTitles" style="margin-top: 15px; display: none;"></div>

                            <div style="margin: 20px 0 15px; border-top: 1px solid #eee; padding-top: 20px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">System Prompt for Description</label>
                                <textarea id="draftDescPrompt" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px;">Generate 3 descriptions (2-3 sentences each) for this product list. Create urgency and highlight benefits.

List: {{list_name}}
Products: {{products}}</textarea>
                            </div>
                            <button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="generateDraftDescriptions()">Generate Descriptions</button>
                            <div id="generatedDescriptions" style="margin-top: 15px; display: none;"></div>
                        </div>
                    </div>

                    <!-- Editable Fields -->
                    <div style="margin-top: 25px;">
                        <h4 style="margin-bottom: 15px;">Final Title & Description</h4>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">List Title</label>
                            <input type="text" id="draftFinalTitle" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" value="">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">List Description</label>
                            <textarea id="draftFinalDesc" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="exportDraftList()">Export List</button>
                    <button class="btn btn-primary" onclick="goToDraftStep(2)">Next: Campaign Setup →</button>
                </div>
            </div>

            <!-- Step 2: Campaign Setup -->
            <div id="draftSection2" class="table-container" style="margin-bottom: 20px; display: none;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h2 style="font-size: 18px; font-weight: 600;">Campaign Setup</h2>
                        <span id="listNameStep2" style="background: #f0f0f0; color: #666; padding: 4px 12px; border-radius: 12px; font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                    </div>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 2 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <div style="max-width: 600px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Campaign Objective</label>
                            <select id="campaignObjective" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="OUTCOME_SALES" selected>Sales (Conversions)</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Performance Goal</label>
                            <select id="performanceGoal" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <optgroup label="Conversions">
                                    <option value="OFFSITE_CONVERSIONS" selected>Maximize conversions (requires Pixel)</option>
                                    <option value="VALUE">Maximize conversion value (requires Pixel)</option>
                                    <option value="LANDING_PAGE_VIEWS">Maximize landing page views</option>
                                </optgroup>
                                <optgroup label="Traffic">
                                    <option value="LINK_CLICKS">Maximize link clicks</option>
                                    <option value="REACH">Maximize reach</option>
                                    <option value="IMPRESSIONS">Maximize impressions</option>
                                </optgroup>
                                <optgroup label="Engagement">
                                    <option value="POST_ENGAGEMENT">Maximize post engagement</option>
                                    <option value="PAGE_LIKES">Maximize page likes</option>
                                    <option value="EVENT_RESPONSES">Maximize event responses</option>
                                    <option value="THRUPLAY">Maximize ThruPlay (video views)</option>
                                </optgroup>
                                <optgroup label="Leads">
                                    <option value="LEAD_GENERATION">Maximize lead generation</option>
                                    <option value="QUALITY_LEAD">Maximize quality leads</option>
                                </optgroup>
                                <optgroup label="Awareness">
                                    <option value="AD_RECALL_LIFT">Maximize ad recall lift</option>
                                </optgroup>
                                <optgroup label="App">
                                    <option value="APP_INSTALLS">Maximize app installs</option>
                                </optgroup>
                                <optgroup label="Messaging">
                                    <option value="CONVERSATIONS">Maximize conversations</option>
                                    <option value="MESSAGING_PURCHASE_CONVERSION">Maximize messaging purchases</option>
                                </optgroup>
                            </select>
                            <small style="color: #666;">How Facebook will optimize ad delivery</small>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Facebook Page <span style="color: #dc3545;">*</span></label>
                            <div id="fbPageLoginSection" style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="loginToFacebook()" class="btn btn-primary" style="background: #1877f2; padding: 10px 20px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white" style="margin-right: 8px;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                    Connect to Facebook
                                </button>
                                <span style="color: #666; font-size: 13px;">Connect to select a Page</span>
                            </div>
                            <div id="fbPageSelectSection" style="display: none;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select id="fbPageSelect" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" onchange="handleFbPageChange()">
                                        <option value="">Select a Page...</option>
                                    </select>
                                    <button onclick="logoutFromFacebook()" class="btn btn-secondary" style="padding: 10px 15px; font-size: 12px;">Disconnect</button>
                                </div>
                                <small style="color: #666;">Ads will be published from this Page</small>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Campaign Name Template</label>
                            <input type="text" id="campaignNameTemplate" value="{{storefront}}_{{list_name}}_{{date}}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <small style="color: #999;">Variables: {{storefront}}, {{list_name}}, {{date}}</small>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Preview Campaign Name</label>
                            <input type="text" id="campaignNamePreview" readonly style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Daily Budget ($)</label>
                            <input type="number" id="dailyBudget" value="20" min="1" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Target Audience</label>
                            <select id="targetAudience" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="broad">Broad - Let Facebook optimize</option>
                                <option value="interest">Interest-based targeting</option>
                                <option value="lookalike">Lookalike audience</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Target Countries</label>
                            <div id="targetCountries" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="US" checked> US
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="GB"> UK
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="CA"> Canada
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="AU"> Australia
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="DE"> Germany
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="FR"> France
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="ES"> Spain
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="IT"> Italy
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" value="JP"> Japan
                                </label>
                            </div>
                            <small style="color: #666;">Select at least one country</small>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Age Range</label>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666;">Min Age</label>
                                    <select id="ageMin" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="18" selected>18</option>
                                        <option value="21">21</option>
                                        <option value="25">25</option>
                                        <option value="30">30</option>
                                        <option value="35">35</option>
                                        <option value="40">40</option>
                                        <option value="45">45</option>
                                        <option value="50">50</option>
                                        <option value="55">55</option>
                                        <option value="60">60</option>
                                    </select>
                                </div>
                                <span style="color: #999;">to</span>
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666;">Max Age</label>
                                    <select id="ageMax" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="25">25</option>
                                        <option value="30">30</option>
                                        <option value="35">35</option>
                                        <option value="40">40</option>
                                        <option value="45">45</option>
                                        <option value="50">50</option>
                                        <option value="55">55</option>
                                        <option value="60">60</option>
                                        <option value="65" selected>65+</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Gender</label>
                            <div style="display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; flex: 1; justify-content: center;">
                                    <input type="radio" name="gender" value="all" checked> All
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; flex: 1; justify-content: center;">
                                    <input type="radio" name="gender" value="1"> Male
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; flex: 1; justify-content: center;">
                                    <input type="radio" name="gender" value="2"> Female
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Devices</label>
                            <div style="display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; flex: 1; justify-content: center;">
                                    <input type="radio" name="devices" value="all" checked> All Devices
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; flex: 1; justify-content: center;">
                                    <input type="radio" name="devices" value="mobile"> Mobile Only
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; flex: 1; justify-content: center;">
                                    <input type="radio" name="devices" value="desktop"> Desktop Only
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="goToDraftStep(1)">← Back</button>
                    <button class="btn btn-primary" onclick="goToDraftStep(3)">Next: Creatives →</button>
                </div>
            </div>

            <!-- Step 3: Facebook Creative -->
            <div id="draftSection3" class="table-container" style="margin-bottom: 20px; display: none;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h2 style="font-size: 18px; font-weight: 600;">Facebook Creatives</h2>
                        <span id="listNameStep3" style="background: #f0f0f0; color: #666; padding: 4px 12px; border-radius: 12px; font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                    </div>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 3 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <!-- Image Generation Section -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Ad Images</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="openLibraryPopup()" style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                Library
                            </button>
                            <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                Upload Images
                                <input type="file" id="uploadImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            </label>
                        </div>
                    </div>

                    <!-- Image Generation Controls - Always Visible -->
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 500; font-size: 13px;">Model:</span>
                            <select id="imageModelSelect" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="nano-banana" selected>🍌 Nano Banana (Gemini 2.0 Flash)</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 500; font-size: 13px;">Prompt:</span>
                            <select id="promptTemplateSelect" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="changePromptTemplate()">
                                <option value="ugc">UGC Influencer Style</option>
                                <option value="branded">Professional Branded</option>
                                <option value="canva">Text-Focused Canva</option>
                                <option value="products">Product Images</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 500; font-size: 13px;">Size:</span>
                            <select id="imageDimensions" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="all">All FB Sizes (3)</option>
                                <option value="1080x1080">Square 1:1</option>
                                <option value="1200x628">Landscape 1.91:1</option>
                                <option value="1080x1920">Story 9:16</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 500; font-size: 13px;">Count:</span>
                            <select id="imageCount" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="generateImagesBtn" style="padding: 10px 20px; font-size: 13px;" onclick="generateDraftImages()">
                            <span id="generateBtnText">🍌 Generate Images</span>
                            <span id="generateBtnSpinner" style="display: none;">⏳ Generating...</span>
                        </button>
                        <button class="btn" id="stopGenerateBtn" style="display: none; padding: 10px 20px; font-size: 13px; background: #dc3545; color: white; border: none;" onclick="stopImageGeneration()">
                            ⏹️ Stop
                        </button>
                    </div>

                    <!-- Prompt Configuration - Collapsible -->
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <div onclick="toggleDraftPrompt('imagePrompt')" style="padding: 12px 20px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; font-size: 13px; color: #666;">
                            <span>📝 Edit Prompt (Advanced)</span>
                            <span id="imagePromptToggle" style="font-size: 16px; color: #999;">▼</span>
                        </div>
                        <div id="imagePromptBody" style="display: none; padding: 20px; border-top: 1px solid #e0e0e0;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Prompt</label>
                            <textarea id="draftImagePrompt" style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px;">Create a UGC-style Facebook ad image for "{{list_name}}"

Style: Authentic influencer content, user-generated feel, casual and relatable
Colors: Vibrant, eye-catching, bold and playful color palette
Mood: Excited influencer sharing their favorite finds with followers
Scene: Lifestyle setting with products arranged naturally, like an unboxing or haul

Key elements:
- Bright, saturated colors that pop in the feed
- Natural lighting with warm tones
- Products displayed in an authentic, "just discovered this" way
- Engaging composition that feels personal, not corporate</textarea>
                            <!-- Product Images Preview (shown when "Use Product Images" template selected) -->
                            <div id="productImagesPreview" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Images Grid (6 images) -->
                    <div id="draftImagesGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 30px;">
                        <!-- Placeholder images -->
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="1" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; padding: 10px; text-align: center;">Generate or upload</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 1</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="2" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 2</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="3" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 3</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="4" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 4</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="5" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 5</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="6" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 6</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                    </div>

                    <!-- Refine Images Section - Always Visible -->
                    <div id="imageFollowupSection" style="margin-bottom: 20px; padding: 15px 20px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; display: none;">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <span style="font-weight: 500; font-size: 13px; color: #666;">Refine:</span>
                            <input type="text" id="imageFollowupPrompt" placeholder="e.g., Make more colorful, add sale badge, change background..." style="flex: 1; min-width: 250px; padding: 10px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <label class="btn btn-secondary" style="cursor: pointer; margin: 0; display: flex; align-items: center; gap: 5px; padding: 10px 14px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                Inspo
                                <input type="file" id="inspoImageUpload" accept="image/*" style="display: none;" onchange="handleInspoUpload(event)">
                            </label>
                            <button class="btn btn-primary" onclick="refineImages()" style="padding: 10px 20px;">🔄 Refine</button>
                        </div>
                        <div id="inspoImagePreview" style="margin-top: 10px; display: none;">
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #eee;">
                                <img id="inspoImageThumb" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; font-weight: 500;">Inspiration image</div>
                                    <div style="font-size: 11px; color: #666;">Style reference</div>
                                </div>
                                <button onclick="clearInspoImage()" style="background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 5px;">×</button>
                            </div>
                        </div>
                        <div id="imagePromptHistory" style="margin-top: 8px; font-size: 11px; color: #999;"></div>
                    </div>

                    <!-- Ad Copy Generation Section -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px;">
                        <h3>Ad Copy</h3>
                    </div>

                    <!-- Ad Copy Controls - Always Visible -->
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 500; font-size: 13px;">Style:</span>
                            <select id="adCopyStyleSelect" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="changeAdCopyStyle()">
                                <option value="default">Default (Punchy & Direct)</option>
                                <option value="emotional">Emotional Appeal</option>
                                <option value="urgency">Urgency & Scarcity</option>
                                <option value="benefit">Benefit-Focused</option>
                                <option value="question">Question-Based</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="generateAdCopyBtn" style="padding: 10px 20px; font-size: 13px;" onclick="generateDraftAdCopy()">
                            <span id="generateAdCopyBtnText">✍️ Generate Ad Copy</span>
                            <span id="generateAdCopyBtnSpinner" style="display: none;">⏳ Generating...</span>
                        </button>
                    </div>

                    <!-- Ad Copy Prompts - Collapsible -->
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <div onclick="toggleDraftPrompt('adCopyPrompt')" style="padding: 12px 20px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; font-size: 13px; color: #666;">
                            <span>📝 Edit Prompts (Advanced)</span>
                            <span id="adCopyPromptToggle" style="font-size: 16px; color: #999;">▼</span>
                        </div>
                        <div id="adCopyPromptBody" style="display: none; padding: 20px; border-top: 1px solid #e0e0e0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Titles Prompt</label>
                                    <textarea id="draftTitlesPrompt" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px;">Generate 5 ad titles (40 chars max). Punchy, attention-grabbing.

List: {{list_name}}</textarea>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Descriptions Prompt</label>
                                    <textarea id="draftDescriptionsPrompt" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px;">Generate 5 short descriptions (90 chars max). Highlight benefits.

List: {{list_name}}</textarea>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Post Texts Prompt</label>
                                    <textarea id="draftPostTextsPrompt" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px;">Generate 5 post texts (125 chars max). Hook + value prop + CTA.

List: {{list_name}}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Three Column Ad Copy Selection -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <!-- Titles Column -->
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #555;">Titles <span id="selectedTitlesCount" style="color: #667eea;">(0 selected)</span></h4>
                            <div id="adTitlesList" style="display: flex; flex-direction: column; gap: 8px;">
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                    <input type="checkbox" data-type="title" data-index="1" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Click "Generate" to create...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="2" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="3" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="4" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="5" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <!-- Custom Title -->
                                <div style="padding: 10px; border: 1px dashed #ddd; border-radius: 6px;">
                                    <input type="text" id="customTitle" placeholder="+ Add custom title..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                            </div>
                        </div>

                        <!-- Descriptions Column -->
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #555;">Descriptions <span id="selectedDescriptionsCount" style="color: #667eea;">(0 selected)</span></h4>
                            <div id="adDescriptionsList" style="display: flex; flex-direction: column; gap: 8px;">
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="1" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Click "Generate" to create...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="2" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="3" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="4" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="5" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <!-- Custom Description -->
                                <div style="padding: 10px; border: 1px dashed #ddd; border-radius: 6px;">
                                    <input type="text" id="customDescription" placeholder="+ Add custom description..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                            </div>
                        </div>

                        <!-- Post Texts Column -->
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #555;">Post Texts <span id="selectedPostTextsCount" style="color: #667eea;">(0 selected)</span></h4>
                            <div id="adPostTextsList" style="display: flex; flex-direction: column; gap: 8px;">
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="1" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Click "Generate" to create...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="2" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="3" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="4" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="5" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <!-- Custom Post Text -->
                                <div style="padding: 10px; border: 1px dashed #ddd; border-radius: 6px;">
                                    <textarea id="customPostText" placeholder="+ Add custom post text..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-height: 40px;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Refine Ad Copy Section - Always Visible -->
                    <div id="adCopyFollowupSection" style="margin-bottom: 20px; padding: 15px 20px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; display: none;">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <span style="font-weight: 500; font-size: 13px; color: #666;">Refine:</span>
                            <input type="text" id="adCopyFollowupPrompt" placeholder="e.g., Make title 2 more urgent, add emoji to post text 3, make descriptions shorter..." style="flex: 1; min-width: 250px; padding: 10px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <button class="btn btn-primary" onclick="refineAdCopy()" style="padding: 10px 20px;">🔄 Refine</button>
                        </div>
                        <div id="adCopyPromptHistory" style="margin-top: 8px; font-size: 11px; color: #999;"></div>
                    </div>

                    <!-- Selection Summary -->
                    <div style="margin-top: 25px; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <strong>Selected:</strong>
                                <span id="selectedImagesCount" style="margin-left: 10px;">0</span> images ×
                                <span id="selectedTitlesTotal" style="margin-left: 5px;">0</span> titles ×
                                <span id="selectedDescTotal" style="margin-left: 5px;">0</span> descriptions ×
                                <span id="selectedPostTotal" style="margin-left: 5px;">0</span> post texts
                                = <span id="totalCombinations" style="color: #667eea; font-weight: 600;">0</span> total ad combinations
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="goToDraftStep(2)">← Back</button>
                    <button class="btn btn-primary" onclick="validateAndGoToStep4()">Next: Review & Upload →</button>
                </div>
            </div>

            <!-- Step 4: Review & Upload -->
            <div id="draftSection4" class="table-container" style="margin-bottom: 20px; display: none;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h2 style="font-size: 18px; font-weight: 600;">Review & Upload</h2>
                        <span id="listNameStep4" style="background: #f0f0f0; color: #666; padding: 4px 12px; border-radius: 12px; font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                    </div>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 4 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Left Column: Campaign Summary -->
                        <div>
                            <h3 style="margin-bottom: 20px; color: #333;">Campaign Summary</h3>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Campaign Name</label>
                                    <p id="reviewCampaignName" style="font-weight: 600; margin-top: 5px;">-</p>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Objective</label>
                                    <p id="reviewObjective" style="font-weight: 600; margin-top: 5px;">Conversions</p>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Daily Budget</label>
                                    <p id="reviewBudget" style="font-weight: 600; margin-top: 5px;">$20</p>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Target Audience</label>
                                    <p id="reviewAudience" style="font-weight: 600; margin-top: 5px;">Broad</p>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">List</label>
                                    <p id="reviewListName" style="font-weight: 600; margin-top: 5px;">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Creative Summary -->
                        <div>
                            <h3 style="margin-bottom: 20px; color: #333;">Creative Summary</h3>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <span>Images Selected</span>
                                    <strong id="reviewImagesCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Titles</span>
                                    <strong id="reviewTitlesCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Descriptions</span>
                                    <strong id="reviewDescCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <span>Post Texts</span>
                                    <strong id="reviewPostCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <span>Total Ad Combinations</span>
                                    <strong id="reviewTotalAds" style="color: #667eea;">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Products in List</span>
                                    <strong id="reviewProductCount">0</strong>
                                </div>
                            </div>

                            <!-- Warnings -->
                            <div id="reviewWarnings" style="margin-top: 15px; display: none;">
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px;">
                                    <strong style="color: #856404;">Warning:</strong>
                                    <p id="reviewWarningText" style="color: #856404; margin-top: 5px; font-size: 14px;"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Facebook Connection Status -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="#1877F2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                <div>
                                    <div style="font-weight: 600;">Facebook Ads</div>
                                    <div id="fbConnectionStatus" style="font-size: 12px; color: #666;">Not connected</div>
                                </div>
                            </div>
                            <div id="fbLoginSection">
                                <button id="fbLoginBtn" class="btn btn-primary" onclick="loginToFacebook()" style="background: #1877F2; border-color: #1877F2;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="white" style="margin-right: 6px;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                    Connect Facebook
                                </button>
                            </div>
                            <div id="fbConnectedSection" style="display: none;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <img id="fbUserPic" style="width: 32px; height: 32px; border-radius: 50%;" src="">
                                    <div>
                                        <div id="fbUserName" style="font-size: 13px; font-weight: 500;"></div>
                                        <a href="#" onclick="logoutFromFacebook(); return false;" style="font-size: 11px; color: #666;">Disconnect</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Confirmation Checkbox -->
                    <div style="margin-top: 20px; padding: 20px; background: #e7f1ff; border-radius: 8px;">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="confirmUpload" style="margin-top: 3px; width: 18px; height: 18px;">
                            <span style="line-height: 1.5;">
                                I confirm that all campaign settings and creatives are correct. I understand that the campaign will be submitted to Facebook Ads Manager for review.
                            </span>
                        </label>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="goToDraftStep(3)">← Back to Creatives</button>
                    <button class="btn btn-success" id="uploadBtn" onclick="uploadToFacebook()" disabled style="opacity: 0.6;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17,8 12,3 7,8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Upload to Facebook
                    </button>
                </div>
            </div>

            <!-- Success State -->
            <div id="draftSuccess" class="table-container" style="display: none;">
                <div style="text-align: center; padding: 60px 40px;">
                    <div style="width: 80px; height: 80px; background: #d4edda; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                    </div>
                    <h2 style="color: #28a745; margin-bottom: 10px;">Campaign Created Successfully!</h2>
                    <p style="color: #666; margin-bottom: 30px;">Your campaign has been uploaded to Facebook Ads Manager.</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto 30px; text-align: left;">
                        <p><strong>Campaign:</strong> <span id="finalCampaignName">-</span></p>
                        <p><strong>Status:</strong> Pending Review</p>
                        <p><strong>Budget:</strong> $<span id="finalBudget">20</span>/day</p>
                        <p><strong>Ads Created:</strong> <span id="finalAdsCount">0</span></p>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="backToLists()">Back to Lists</button>
                        <button class="btn btn-primary" onclick="window.open('https://business.facebook.com/adsmanager', '_blank')">Open Ads Manager</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Lists Modal -->
    <div class="modal-overlay" id="viewListsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Lists for <span id="modalStorefrontName"></span></h2>
                <button class="modal-close" onclick="closeModal('viewListsModal')">&times;</button>
            </div>
            <div class="modal-body" id="modalListsBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewListsModal')">Close</button>
                <button class="btn btn-primary" onclick="exportModalLists()">Export These Lists</button>
            </div>
        </div>
    </div>

    <!-- Add Storefronts Modal -->
    <div class="modal-overlay" id="addStorefrontsModal">
        <div class="modal" style="width: 700px;">
            <div class="modal-header">
                <h2>Add Storefronts</h2>
                <button class="modal-close" onclick="closeModal('addStorefrontsModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #eee;">
                    <button class="add-sf-tab active" data-tab="urls" onclick="switchAddTab('urls')" style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid #667eea; margin-bottom: -2px; cursor: pointer; font-weight: 500; color: #667eea;">
                        Paste URLs
                    </button>
                    <button class="add-sf-tab" data-tab="google" onclick="switchAddTab('google')" style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; cursor: pointer; font-weight: 500; color: #666;">
                        Scrape Google
                    </button>
                </div>

                <!-- Paste URLs Tab -->
                <div id="addTab-urls" class="add-tab-content">
                    <p style="color: #666; margin-bottom: 15px;">Paste Amazon storefront URLs (one per line):</p>
                    <textarea id="storefrontUrlsInput" placeholder="https://www.amazon.com/shop/username1
https://www.amazon.com/shop/username2
https://www.amazon.com/shop/username3" style="width: 100%; height: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 13px; resize: vertical;"></textarea>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="urlsCount" style="color: #666; font-size: 13px;">0 URLs detected</span>
                        <button class="btn btn-primary" onclick="addStorefrontsFromUrls()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Add Storefronts
                        </button>
                    </div>
                </div>

                <!-- Scrape Google Tab -->
                <div id="addTab-google" class="add-tab-content" style="display: none;">
                    <p style="color: #666; margin-bottom: 15px;">Search Google for Amazon storefronts:</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="googleSearchQuery" placeholder="e.g., amazon influencer storefront fitness" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <select id="googleSearchCount" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="10">10 results</option>
                            <option value="25">25 results</option>
                            <option value="50" selected>50 results</option>
                            <option value="100">100 results</option>
                        </select>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="font-size: 13px; color: #555; margin-bottom: 8px;"><strong>Suggested searches:</strong></p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="setGoogleSearch('site:amazon.com/shop influencer')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Amazon Influencers</button>
                            <button onclick="setGoogleSearch('site:amazon.com/shop fitness lifestyle')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Fitness</button>
                            <button onclick="setGoogleSearch('site:amazon.com/shop beauty skincare')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Beauty</button>
                            <button onclick="setGoogleSearch('site:amazon.com/shop home decor')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Home Decor</button>
                            <button onclick="setGoogleSearch('site:amazon.com/shop tech gadgets')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Tech</button>
                        </div>
                    </div>
                    <div id="googleScrapeStatus" style="display: none; padding: 15px; background: #e8f4fd; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                            <span id="googleScrapeText">Searching Google...</span>
                        </div>
                    </div>
                    <div id="googleResults" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;"></div>
                    <div style="display: flex; justify-content: flex-end;">
                        <button class="btn btn-primary" onclick="scrapeGoogleStorefronts()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                            Search Google
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Data Progress Modal -->
    <div class="modal-overlay" id="updateDataModal">
        <div class="modal" style="width: 500px;">
            <div class="modal-header">
                <h2>Updating Storefronts</h2>
            </div>
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <div class="loading-spinner" style="width: 40px; height: 40px; border-width: 3px; margin: 0 auto 20px;"></div>
                <div id="updateProgressText" style="font-size: 16px; color: #333; margin-bottom: 10px;">Initializing...</div>
                <div id="updateProgressDetail" style="font-size: 13px; color: #666;"></div>
                <div style="margin-top: 20px; background: #f0f0f0; border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="updateProgressBar" style="width: 0%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Campaigns Tab -->
    <div id="livecampaigns-tab" class="tab-content">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2 style="margin: 0; font-size: 20px;">Live Campaigns</h2>
                    <span id="liveCampaignsCount" style="color: #666; font-size: 14px;">(0 campaigns)</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="campaignStatusFilter" onchange="filterLiveCampaigns()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="all">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="PAUSED">Paused</option>
                    </select>
                    <select id="campaignDateRange" onchange="loadLiveCampaigns()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="last_7d">Last 7 Days</option>
                        <option value="last_30d" selected>Last 30 Days</option>
                        <option value="this_month">This Month</option>
                        <option value="lifetime">Lifetime</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadLiveCampaigns()" style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Facebook Login Required Message -->
            <div id="fbLoginRequiredCampaigns" style="text-align: center; padding: 60px 20px; display: none;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#1877f2" stroke-width="1.5" style="margin-bottom: 15px;">
                    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                </svg>
                <h3 style="margin-bottom: 10px; color: #333;">Connect to Facebook</h3>
                <p style="color: #666; margin-bottom: 20px;">Login to Facebook to view your live campaigns and performance metrics.</p>
                <button onclick="loginToFacebook()" class="btn btn-primary" style="background: #1877f2; padding: 12px 24px;">
                    Connect Facebook Account
                </button>
            </div>

            <!-- Campaigns Table -->
            <div id="liveCampaignsTableContainer" class="table-container" style="margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 25%;">Campaign Name</th>
                            <th style="width: 8%;">Status</th>
                            <th style="width: 10%;">Spend</th>
                            <th style="width: 10%;">Impressions</th>
                            <th style="width: 8%;">Clicks</th>
                            <th style="width: 7%;">CTR</th>
                            <th style="width: 8%;">CPC</th>
                            <th style="width: 10%;">Conversions</th>
                            <th style="width: 8%;">ROAS</th>
                            <th style="width: 6%;">Source</th>
                        </tr>
                    </thead>
                    <tbody id="liveCampaignsBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 40px; color: #999;">
                                Click "Refresh" to load campaigns from Facebook
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Summary Cards -->
            <div id="campaignsSummary" style="display: none; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Spend</div>
                        <div id="summarySpend" style="font-size: 24px; font-weight: 600; color: #333;">$0.00</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Impressions</div>
                        <div id="summaryImpressions" style="font-size: 24px; font-weight: 600; color: #333;">0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Clicks</div>
                        <div id="summaryClicks" style="font-size: 24px; font-weight: 600; color: #333;">0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Conversions</div>
                        <div id="summaryConversions" style="font-size: 24px; font-weight: 600; color: #333;">0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Avg. ROAS</div>
                        <div id="summaryROAS" style="font-size: 24px; font-weight: 600; color: #28a745;">0.00x</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Library Tab -->
    <div id="library-tab" class="tab-content">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2 style="margin: 0; font-size: 20px;">Image Library</h2>
                    <span id="libraryCount" style="color: #666; font-size: 14px;">(0 images)</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="libraryFilter" onchange="renderLibrary()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="all">All Images</option>
                        <option value="favorites">Favorites Only</option>
                    </select>
                    <select id="librarySort" onchange="renderLibrary()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="square">Square (1:1)</option>
                        <option value="landscape">Landscape (Wide)</option>
                        <option value="portrait">Portrait (Tall)</option>
                    </select>
                    <label class="btn btn-primary" style="cursor: pointer; margin: 0; display: flex; align-items: center; gap: 6px; padding: 10px 16px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Add Images
                        <input type="file" id="libraryUploadInput" multiple accept="image/*" style="display: none;" onchange="handleLibraryUpload(event)">
                    </label>
                    <button class="btn btn-secondary" onclick="clearLibrary()">Clear All</button>
                </div>
            </div>
            <div id="libraryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #999;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 15px; opacity: 0.5;">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
                    </svg>
                    <p style="font-size: 16px; margin-bottom: 5px;">No images yet</p>
                    <p style="font-size: 13px;">Upload images or generate in Campaigns</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Library Selection Popup Modal -->
    <div id="libraryPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; font-size: 18px;">Select from Library</h3>
                    <p style="margin: 5px 0 0; font-size: 13px; color: #666;">Click images to select, then click "Use Selected"</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="libraryPopupCount" style="color: #666; font-size: 13px;">0 selected</span>
                    <button onclick="closeLibraryPopup()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; line-height: 1;">&times;</button>
                </div>
            </div>
            <div id="libraryPopupGrid" style="flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                <!-- Images will be rendered here -->
            </div>
            <div style="padding: 15px 25px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa;">
                <button class="btn btn-secondary" onclick="closeLibraryPopup()">Cancel</button>
                <button class="btn btn-primary" onclick="useSelectedLibraryImages()">Use Selected</button>
            </div>
        </div>
    </div>

    <script>
        // Global data
        let storefronts = [];
        let lists = [];
        let products = [];
        let selectedLists = new Set();
        let selectedProducts = new Set();
        let currentStorefrontPage = 1;
        let currentListPage = 1;
        let currentProductPage = 1;
        const pageSize = 50;

        // Sort state
        let storefrontSort = { column: 'totalListLikes', direction: 'desc' };
        let listSort = { column: 'likes', direction: 'desc' };
        let productSort = { column: 'title', direction: 'asc' };

        // Image Library
        let imageLibrary = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
            loadImageLibrary();
            loadUploadedListIds();
        });

        // ========================================
        // LIVE CAMPAIGNS FUNCTIONS
        // ========================================

        let liveCampaigns = [];
        let uploadedListIds = new Set(); // Track lists uploaded to FB campaigns

        // Load uploaded list IDs from localStorage
        function loadUploadedListIds() {
            try {
                const saved = localStorage.getItem('uploadedListIds');
                uploadedListIds = saved ? new Set(JSON.parse(saved)) : new Set();
            } catch (e) {
                uploadedListIds = new Set();
            }
        }

        // Save uploaded list ID
        function saveUploadedListId(listId) {
            uploadedListIds.add(listId);
            localStorage.setItem('uploadedListIds', JSON.stringify([...uploadedListIds]));
        }

        // Load live campaigns from Facebook
        async function loadLiveCampaigns() {
            if (!fbAccessToken) {
                document.getElementById('fbLoginRequiredCampaigns').style.display = 'block';
                document.getElementById('liveCampaignsTableContainer').style.display = 'none';
                document.getElementById('campaignsSummary').style.display = 'none';
                return;
            }

            document.getElementById('fbLoginRequiredCampaigns').style.display = 'none';
            document.getElementById('liveCampaignsTableContainer').style.display = 'block';

            const tbody = document.getElementById('liveCampaignsBody');
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;"><span style="color: #667eea;">⏳ Loading campaigns...</span></td></tr>';

            const dateRange = document.getElementById('campaignDateRange')?.value || 'last_30d';
            const timeRange = getDateRangeParams(dateRange);

            try {
                // Fetch campaigns with insights
                const response = await new Promise((resolve, reject) => {
                    FB.api(
                        `/${window.FB_AD_ACCOUNT_ID}/campaigns`,
                        'GET',
                        {
                            access_token: fbAccessToken,
                            fields: 'id,name,status,objective,created_time',
                            limit: 100
                        },
                        function(response) {
                            if (response.error) reject(response.error);
                            else resolve(response);
                        }
                    );
                });

                if (!response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">No campaigns found</td></tr>';
                    document.getElementById('liveCampaignsCount').textContent = '(0 campaigns)';
                    return;
                }

                // Fetch insights for each campaign
                liveCampaigns = [];
                for (const campaign of response.data) {
                    const insights = await fetchCampaignInsights(campaign.id, timeRange);
                    liveCampaigns.push({
                        ...campaign,
                        insights: insights || {}
                    });
                }

                renderLiveCampaigns();
                updateCampaignsSummary();

            } catch (error) {
                console.error('Error loading campaigns:', error);
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px; color: #dc3545;">Error loading campaigns: ${error.message}</td></tr>`;
            }
        }

        // Fetch insights for a single campaign
        async function fetchCampaignInsights(campaignId, timeRange) {
            return new Promise((resolve) => {
                FB.api(
                    `/${campaignId}/insights`,
                    'GET',
                    {
                        access_token: fbAccessToken,
                        fields: 'spend,impressions,clicks,ctr,cpc,actions,action_values,purchase_roas',
                        time_range: timeRange
                    },
                    function(response) {
                        if (response.data && response.data[0]) {
                            resolve(response.data[0]);
                        } else {
                            resolve(null);
                        }
                    }
                );
            });
        }

        // Get date range parameters for Facebook API
        function getDateRangeParams(range) {
            const now = new Date();
            let since, until = now.toISOString().split('T')[0];

            switch (range) {
                case 'last_7d':
                    since = new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'last_30d':
                    since = new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'this_month':
                    since = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    break;
                case 'lifetime':
                    since = '2020-01-01';
                    break;
                default:
                    since = new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            }

            return { since, until };
        }

        // Render live campaigns table
        function renderLiveCampaigns() {
            const tbody = document.getElementById('liveCampaignsBody');
            const statusFilter = document.getElementById('campaignStatusFilter')?.value || 'all';

            let filtered = liveCampaigns;
            if (statusFilter !== 'all') {
                filtered = liveCampaigns.filter(c => c.status === statusFilter);
            }

            document.getElementById('liveCampaignsCount').textContent = `(${filtered.length} campaign${filtered.length !== 1 ? 's' : ''})`;

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">No campaigns match the filter</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(campaign => {
                const insights = campaign.insights || {};
                const spend = parseFloat(insights.spend || 0);
                const impressions = parseInt(insights.impressions || 0);
                const clicks = parseInt(insights.clicks || 0);
                const ctr = parseFloat(insights.ctr || 0);
                const cpc = parseFloat(insights.cpc || 0);

                // Get conversions (purchases)
                const conversions = insights.actions?.find(a => a.action_type === 'purchase')?.value ||
                                   insights.actions?.find(a => a.action_type === 'omni_purchase')?.value || 0;

                // Get ROAS
                const roas = insights.purchase_roas?.[0]?.value ||
                            (insights.action_values?.find(a => a.action_type === 'purchase')?.value / spend) || 0;

                // Check if this is an auto-list campaign (created through our tool)
                const isAutoList = campaign.name.includes('[Auto-List]') || uploadedListIds.has(campaign.id);
                const sourceLabel = isAutoList
                    ? '<span style="background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 10px; font-size: 10px;">auto-list</span>'
                    : '<span style="background: #e9ecef; color: #6c757d; padding: 2px 8px; border-radius: 10px; font-size: 10px;">manual</span>';

                const statusColor = campaign.status === 'ACTIVE' ? '#28a745' : campaign.status === 'PAUSED' ? '#ffc107' : '#6c757d';
                const statusBg = campaign.status === 'ACTIVE' ? '#d4edda' : campaign.status === 'PAUSED' ? '#fff3cd' : '#e9ecef';

                return `
                    <tr>
                        <td style="font-weight: 500;">${campaign.name}</td>
                        <td><span style="background: ${statusBg}; color: ${statusColor}; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${campaign.status}</span></td>
                        <td>$${spend.toFixed(2)}</td>
                        <td>${formatNumber(impressions)}</td>
                        <td>${formatNumber(clicks)}</td>
                        <td>${ctr.toFixed(2)}%</td>
                        <td>$${cpc.toFixed(2)}</td>
                        <td>${conversions}</td>
                        <td style="font-weight: 600; color: ${roas >= 1 ? '#28a745' : '#dc3545'};">${parseFloat(roas).toFixed(2)}x</td>
                        <td>${sourceLabel}</td>
                    </tr>
                `;
            }).join('');
        }

        // Filter live campaigns
        function filterLiveCampaigns() {
            renderLiveCampaigns();
        }

        // Update campaigns summary
        function updateCampaignsSummary() {
            const summary = document.getElementById('campaignsSummary');
            if (liveCampaigns.length === 0) {
                summary.style.display = 'none';
                return;
            }

            summary.style.display = 'block';

            let totalSpend = 0, totalImpressions = 0, totalClicks = 0, totalConversions = 0, totalRevenue = 0;

            liveCampaigns.forEach(campaign => {
                const insights = campaign.insights || {};
                totalSpend += parseFloat(insights.spend || 0);
                totalImpressions += parseInt(insights.impressions || 0);
                totalClicks += parseInt(insights.clicks || 0);

                const conversions = insights.actions?.find(a => a.action_type === 'purchase')?.value ||
                                   insights.actions?.find(a => a.action_type === 'omni_purchase')?.value || 0;
                totalConversions += parseInt(conversions);

                const revenue = insights.action_values?.find(a => a.action_type === 'purchase')?.value || 0;
                totalRevenue += parseFloat(revenue);
            });

            const avgROAS = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;

            document.getElementById('summarySpend').textContent = '$' + totalSpend.toFixed(2);
            document.getElementById('summaryImpressions').textContent = formatNumber(totalImpressions);
            document.getElementById('summaryClicks').textContent = formatNumber(totalClicks);
            document.getElementById('summaryConversions').textContent = totalConversions;
            document.getElementById('summaryROAS').textContent = avgROAS.toFixed(2) + 'x';
            document.getElementById('summaryROAS').style.color = avgROAS >= 1 ? '#28a745' : '#dc3545';
        }

        // ========================================
        // IMAGE LIBRARY FUNCTIONS
        // ========================================

        function loadImageLibrary() {
            try {
                const saved = localStorage.getItem('imageLibrary');
                imageLibrary = saved ? JSON.parse(saved) : [];
                renderLibrary();
            } catch (e) {
                console.error('Error loading image library:', e);
                imageLibrary = [];
            }
        }

        function saveImageLibrary() {
            try {
                localStorage.setItem('imageLibrary', JSON.stringify(imageLibrary));
            } catch (e) {
                console.error('Error saving image library:', e);
                // If localStorage is full, remove oldest non-favorite images
                if (e.name === 'QuotaExceededError') {
                    const nonFavorites = imageLibrary.filter(img => !img.favorite);
                    if (nonFavorites.length > 0) {
                        const oldest = nonFavorites.sort((a, b) => a.createdAt - b.createdAt)[0];
                        deleteFromLibrary(oldest.id, false);
                        saveImageLibrary();
                    }
                }
            }
        }

        function addToLibrary(imageData, metadata = {}) {
            const image = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                data: imageData,
                createdAt: Date.now(),
                favorite: false,
                listName: metadata.listName || 'Unknown',
                size: metadata.size || 'Unknown',
                prompt: metadata.prompt || '',
                ratio: metadata.ratio || null,
                width: metadata.width || null,
                height: metadata.height || null
            };

            // Detect ratio if not provided
            if (!image.ratio) {
                const img = new Image();
                img.onload = function() {
                    image.width = img.naturalWidth;
                    image.height = img.naturalHeight;
                    image.ratio = img.naturalWidth / img.naturalHeight;
                    saveImageLibrary();
                    renderLibrary();
                };
                img.src = imageData;
            }

            imageLibrary.unshift(image);
            saveImageLibrary();
            renderLibrary();
            return image.id;
        }

        function toggleFavorite(imageId) {
            const image = imageLibrary.find(img => img.id === imageId);
            if (image) {
                image.favorite = !image.favorite;
                saveImageLibrary();
                renderLibrary();
            }
        }

        function deleteFromLibrary(imageId, confirm = true) {
            if (confirm && !window.confirm('Delete this image?')) return;
            imageLibrary = imageLibrary.filter(img => img.id !== imageId);
            saveImageLibrary();
            renderLibrary();
        }

        function clearLibrary() {
            if (!window.confirm('Delete all images from library? Favorites will also be removed.')) return;
            imageLibrary = [];
            saveImageLibrary();
            renderLibrary();
        }

        // Library popup selection state
        let libraryPopupSelection = new Set();

        function openLibraryPopup() {
            libraryPopupSelection.clear();
            const popup = document.getElementById('libraryPopup');
            popup.style.display = 'flex';
            renderLibraryPopup();
            updateLibraryPopupCount();
        }

        function closeLibraryPopup() {
            document.getElementById('libraryPopup').style.display = 'none';
            libraryPopupSelection.clear();
        }

        function renderLibraryPopup() {
            const grid = document.getElementById('libraryPopupGrid');

            if (imageLibrary.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 10px; opacity: 0.5;">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
                        </svg>
                        <p style="margin: 0;">No images in library yet</p>
                        <p style="font-size: 12px; margin-top: 5px;">Generate images in Campaigns or upload manually</p>
                    </div>
                `;
                return;
            }

            // Sort by newest first
            const sorted = [...imageLibrary].sort((a, b) => b.createdAt - a.createdAt);

            grid.innerHTML = sorted.map(img => {
                const isSelected = libraryPopupSelection.has(img.id);
                const date = new Date(img.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                // Determine aspect ratio label
                const ratio = img.ratio || 1;
                let ratioLabel = '1:1';
                if (ratio > 1.5) ratioLabel = '16:9';
                else if (ratio > 1.2) ratioLabel = '4:3';
                else if (ratio < 0.7) ratioLabel = '9:16';
                else if (ratio < 0.9) ratioLabel = '3:4';
                const aspectRatio = img.ratio ? img.ratio.toFixed(2) : '1';

                return `
                    <div onclick="toggleLibraryPopupSelect('${img.id}')"
                         style="cursor: pointer; border-radius: 8px; overflow: hidden; border: 3px solid ${isSelected ? '#667eea' : 'transparent'}; transition: all 0.2s; ${isSelected ? 'box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);' : ''}">
                        <div style="position: relative; max-height: 180px; overflow: hidden;">
                            <img src="${img.data}" style="width: 100%; aspect-ratio: ${aspectRatio}; object-fit: contain; display: block; background: #f5f5f5; max-height: 180px;">
                            ${isSelected ? '<div style="position: absolute; top: 8px; right: 8px; background: #667eea; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>' : ''}
                            ${img.favorite ? '<div style="position: absolute; top: 8px; left: 8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="#f59e0b" stroke="#f59e0b" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>' : ''}
                            <div style="position: absolute; bottom: 4px; left: 4px; background: rgba(0,0,0,0.6); color: white; padding: 1px 6px; border-radius: 3px; font-size: 9px;">${ratioLabel}</div>
                        </div>
                        <div style="padding: 8px; background: ${isSelected ? '#f0f4ff' : '#f8f9fa'};">
                            <div style="font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${img.listName}</div>
                            <div style="font-size: 10px; color: #999;">${date}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleLibraryPopupSelect(imageId) {
            if (libraryPopupSelection.has(imageId)) {
                libraryPopupSelection.delete(imageId);
            } else {
                libraryPopupSelection.add(imageId);
            }
            renderLibraryPopup();
            updateLibraryPopupCount();
        }

        function updateLibraryPopupCount() {
            const countEl = document.getElementById('libraryPopupCount');
            if (countEl) {
                countEl.textContent = `${libraryPopupSelection.size} selected`;
            }
        }

        function useSelectedLibraryImages() {
            if (libraryPopupSelection.size === 0) {
                alert('Please select at least one image');
                return;
            }

            const grid = document.getElementById('draftImagesGrid');
            const cards = grid.querySelectorAll('.creative-card');

            // Find selected images data
            const selectedImages = [];
            libraryPopupSelection.forEach(id => {
                const img = imageLibrary.find(i => i.id === id);
                if (img) selectedImages.push(img);
            });

            // Fill empty slots or replace placeholder slots
            let slotIndex = 0;
            selectedImages.forEach(img => {
                if (slotIndex < cards.length) {
                    const card = cards[slotIndex];
                    const imageDiv = card.querySelector('div');
                    if (imageDiv) {
                        imageDiv.style.height = '120px';
                        imageDiv.style.background = 'none';
                        imageDiv.style.padding = '0';
                        imageDiv.innerHTML = `<img src="${img.data}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    }
                    // Select this card
                    card.style.borderColor = '#667eea';
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                    slotIndex++;
                }
            });

            closeLibraryPopup();
        }

        function handleLibraryUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    addToLibrary(e.target.result, {
                        listName: 'Manual Upload',
                        size: 'Original',
                        prompt: ''
                    });
                };
                reader.readAsDataURL(file);
            });

            // Clear the input so the same file can be uploaded again
            event.target.value = '';
        }

        function renderLibrary() {
            const grid = document.getElementById('libraryGrid');
            const countEl = document.getElementById('libraryCount');
            const filter = document.getElementById('libraryFilter')?.value || 'all';
            const sort = document.getElementById('librarySort')?.value || 'newest';

            let filtered = [...imageLibrary];

            // Apply filter
            if (filter === 'favorites') {
                filtered = filtered.filter(img => img.favorite);
            }

            // Apply sort
            if (sort === 'newest') {
                filtered.sort((a, b) => b.createdAt - a.createdAt);
            } else if (sort === 'oldest') {
                filtered.sort((a, b) => a.createdAt - b.createdAt);
            } else if (sort === 'square') {
                // Show square images first (ratio close to 1)
                filtered.sort((a, b) => {
                    const ratioA = a.ratio || 1;
                    const ratioB = b.ratio || 1;
                    return Math.abs(ratioA - 1) - Math.abs(ratioB - 1);
                });
            } else if (sort === 'landscape') {
                // Show landscape (wide) images first (ratio > 1)
                filtered.sort((a, b) => {
                    const ratioA = a.ratio || 1;
                    const ratioB = b.ratio || 1;
                    return ratioB - ratioA;
                });
            } else if (sort === 'portrait') {
                // Show portrait (tall) images first (ratio < 1)
                filtered.sort((a, b) => {
                    const ratioA = a.ratio || 1;
                    const ratioB = b.ratio || 1;
                    return ratioA - ratioB;
                });
            }

            // Update count
            if (countEl) {
                countEl.textContent = `(${filtered.length} image${filtered.length !== 1 ? 's' : ''})`;
            }

            if (!grid) return;

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #999;">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 15px; opacity: 0.5;">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
                        </svg>
                        <p style="font-size: 16px; margin-bottom: 5px;">${filter === 'favorites' ? 'No favorite images' : 'No images yet'}</p>
                        <p style="font-size: 13px;">${filter === 'favorites' ? 'Star images to add them to favorites' : 'Upload images or generate in Campaigns'}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(img => {
                const date = new Date(img.createdAt).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                // Determine aspect ratio label
                const ratio = img.ratio || 1;
                let ratioLabel = '1:1';
                if (ratio > 1.5) ratioLabel = '16:9';
                else if (ratio > 1.2) ratioLabel = '4:3';
                else if (ratio < 0.7) ratioLabel = '9:16';
                else if (ratio < 0.9) ratioLabel = '3:4';

                // Calculate aspect-ratio CSS (default to 1 if not available)
                const aspectRatio = img.ratio ? img.ratio.toFixed(2) : '1';

                return `
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="position: relative; max-height: 280px; overflow: hidden;">
                            <img src="${img.data}" style="width: 100%; aspect-ratio: ${aspectRatio}; object-fit: contain; display: block; background: #f5f5f5; max-height: 280px;">
                            <button onclick="toggleFavorite('${img.id}')" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                ${img.favorite ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="#f59e0b" stroke="#f59e0b" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>' : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>'}
                            </button>
                            <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;">${ratioLabel}</div>
                        </div>
                        <div style="padding: 12px;">
                            <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${img.listName}</div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">${date}</div>
                            <div style="display: flex; gap: 8px;">
                                <a href="${img.data}" download="image-${img.id}.png" class="btn btn-secondary" style="flex: 1; padding: 6px; font-size: 11px; justify-content: center;">Download</a>
                                <button onclick="deleteFromLibrary('${img.id}')" class="btn" style="padding: 6px 10px; font-size: 11px; background: #fee2e2; color: #dc2626; border: none;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Global stats from JSON
        let globalStats = {};

        // Supabase configuration - set these for your project
        const SUPABASE_URL = window.SUPABASE_URL || '';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
        let supabaseClient = null;

        // Initialize Supabase client
        function initSupabase() {
            if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return true;
            }
            return false;
        }

        // Load data from Supabase
        async function loadFromSupabase() {
            // Load storefronts
            const { data: storefrontsData, error: storefrontsError } = await supabaseClient
                .from('storefronts')
                .select('*')
                .order('total_list_likes', { ascending: false });

            if (storefrontsError) throw storefrontsError;
            storefronts = storefrontsData.map(s => ({
                id: s.id,
                url: s.url,
                username: s.username,
                name: s.name,
                bio: s.bio,
                image: s.image,
                isTop: s.is_top,
                likes: s.likes,
                lists: s.lists,
                totalListLikes: s.total_list_likes,
                marketplace: s.marketplace
            }));

            // Load lists
            const { data: listsData, error: listsError } = await supabaseClient
                .from('lists')
                .select('*')
                .order('likes', { ascending: false });

            if (listsError) throw listsError;
            lists = listsData.map(l => ({
                id: l.id,
                storefront: l.storefront_id,
                name: l.name,
                url: l.url,
                likes: l.likes,
                products: l.products
            }));

            // Load products
            const { data: productsData, error: productsError } = await supabaseClient
                .from('products')
                .select('*')
                .order('position', { ascending: true });

            if (productsError) throw productsError;
            products = productsData.map(p => ({
                asin: p.asin,
                title: p.title,
                url: p.url,
                price: p.price,
                currency: p.currency,
                image: p.image,
                listId: p.list_id,
                storefront: p.storefront_id,
                position: p.position
            }));

            // Load stats
            const { data: statsData } = await supabaseClient
                .from('stats')
                .select('*')
                .single();

            if (statsData) {
                globalStats = {
                    total: statsData.total_storefronts,
                    topCreators: statsData.top_creators,
                    totalLists: statsData.total_lists,
                    totalLikes: statsData.total_likes,
                    totalProducts: statsData.total_products,
                    lastUpdated: statsData.last_updated
                };
            } else {
                // Calculate from data if stats table is empty
                globalStats = {
                    total: storefronts.length,
                    topCreators: storefronts.filter(s => s.isTop).length,
                    totalLists: lists.length,
                    totalLikes: storefronts.reduce((sum, s) => sum + (s.totalListLikes || 0), 0),
                    totalProducts: products.length
                };
            }
        }

        // Load data from JSON files
        async function loadFromJSON() {
            const basePath = window.location.pathname.includes('/ui/') ? './data/' : '/ui/data/';

            // Load storefronts
            const storefrontsResponse = await fetch(basePath + 'storefronts.json');
            const storefrontsJSON = await storefrontsResponse.json();
            storefronts = storefrontsJSON.data;
            globalStats = storefrontsJSON.stats;

            // Load lists
            const listsResponse = await fetch(basePath + 'lists.json');
            const listsJSON = await listsResponse.json();
            lists = listsJSON.data;

            // Load products (if available)
            try {
                const productsResponse = await fetch(basePath + 'products.json');
                if (productsResponse.ok) {
                    const productsJSON = await productsResponse.json();
                    products = productsJSON.data || [];
                }
            } catch (e) {
                console.log('No products data available');
                products = [];
            }
        }

        // Main data loading function
        async function loadData() {
            try {
                // Try Supabase first
                if (initSupabase()) {
                    console.log('Loading data from Supabase...');
                    console.log('Supabase URL:', SUPABASE_URL);
                    try {
                        await loadFromSupabase();
                        console.log('Data loaded from Supabase');
                    } catch (supabaseError) {
                        console.error('Supabase error, falling back to JSON:', supabaseError);
                        await loadFromJSON();
                        console.log('Data loaded from JSON (fallback)');
                    }
                } else {
                    // Fallback to JSON files
                    console.log('Supabase not configured, loading from JSON files...');
                    await loadFromJSON();
                    console.log('Data loaded from JSON');
                }

                // Update stats from pre-calculated values
                updateStats();

                // Populate filter dropdowns
                populateStorefrontFilter();
                populateProductFilters();

                // Render tables
                renderStorefronts();
                renderLists();
                renderProducts();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('storefrontsBody').innerHTML =
                    '<tr><td colspan="8" class="empty-state">Error loading data: ' + error.message + '</td></tr>';
            }
        }

        // Update stats from pre-calculated JSON stats
        function updateStats() {
            document.getElementById('totalStorefronts').textContent = globalStats.total || storefronts.length;
            document.getElementById('totalLists').textContent = (globalStats.totalLists || lists.length).toLocaleString();
            document.getElementById('totalLikes').textContent = formatNumber(globalStats.totalLikes || 0);
            document.getElementById('topCreators').textContent = globalStats.topCreators || storefronts.filter(s => s.isTop).length;
            document.getElementById('totalProducts').textContent = formatNumber(globalStats.totalProducts || products.length);
        }

        // Format number
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        // Render storefronts table
        function renderStorefronts() {
            let filtered = [...storefronts];

            // Apply search
            const search = document.getElementById('storefrontSearch').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(s =>
                    s.username.toLowerCase().includes(search) ||
                    (s.name || '').toLowerCase().includes(search)
                );
            }

            // Apply filter
            const activeFilter = document.querySelector('.filter-chip.active')?.dataset.filter;
            if (activeFilter === 'top') {
                filtered = filtered.filter(s => s.isTop);
            } else if (activeFilter === 'high-likes') {
                filtered = filtered.filter(s => s.likes >= 100);
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[storefrontSort.column];
                let bVal = b[storefrontSort.column];

                // Handle numeric columns
                if (['likes', 'lists', 'totalListLikes'].includes(storefrontSort.column)) {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                if (aVal < bVal) return storefrontSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return storefrontSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Paginate
            const start = (currentStorefrontPage - 1) * pageSize;
            const paginated = filtered.slice(start, start + pageSize);

            // Render
            const tbody = document.getElementById('storefrontsBody');
            if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No storefronts found</td></tr>';
            } else {
                tbody.innerHTML = paginated.map(s => `
                    <tr>
                        <td class="checkbox-cell"><input type="checkbox" data-id="${s.id}"></td>
                        <td><a href="${s.url}" target="_blank" class="creator-link">${s.username}</a></td>
                        <td class="truncate">${s.name || '-'}</td>
                        <td>${s.isTop ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">No</span>'}</td>
                        <td class="likes-count">${formatNumber(s.likes || 0)}</td>
                        <td>${s.lists || 0}</td>
                        <td class="likes-count">${formatNumber(s.totalListLikes || 0)}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="viewLists('${s.id}')">
                                View Lists
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Update pagination
            renderPagination('storefronts', filtered.length, currentStorefrontPage);
        }

        // Render lists table
        function renderLists() {
            let filtered = [...lists];

            // Apply search
            const search = document.getElementById('listSearch').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(l =>
                    l.name.toLowerCase().includes(search) ||
                    l.storefront.toLowerCase().includes(search)
                );
            }

            // Apply storefront filter
            const storefrontFilter = document.getElementById('storefrontFilter').value;
            if (storefrontFilter) {
                filtered = filtered.filter(l => l.storefront === storefrontFilter);
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[listSort.column];
                let bVal = b[listSort.column];

                if (['likes', 'products'].includes(listSort.column)) {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                if (listSort.column === 'lastScraped') {
                    aVal = a.lastScraped ? new Date(a.lastScraped).getTime() : 0;
                    bVal = b.lastScraped ? new Date(b.lastScraped).getTime() : 0;
                }

                if (aVal < bVal) return listSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return listSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Paginate
            const start = (currentListPage - 1) * pageSize;
            const paginated = filtered.slice(start, start + pageSize);

            // Render
            const tbody = document.getElementById('listsBody');
            if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No lists found</td></tr>';
            } else {
                tbody.innerHTML = paginated.map(l => {
                    // Check if list was uploaded to FB
                    const isUploaded = uploadedListIds.has(l.id);
                    // Check if list is new (less than 3 days old)
                    const createdDate = l.created_at ? new Date(l.created_at) : null;
                    const isNew = createdDate && (Date.now() - createdDate.getTime()) < 3 * 24 * 60 * 60 * 1000;

                    const uploadedBadge = isUploaded ? '<span style="background: #cce5ff; color: #004085; padding: 1px 6px; border-radius: 8px; font-size: 9px; margin-left: 6px;">uploaded</span>' : '';
                    const newBadge = isNew ? '<span style="background: #d4edda; color: #155724; padding: 1px 6px; border-radius: 8px; font-size: 9px; margin-left: 6px;">new</span>' : '';

                    // Format last scraped date
                    let lastScrapedDisplay = '-';
                    if (l.lastScraped) {
                        const scrapedDate = new Date(l.lastScraped);
                        const now = new Date();
                        const diffMs = now - scrapedDate;
                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                        if (diffHours < 1) {
                            lastScrapedDisplay = 'Just now';
                        } else if (diffHours < 24) {
                            lastScrapedDisplay = diffHours + 'h ago';
                        } else if (diffDays < 7) {
                            lastScrapedDisplay = diffDays + 'd ago';
                        } else {
                            lastScrapedDisplay = scrapedDate.toLocaleDateString();
                        }
                    }

                    return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" data-id="${l.id}" ${selectedLists.has(l.id) ? 'checked' : ''}>
                        </td>
                        <td><a href="https://www.amazon.com/shop/${l.storefront}" target="_blank" class="creator-link">${l.storefront}</a></td>
                        <td class="truncate" title="${l.name}">${l.name}${uploadedBadge}${newBadge}</td>
                        <td class="likes-count">${formatNumber(l.likes || 0)}</td>
                        <td>${l.products || 0}</td>
                        <td style="font-size: 12px; color: #666;">${lastScrapedDisplay}</td>
                        <td><a href="${l.url}" target="_blank" class="creator-link">Open</a></td>
                        <td style="white-space: nowrap;">
                            <button class="btn" style="padding: 5px 8px; font-size: 12px; background: #f0f0f0; border: 1px solid #ddd;" onclick="updateSingleList('${l.id}')" title="Update list data">
                                🔄
                            </button>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="addToExport('${l.id}')">
                                Export
                            </button>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="openDraft('${l.id}', '${l.storefront}')">
                                Duplicate
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            // Update pagination
            renderPagination('lists', filtered.length, currentListPage);
        }

        // Render products table
        function renderProducts() {
            let filtered = [...products];

            // Apply search
            const search = document.getElementById('productSearch')?.value?.toLowerCase() || '';
            if (search) {
                filtered = filtered.filter(p =>
                    (p.asin || '').toLowerCase().includes(search) ||
                    (p.title || '').toLowerCase().includes(search)
                );
            }

            // Apply storefront filter
            const storefrontFilter = document.getElementById('productStorefrontFilter')?.value || '';
            if (storefrontFilter) {
                filtered = filtered.filter(p => p.storefront === storefrontFilter);
            }

            // Apply list filter
            const listFilter = document.getElementById('productListFilter')?.value || '';
            if (listFilter) {
                filtered = filtered.filter(p => p.listId === listFilter);
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[productSort.column];
                let bVal = b[productSort.column];

                if (productSort.column === 'price') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return productSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return productSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Paginate
            const start = (currentProductPage - 1) * pageSize;
            const paginated = filtered.slice(start, start + pageSize);

            // Render
            const tbody = document.getElementById('productsBody');
            if (!tbody) return;

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No products scraped yet. Run scraper with products enabled.</td></tr>';
            } else if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No products found matching filters</td></tr>';
            } else {
                tbody.innerHTML = paginated.map(p => {
                    const amazonUrl = `https://www.amazon.com/dp/${p.asin}`;
                    const priceDisplay = p.price ? `$${p.price.toFixed(2)}` : '-';
                    const titleShort = (p.title || '').substring(0, 60) + ((p.title || '').length > 60 ? '...' : '');
                    return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" data-asin="${p.asin}" ${selectedProducts.has(p.asin) ? 'checked' : ''}>
                        </td>
                        <td><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${p.asin}</code></td>
                        <td class="truncate" title="${(p.title || '').replace(/"/g, '&quot;')}">${titleShort}</td>
                        <td>${priceDisplay}</td>
                        <td><a href="https://www.amazon.com/shop/${p.storefront}" target="_blank" class="creator-link">${p.storefront}</a></td>
                        <td><a href="${amazonUrl}" target="_blank" class="creator-link">Open</a></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectProduct('${p.asin}')">
                                + Select
                            </button>
                        </td>
                    </tr>
                `}).join('');
            }

            // Update pagination
            renderPagination('products', filtered.length, currentProductPage);
        }

        // Render pagination
        function renderPagination(type, total, currentPage) {
            const totalPages = Math.ceil(total / pageSize);
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);

            document.getElementById(`${type}PaginationInfo`).textContent =
                `Showing ${total > 0 ? start : 0}-${end} of ${total}`;

            const container = document.getElementById(`${type}Pagination`);
            let html = '';

            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage('${type}', ${currentPage - 1})">←</button>`;

            for (let i = 1; i <= totalPages && i <= 5; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage('${type}', ${i})">${i}</button>`;
            }

            if (totalPages > 5) {
                html += `<span style="padding: 8px;">...</span>`;
                html += `<button class="pagination-btn" onclick="goToPage('${type}', ${totalPages})">${totalPages}</button>`;
            }

            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage('${type}', ${currentPage + 1})">→</button>`;

            container.innerHTML = html;
        }

        // Go to page
        function goToPage(type, page) {
            if (type === 'storefronts') {
                currentStorefrontPage = page;
                renderStorefronts();
            } else if (type === 'lists') {
                currentListPage = page;
                renderLists();
            } else if (type === 'products') {
                currentProductPage = page;
                renderProducts();
            }
        }

        // Populate storefront filter
        function populateStorefrontFilter() {
            const select = document.getElementById('storefrontFilter');

            // JSON already contains only successful storefronts
            const sortedStorefronts = [...storefronts]
                .sort((a, b) => (b.totalListLikes || 0) - (a.totalListLikes || 0));

            sortedStorefronts.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.username} (${formatNumber(s.totalListLikes || 0)} likes)`;
                select.appendChild(option);
            });
        }

        // Populate product filters
        function populateProductFilters() {
            const storefrontSelect = document.getElementById('productStorefrontFilter');
            const listSelect = document.getElementById('productListFilter');
            if (!storefrontSelect || !listSelect) return;

            // Get unique storefronts from products
            const productStorefronts = [...new Set(products.map(p => p.storefront))];
            productStorefronts.sort().forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                storefrontSelect.appendChild(option);
            });

            // Get unique lists from products
            const productLists = [...new Set(products.map(p => p.listId))];
            productLists.forEach(listId => {
                const list = lists.find(l => l.id === listId);
                const option = document.createElement('option');
                option.value = listId;
                option.textContent = list ? list.name : listId;
                listSelect.appendChild(option);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });

            // Search
            document.getElementById('storefrontSearch').addEventListener('input', () => {
                currentStorefrontPage = 1;
                renderStorefronts();
            });

            document.getElementById('listSearch').addEventListener('input', () => {
                currentListPage = 1;
                renderLists();
            });

            // Storefront filter
            document.getElementById('storefrontFilter').addEventListener('change', () => {
                currentListPage = 1;
                renderLists();
            });

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentStorefrontPage = 1;
                    renderStorefronts();
                });
            });

            // Sort headers
            document.querySelectorAll('#storefrontsTable th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (storefrontSort.column === column) {
                        storefrontSort.direction = storefrontSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        storefrontSort.column = column;
                        storefrontSort.direction = 'desc';
                    }
                    renderStorefronts();
                });
            });

            document.querySelectorAll('#listsTable th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (listSort.column === column) {
                        listSort.direction = listSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        listSort.column = column;
                        listSort.direction = 'desc';
                    }
                    renderLists();
                });
            });

            // List checkboxes
            document.getElementById('listsBody').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const listId = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedLists.add(listId);
                    } else {
                        selectedLists.delete(listId);
                    }
                    updateSelectedCount();
                }
            });

            // Product search and filters
            const productSearch = document.getElementById('productSearch');
            if (productSearch) {
                productSearch.addEventListener('input', () => {
                    currentProductPage = 1;
                    renderProducts();
                });
            }

            const productStorefrontFilter = document.getElementById('productStorefrontFilter');
            if (productStorefrontFilter) {
                productStorefrontFilter.addEventListener('change', () => {
                    currentProductPage = 1;
                    // Update list filter based on storefront
                    const listFilter = document.getElementById('productListFilter');
                    const storefrontId = productStorefrontFilter.value;
                    listFilter.innerHTML = '<option value="">All Lists</option>';
                    if (storefrontId) {
                        const storefrontLists = lists.filter(l => l.storefront === storefrontId);
                        storefrontLists.forEach(l => {
                            const option = document.createElement('option');
                            option.value = l.id;
                            option.textContent = l.name;
                            listFilter.appendChild(option);
                        });
                    }
                    renderProducts();
                });
            }

            const productListFilter = document.getElementById('productListFilter');
            if (productListFilter) {
                productListFilter.addEventListener('change', () => {
                    currentProductPage = 1;
                    renderProducts();
                });
            }

            // Products table sorting
            document.querySelectorAll('#productsTable th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (productSort.column === column) {
                        productSort.direction = productSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        productSort.column = column;
                        productSort.direction = 'asc';
                    }
                    renderProducts();
                });
            });

            // Product checkboxes
            const productsBody = document.getElementById('productsBody');
            if (productsBody) {
                productsBody.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const asin = e.target.dataset.asin;
                        if (asin) {
                            if (e.target.checked) {
                                selectedProducts.add(asin);
                            } else {
                                selectedProducts.delete(asin);
                            }
                            updateSelectedProductsCount();
                        }
                    }
                });
            }

            // Select all products checkbox
            const selectAllProducts = document.getElementById('selectAllProducts');
            if (selectAllProducts) {
                selectAllProducts.addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('#productsBody input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                        const asin = cb.dataset.asin;
                        if (asin) {
                            if (e.target.checked) {
                                selectedProducts.add(asin);
                            } else {
                                selectedProducts.delete(asin);
                            }
                        }
                    });
                    updateSelectedProductsCount();
                });
            }
        }

        // Update selected count
        function updateSelectedCount() {
            const countEl = document.getElementById('selectedListsCount');
            const exportBtn = document.getElementById('exportSelectedBtn');

            if (selectedLists.size > 0) {
                countEl.textContent = `${selectedLists.size} selected`;
                countEl.style.display = 'inline';
                exportBtn.style.display = 'flex';
            } else {
                countEl.style.display = 'none';
                exportBtn.style.display = 'none';
            }
        }

        // Update selected products count
        function updateSelectedProductsCount() {
            const countEl = document.getElementById('selectedProductsCount');
            const exportBtn = document.getElementById('exportSelectedProductsBtn');

            if (selectedProducts.size > 0) {
                countEl.textContent = `${selectedProducts.size} selected`;
                countEl.style.display = 'inline';
                exportBtn.style.display = 'flex';
            } else {
                countEl.style.display = 'none';
                exportBtn.style.display = 'none';
            }
        }

        // Select a product
        function selectProduct(asin) {
            selectedProducts.add(asin);
            updateSelectedProductsCount();
            renderProducts();
        }

        // Export selected products
        function exportSelectedProducts() {
            const selected = products.filter(p => selectedProducts.has(p.asin));
            exportProductsData(selected, 'selected-products');
        }

        // Export all products (filtered)
        function exportAllProducts() {
            let filtered = [...products];

            // Apply current filters
            const search = document.getElementById('productSearch')?.value?.toLowerCase() || '';
            if (search) {
                filtered = filtered.filter(p =>
                    (p.asin || '').toLowerCase().includes(search) ||
                    (p.title || '').toLowerCase().includes(search)
                );
            }

            const storefrontFilter = document.getElementById('productStorefrontFilter')?.value || '';
            if (storefrontFilter) {
                filtered = filtered.filter(p => p.storefront === storefrontFilter);
            }

            const listFilter = document.getElementById('productListFilter')?.value || '';
            if (listFilter) {
                filtered = filtered.filter(p => p.listId === listFilter);
            }

            exportProductsData(filtered, 'products-export');
        }

        // Export products data in selected format
        function exportProductsData(data, filename) {
            const format = document.getElementById('productExportFormat')?.value || 'csv';

            if (format === 'txt') {
                // ASINs only
                const text = data.map(p => p.asin).join('\n');
                download(text, `${filename}-asins.txt`, 'text/plain');
            } else if (format === 'json') {
                // Full JSON
                const exportData = data.map(p => ({
                    asin: p.asin,
                    title: p.title,
                    url: `https://www.amazon.com/dp/${p.asin}`,
                    price: p.price,
                    currency: p.currency || 'USD',
                    storefront: p.storefront,
                    listId: p.listId
                }));
                downloadJSON(exportData, `${filename}.json`);
            } else {
                // CSV
                const exportData = data.map(p => ({
                    asin: p.asin,
                    product_title: p.title,
                    amazon_url: `https://www.amazon.com/dp/${p.asin}`,
                    price: p.price || '',
                    currency: p.currency || 'USD',
                    storefront_id: p.storefront,
                    list_id: p.listId
                }));
                downloadCSV(exportData, `${filename}.csv`);
            }
        }

        // View lists modal
        function viewLists(storefrontId) {
            const storefront = storefronts.find(s => s.id === storefrontId);
            const storefrontLists = lists.filter(l => l.storefront === storefrontId)
                .sort((a, b) => (b.likes || 0) - (a.likes || 0));

            document.getElementById('modalStorefrontName').textContent = storefront?.username || storefrontId;

            const body = document.getElementById('modalListsBody');
            body.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>List Name</th>
                            <th>Likes</th>
                            <th>Products</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${storefrontLists.map(l => `
                            <tr>
                                <td><a href="${l.url}" target="_blank" class="creator-link">${l.name}</a></td>
                                <td class="likes-count">${formatNumber(l.likes || 0)}</td>
                                <td>${l.products || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('viewListsModal').classList.add('active');
            window.currentModalStorefront = storefrontId;
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ============================================
        // ADD STOREFRONTS MODAL FUNCTIONS
        // ============================================

        function openAddStorefrontsModal() {
            document.getElementById('addStorefrontsModal').classList.add('active');
            document.getElementById('storefrontUrlsInput').value = '';
            document.getElementById('urlsCount').textContent = '0 URLs detected';
            document.getElementById('googleSearchQuery').value = '';
            document.getElementById('googleResults').style.display = 'none';
            document.getElementById('googleScrapeStatus').style.display = 'none';
            switchAddTab('urls');
        }

        function switchAddTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.add-sf-tab').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.classList.toggle('active', isActive);
                btn.style.borderBottomColor = isActive ? '#667eea' : 'transparent';
                btn.style.color = isActive ? '#667eea' : '#666';
            });

            // Show/hide tab content
            document.getElementById('addTab-urls').style.display = tabName === 'urls' ? 'block' : 'none';
            document.getElementById('addTab-google').style.display = tabName === 'google' ? 'block' : 'none';
        }

        // Count URLs as user types
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('storefrontUrlsInput');
            if (urlInput) {
                urlInput.addEventListener('input', () => {
                    const urls = parseStorefrontUrls(urlInput.value);
                    document.getElementById('urlsCount').textContent = `${urls.length} URLs detected`;
                });
            }
        });

        function parseStorefrontUrls(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const urls = [];
            const usernameRegex = /amazon\.com\/shop\/([a-zA-Z0-9_-]+)/i;

            for (const line of lines) {
                const match = line.match(usernameRegex);
                if (match) {
                    urls.push({
                        url: line.includes('http') ? line : `https://www.amazon.com/shop/${match[1]}`,
                        username: match[1]
                    });
                }
            }
            return urls;
        }

        async function addStorefrontsFromUrls() {
            const urlInput = document.getElementById('storefrontUrlsInput');
            const parsed = parseStorefrontUrls(urlInput.value);

            if (parsed.length === 0) {
                alert('No valid Amazon storefront URLs detected. URLs should contain amazon.com/shop/username');
                return;
            }

            // Check for duplicates
            const existingUsernames = new Set(storefronts.map(s => s.username.toLowerCase()));
            const newStorefronts = parsed.filter(p => !existingUsernames.has(p.username.toLowerCase()));
            const duplicateCount = parsed.length - newStorefronts.length;

            if (newStorefronts.length === 0) {
                alert(`All ${parsed.length} storefronts already exist in the database.`);
                return;
            }

            const confirmMsg = duplicateCount > 0
                ? `Adding ${newStorefronts.length} new storefronts (${duplicateCount} duplicates skipped). Continue?`
                : `Adding ${newStorefronts.length} new storefronts. Continue?`;

            if (!confirm(confirmMsg)) return;

            // Add new storefronts to Supabase
            try {
                const toAdd = newStorefronts.map(sf => ({
                    id: sf.username,
                    username: sf.username,
                    url: sf.url,
                    name: sf.username,
                    bio: '',
                    image: '',
                    is_top: false,
                    likes: 0,
                    lists: 0,
                    total_list_likes: 0,
                    marketplace: 'US'
                }));

                const { data, error } = await supabaseClient
                    .from('storefronts')
                    .upsert(toAdd, { onConflict: 'id' });

                if (error) throw error;

                // Add to local array
                toAdd.forEach(sf => {
                    if (!storefronts.find(s => s.id === sf.id)) {
                        storefronts.push({
                            id: sf.id,
                            username: sf.username,
                            url: sf.url,
                            name: sf.name,
                            isTop: sf.is_top,
                            likes: sf.likes,
                            lists: sf.lists,
                            totalListLikes: sf.total_list_likes
                        });
                    }
                });

                renderStorefronts();
                closeModal('addStorefrontsModal');
                alert(`Successfully added ${newStorefronts.length} storefronts!`);

            } catch (err) {
                console.error('Error adding storefronts:', err);
                alert('Error adding storefronts: ' + err.message);
            }
        }

        function setGoogleSearch(query) {
            document.getElementById('googleSearchQuery').value = query;
        }

        async function scrapeGoogleStorefronts() {
            const query = document.getElementById('googleSearchQuery').value.trim();
            const count = parseInt(document.getElementById('googleSearchCount').value);

            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const statusEl = document.getElementById('googleScrapeStatus');
            const statusText = document.getElementById('googleScrapeText');
            const resultsEl = document.getElementById('googleResults');

            statusEl.style.display = 'block';
            statusText.textContent = 'Searching Google for storefronts...';
            resultsEl.style.display = 'none';

            // Simulate Google scraping (in production, this would call a backend API)
            // For demo purposes, we'll generate mock results
            await new Promise(r => setTimeout(r, 2000));

            // Mock results based on query
            const mockUsernames = [
                'fashionista2024', 'techreviewer', 'homechef_sarah', 'fitnessguru',
                'beautybynina', 'gadgetworld', 'outdooradventures', 'petlover_jane',
                'bookworm_reviews', 'gamingcentral', 'diymaster', 'travelwithme',
                'organickitchen', 'styleonbudget', 'parentingtips_mom'
            ];

            const results = [];
            const existingUsernames = new Set(storefronts.map(s => s.username.toLowerCase()));

            for (let i = 0; i < Math.min(count, mockUsernames.length); i++) {
                const username = mockUsernames[i];
                const isExisting = existingUsernames.has(username.toLowerCase());
                results.push({
                    username,
                    url: `https://www.amazon.com/shop/${username}`,
                    isExisting
                });
            }

            statusEl.style.display = 'none';
            resultsEl.style.display = 'block';
            resultsEl.innerHTML = `
                <div style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: 500;">
                    Found ${results.length} storefronts (${results.filter(r => r.isExisting).length} already in database)
                </div>
                ${results.map(r => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <a href="${r.url}" target="_blank" style="color: #667eea; text-decoration: none;">${r.username}</a>
                            ${r.isExisting ? '<span style="margin-left: 8px; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Existing</span>' : '<span style="margin-left: 8px; background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">New</span>'}
                        </div>
                        <input type="checkbox" class="google-result-checkbox" data-username="${r.username}" data-url="${r.url}" ${r.isExisting ? '' : 'checked'}>
                    </div>
                `).join('')}
                <div style="padding: 10px; display: flex; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="addSelectedGoogleResults()" style="padding: 8px 15px;">
                        Add Selected
                    </button>
                </div>
            `;
        }

        async function addSelectedGoogleResults() {
            const checkboxes = document.querySelectorAll('.google-result-checkbox:checked');
            const toAdd = Array.from(checkboxes).map(cb => ({
                username: cb.dataset.username,
                url: cb.dataset.url
            }));

            if (toAdd.length === 0) {
                alert('No storefronts selected');
                return;
            }

            // Add to textarea and use existing function
            document.getElementById('storefrontUrlsInput').value = toAdd.map(s => s.url).join('\n');
            switchAddTab('urls');
            addStorefrontsFromUrls();
        }

        // ============================================
        // UPDATE DATA FUNCTIONS
        // ============================================

        // Get selected storefront IDs from main table checkboxes
        function getSelectedStorefrontIds() {
            const checkboxes = document.querySelectorAll('#storefrontsBody input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.id);
        }

        // Main update function - uses checkboxes from storefronts table
        async function openUpdateDataModal() {
            const selectedIds = getSelectedStorefrontIds();

            if (selectedIds.length === 0) {
                const confirmAll = confirm('No storefronts selected. Update ALL storefronts?');
                if (!confirmAll) return;
            }

            const idsToUpdate = selectedIds.length > 0 ? selectedIds : storefronts.map(s => s.id);

            // Show progress modal
            document.getElementById('updateDataModal').classList.add('active');
            const progressText = document.getElementById('updateProgressText');
            const progressDetail = document.getElementById('updateProgressDetail');
            const progressBar = document.getElementById('updateProgressBar');

            let totalSteps = idsToUpdate.length * 3; // storefront + lists + products per storefront
            let currentStep = 0;

            for (let i = 0; i < idsToUpdate.length; i++) {
                const id = idsToUpdate[i];
                const sf = storefronts.find(s => s.id === id);
                if (!sf) continue;

                // Step 1: Update storefront data
                progressText.textContent = `Updating ${sf.username}...`;
                progressDetail.textContent = `Storefront ${i + 1} of ${idsToUpdate.length} - Fetching storefront data`;
                currentStep++;
                progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

                await new Promise(r => setTimeout(r, 300)); // Simulate API call

                // Mock update storefront data
                sf.likes = (sf.likes || 0) + Math.floor(Math.random() * 10);
                sf.totalListLikes = (sf.totalListLikes || 0) + Math.floor(Math.random() * 50);

                // Step 2: Update lists for this storefront
                progressDetail.textContent = `Storefront ${i + 1} of ${idsToUpdate.length} - Fetching lists`;
                currentStep++;
                progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

                await new Promise(r => setTimeout(r, 300));

                // Update lists for this storefront
                const storefrontLists = lists.filter(l => l.storefront === sf.username);
                for (const list of storefrontLists) {
                    list.likes = (list.likes || 0) + Math.floor(Math.random() * 5);
                    list.lastScraped = new Date().toISOString();
                }

                // Step 3: Update products
                progressDetail.textContent = `Storefront ${i + 1} of ${idsToUpdate.length} - Fetching products`;
                currentStep++;
                progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

                await new Promise(r => setTimeout(r, 300));

                // Update in Supabase
                try {
                    await supabaseClient
                        .from('storefronts')
                        .update({
                            likes: sf.likes,
                            total_list_likes: sf.totalListLikes
                        })
                        .eq('id', id);
                } catch (err) {
                    console.error('Error updating storefront:', err);
                }
            }

            progressBar.style.width = '100%';
            progressText.textContent = 'Update complete!';
            progressDetail.textContent = `Updated ${idsToUpdate.length} storefronts with their lists and products`;

            await new Promise(r => setTimeout(r, 1000));

            closeModal('updateDataModal');
            renderStorefronts();
            renderLists();
            alert(`Successfully updated ${idsToUpdate.length} storefronts!`);
        }

        // Update a single list and its products
        async function updateSingleList(listId) {
            const list = lists.find(l => l.id === listId);
            if (!list) return;

            // Show loading state on button
            const btn = document.querySelector(`button[onclick="updateSingleList('${listId}')"]`);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner" style="width: 12px; height: 12px; border-width: 2px;"></span>';
            }

            try {
                // Simulate API call to scrape list data
                await new Promise(r => setTimeout(r, 1000));

                // Mock update list data
                list.likes = (list.likes || 0) + Math.floor(Math.random() * 10);
                list.products = (list.products || 0) + Math.floor(Math.random() * 3);
                list.lastScraped = new Date().toISOString();

                // Mock description based on list name (in production, this would be scraped from the page)
                if (!list.description) {
                    const mockDescriptions = [
                        `Hand-picked selection of ${list.name.toLowerCase()} items curated by a top creator.`,
                        `My favorite ${list.name.toLowerCase()} finds - tested and loved!`,
                        `The best ${list.name.toLowerCase()} products I've discovered this season.`,
                        `Everything you need for ${list.name.toLowerCase()} - all in one place!`,
                        `Curated ${list.name.toLowerCase()} essentials for every budget.`
                    ];
                    list.description = mockDescriptions[Math.floor(Math.random() * mockDescriptions.length)];
                }

                // Update products in this list
                const listProducts = products.filter(p => p.listId === listId);
                for (const product of listProducts) {
                    // Mock update product data
                    product.price = product.price ? product.price * (1 + (Math.random() - 0.5) * 0.1) : null;
                }

                // Update in Supabase
                try {
                    await supabaseClient
                        .from('lists')
                        .update({
                            likes: list.likes,
                            products: list.products,
                            last_scraped: list.lastScraped,
                            description: list.description
                        })
                        .eq('id', listId);
                } catch (err) {
                    console.error('Error updating list in Supabase:', err);
                }

                renderLists();
                alert(`Updated "${list.name}" with ${listProducts.length} products\nDescription: ${list.description}`);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '🔄';
                }
            }
        }

        // Export functions
        function exportStorefronts() {
            // JSON already contains only successful storefronts
            downloadCSV(storefronts, 'storefronts-export.csv');
        }

        function exportLists() {
            downloadCSV(lists, 'lists-export.csv');
        }

        function exportSelectedLists() {
            const selected = lists.filter(l => selectedLists.has(l.id));
            downloadCSV(selected, 'selected-lists-export.csv');
        }

        function exportModalLists() {
            const storefrontLists = lists.filter(l => l.storefront === window.currentModalStorefront);
            downloadCSV(storefrontLists, `${window.currentModalStorefront}-lists.csv`);
            closeModal('viewListsModal');
        }

        function addToExport(listId) {
            selectedLists.add(listId);
            updateSelectedCount();
            renderLists();
        }

        // Download helpers
        function downloadCSV(data, filename) {
            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            const csv = [
                '\uFEFF' + headers.join(','),
                ...data.map(row => headers.map(h => {
                    const val = row[h] || '';
                    return val.toString().includes(',') ? `"${val}"` : val;
                }).join(','))
            ].join('\n');

            download(csv, filename, 'text/csv');
        }

        function downloadJSON(data, filename) {
            download(JSON.stringify(data, null, 2), filename, 'application/json');
        }

        function downloadText(text, filename) {
            download(text, filename, 'text/plain');
        }

        function download(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // DRAFT WORKFLOW FUNCTIONS
        // ========================================

        let currentDraftList = null;
        let currentDraftStorefront = null;
        let currentDraftProducts = [];
        let selectedImages = new Set();
        let selectedAdCopy = new Set();
        let currentDraftStep = 0; // 0 = list selector, 1-4 = workflow steps
        let creativesAutoGenerated = false; // Track if creatives have been auto-generated

        // Initialize draft tab (populate list selector)
        function initDraftTab() {
            const storefrontSelect = document.getElementById('draftStorefrontSelect');
            if (!storefrontSelect) return;

            storefrontSelect.innerHTML = '<option value="">Select storefront...</option>';
            const sortedStorefronts = [...storefronts].sort((a, b) => (b.totalListLikes || 0) - (a.totalListLikes || 0));
            sortedStorefronts.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.username} (${s.lists || 0} lists)`;
                storefrontSelect.appendChild(option);
            });
        }

        // Update list options when storefront is selected
        function updateDraftListOptions() {
            const storefrontId = document.getElementById('draftStorefrontSelect').value;
            const listSelect = document.getElementById('draftListSelect');
            const startBtn = document.getElementById('startDraftBtn');

            if (!storefrontId) {
                listSelect.innerHTML = '<option value="">Select a storefront first...</option>';
                listSelect.disabled = true;
                startBtn.disabled = true;
                return;
            }

            const storefrontLists = lists.filter(l => l.storefront === storefrontId)
                .sort((a, b) => (b.likes || 0) - (a.likes || 0));

            listSelect.innerHTML = '<option value="">Select a list...</option>';
            storefrontLists.forEach(l => {
                const option = document.createElement('option');
                option.value = l.id;
                option.textContent = `${l.name} (${formatNumber(l.likes || 0)} likes, ${l.products || 0} products)`;
                listSelect.appendChild(option);
            });
            listSelect.disabled = false;

            listSelect.onchange = () => {
                startBtn.disabled = !listSelect.value;
            };
        }

        // Start draft from selector
        function startDraftFromSelector() {
            const storefrontId = document.getElementById('draftStorefrontSelect').value;
            const listId = document.getElementById('draftListSelect').value;
            if (storefrontId && listId) {
                openDraft(listId, storefrontId);
            }
        }

        // Open draft for a specific list
        function openDraft(listId, storefrontId) {
            // Find the list and storefront data
            const list = lists.find(l => l.id === listId);
            const storefront = storefronts.find(s => s.id === storefrontId);

            if (!list) {
                alert('List not found');
                return;
            }

            currentDraftList = list;
            currentDraftStorefront = storefront;
            currentDraftProducts = products.filter(p => p.listId === listId);

            // Update list name in step headers
            const listNameDisplay = list.name.length > 40 ? list.name.substring(0, 40) + '...' : list.name;
            ['listNameStep2', 'listNameStep3', 'listNameStep4'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '📋 ' + listNameDisplay;
            });

            // Reset state
            selectedImages = new Set();
            selectedAdCopy = new Set();
            creativesAutoGenerated = false; // Reset to trigger auto-generation for new list

            // Hide list selector, show workflow
            document.getElementById('draftListSelector').style.display = 'none';

            // Populate Step 1 - List Overview
            document.getElementById('draftListTitle').textContent = list.name;
            document.getElementById('draftListDesc').textContent = `Curated collection from ${storefrontId} storefront`;
            document.getElementById('draftProductCount').textContent = list.products || currentDraftProducts.length;
            document.getElementById('draftListLikes').textContent = formatNumber(list.likes || 0);
            document.getElementById('draftStorefront').textContent = storefrontId;
            document.getElementById('draftFinalTitle').value = list.name;
            document.getElementById('draftFinalDesc').value = `Discover amazing products from ${storefrontId}'s ${list.name} collection.`;

            // Update image prompt with list name
            const imagePrompt = document.getElementById('draftImagePrompt');
            if (imagePrompt) {
                imagePrompt.value = imagePrompt.value.replace(/\{\{list_name\}\}/g, list.name);
            }

            // Populate products preview
            const productsPreview = document.getElementById('draftProductsPreview');
            if (currentDraftProducts.length > 0) {
                productsPreview.innerHTML = currentDraftProducts.slice(0, 10).map(p => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee;">
                        <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${p.asin}</code>
                        <span style="font-size: 13px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${(p.title || '').substring(0, 40)}...</span>
                        ${p.price ? `<span style="font-size: 12px; color: #28a745;">$${p.price.toFixed(2)}</span>` : ''}
                    </div>
                `).join('') + (currentDraftProducts.length > 10 ? `<div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">+ ${currentDraftProducts.length - 10} more products</div>` : '');
            } else {
                productsPreview.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No products scraped for this list</p>';
            }

            // Go to step 1
            goToDraftStep(1);

            // Switch to draft tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('draftTab').classList.add('active');
            document.getElementById('draft-tab').classList.add('active');

            // Update campaign name preview
            updateCampaignNamePreview();
        }

        // Show draft tab without a list selected (show list selector)
        function showDraftSelector() {
            currentDraftList = null;
            currentDraftStorefront = null;
            currentDraftStep = 0;
            creativesAutoGenerated = false; // Reset auto-generation flag

            // Reset all selections
            selectedImages = new Set();
            selectedTitles = new Set();
            selectedDescriptions = new Set();
            selectedPostTexts = new Set();
            imagePromptHistory = [];
            adCopyPromptHistory = [];

            // Hide all workflow sections
            document.getElementById('draftSection1').style.display = 'none';
            document.getElementById('draftSection2').style.display = 'none';
            document.getElementById('draftSection3').style.display = 'none';
            document.getElementById('draftSection4').style.display = 'none';
            document.getElementById('draftSuccess').style.display = 'none';

            // Show list selector
            document.getElementById('draftListSelector').style.display = 'block';

            // Reset step indicators
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`draftStep${i}`);
                if (stepEl) {
                    const circle = stepEl.querySelector('div');
                    stepEl.style.color = '#999';
                    circle.style.background = '#eee';
                    circle.style.color = '#666';
                }
            }

            // Initialize dropdowns
            initDraftTab();
        }

        // Toggle collapsible prompt sections
        function toggleDraftPrompt(sectionId) {
            const body = document.getElementById(sectionId + 'Body');
            const toggle = document.getElementById(sectionId + 'Toggle');

            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.textContent = '▲';
            } else {
                body.style.display = 'none';
                toggle.textContent = '▼';
            }
        }

        // Generate mock titles
        function generateDraftTitles() {
            const listName = currentDraftList?.name || 'Product Collection';
            const container = document.getElementById('generatedTitles');

            // Mock AI-generated titles
            const titles = [
                `Top ${listName} Picks for 2025`,
                `Must-Have ${listName} Items`,
                `${listName} Essentials You'll Love`
            ];

            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h5 style="margin-bottom: 10px;">Generated Titles:</h5>
                    ${titles.map((t, i) => `
                        <label style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;"
                               onmouseover="this.style.background='#eee'" onmouseout="this.style.background='transparent'">
                            <input type="radio" name="titleChoice" value="${t}" onchange="document.getElementById('draftFinalTitle').value=this.value">
                            <span>${t}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            container.style.display = 'block';
        }

        // Generate mock descriptions
        function generateDraftDescriptions() {
            const listName = currentDraftList?.name || 'Product Collection';
            const container = document.getElementById('generatedDescriptions');

            // Mock AI-generated descriptions
            const descriptions = [
                `Discover our hand-picked ${listName} selection. Each item has been carefully chosen for quality and value. Shop now and transform your experience!`,
                `Looking for the best ${listName}? Our experts have curated this collection just for you. Don't miss out on these amazing deals!`,
                `Upgrade your life with these top-rated ${listName} products. Trusted by thousands of happy customers. Limited time offers available!`
            ];

            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h5 style="margin-bottom: 10px;">Generated Descriptions:</h5>
                    ${descriptions.map((d, i) => `
                        <label style="display: block; padding: 10px; cursor: pointer; border-radius: 4px; margin-bottom: 8px; border: 1px solid #eee;"
                               onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                            <input type="radio" name="descChoice" value="${d}" onchange="document.getElementById('draftFinalDesc').value=this.value" style="margin-right: 10px;">
                            <span style="font-size: 13px; line-height: 1.5;">${d}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            container.style.display = 'block';
        }

        // Image prompt history for refinement
        let imagePromptHistory = [];
        let adCopyPromptHistory = [];
        let inspoImageData = null; // Store inspiration image data

        // Handle inspiration image upload
        function handleInspoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                inspoImageData = e.target.result;
                document.getElementById('inspoImageThumb').src = inspoImageData;
                document.getElementById('inspoImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Clear inspiration image
        function clearInspoImage() {
            inspoImageData = null;
            document.getElementById('inspoImageUpload').value = '';
            document.getElementById('inspoImagePreview').style.display = 'none';
        }
        let generatedImages = []; // Store generated image data
        let imageGenerationAborted = false; // Flag to stop generation

        // Stop image generation
        function stopImageGeneration() {
            imageGenerationAborted = true;
            document.getElementById('stopGenerateBtn').style.display = 'none';
            document.getElementById('generateImagesBtn').disabled = false;
            document.getElementById('generateBtnText').style.display = 'inline';
            document.getElementById('generateBtnSpinner').style.display = 'none';
        }

        // Facebook Ad sizes configuration
        const FB_AD_SIZES = {
            '1080x1080': { width: 1080, height: 1080, name: 'Square (1:1)', aspectRatio: '1:1', cssAspect: '1/1' },
            '1200x628': { width: 1200, height: 628, name: 'Landscape (1.91:1)', aspectRatio: '1.91:1', cssAspect: '1200/628' },
            '1080x1920': { width: 1080, height: 1920, name: 'Story (9:16)', aspectRatio: '9:16', cssAspect: '1080/1920' }
        };

        // Prompt templates
        const PROMPT_TEMPLATES = {
            ugc: `Create a UGC-style Facebook ad image for "{{list_name}}"
{{list_description_section}}
Style: Authentic influencer content, user-generated feel, casual and relatable
Colors: Vibrant, eye-catching, bold and playful color palette
Mood: Excited influencer sharing their favorite finds with followers
Scene: Lifestyle setting with products arranged naturally, like an unboxing or haul

Key elements:
- Bright, saturated colors that pop in the feed
- Natural lighting with warm tones
- Products displayed in an authentic, "just discovered this" way
- Engaging composition that feels personal, not corporate`,

            branded: `Create a professional branded Facebook ad image for "{{list_name}}"
{{list_description_section}}
Style: Clean, polished, premium brand aesthetic
Colors: Sophisticated color palette with brand-appropriate tones
Mood: Aspirational, trustworthy, high-quality
Layout: Elegant product arrangement with ample white space

Key elements:
- Professional studio-quality lighting
- Minimalist, premium background
- Products as hero elements with subtle shadows
- Consistent brand feel, luxury positioning
- Clear visual hierarchy`,

            canva: `Create a text-focused Facebook ad image for "{{list_name}}"
{{list_description_section}}
Style: Canva-style graphic design with bold typography
Colors: High contrast, attention-grabbing color blocks
Layout: Large headline text with product images as supporting elements
Focus: Text-first design with clear call-to-action

Key elements:
- Bold, readable headline text (e.g., "TOP PICKS!" or "MUST-HAVES!")
- Geometric shapes and color blocks as background
- Products arranged in a grid or collage behind text
- Sale badges, price callouts, or discount percentages
- Eye-catching banner style that stops the scroll`,

            products: `Create a Facebook ad image featuring these actual products for "{{list_name}}"
{{list_description_section}}
IMPORTANT: Use the product images provided as reference. The ad should showcase these specific products.

Style: Product showcase with lifestyle appeal
Layout: Feature the products prominently, arranged attractively
Background: Clean, complementary background that makes products pop
Mood: Shopping excitement, discovery of great products

Key elements:
- Products from the reference images as the main focus
- Attractive arrangement (grid, collage, or featured display)
- Clean background that doesn't compete with products
- Optional subtle lifestyle context
- Professional product photography feel`
        };

        // Flag to track if product images template is selected
        let useProductImages = false;

        // Change prompt template
        function changePromptTemplate() {
            const templateSelect = document.getElementById('promptTemplateSelect');
            const promptTextarea = document.getElementById('draftImagePrompt');
            const listName = currentDraftList?.name || '{{list_name}}';
            const listDescription = currentDraftList?.description || '';

            const template = PROMPT_TEMPLATES[templateSelect.value] || PROMPT_TEMPLATES.ugc;

            // Build description section if description exists
            const descriptionSection = listDescription
                ? `\nList Description: "${listDescription}"\nUse this context to inform the visual style and mood.\n`
                : '';

            promptTextarea.value = template
                .replace(/\{\{list_name\}\}/g, listName)
                .replace(/\{\{list_description_section\}\}/g, descriptionSection);

            // Auto-expand the prompt dropdown to show the updated prompt
            const promptBody = document.getElementById('imagePromptBody');
            const promptToggle = document.getElementById('imagePromptToggle');
            if (promptBody && promptBody.style.display === 'none') {
                promptBody.style.display = 'block';
                if (promptToggle) promptToggle.textContent = '▲';
            }

            // Track if product images should be included
            useProductImages = templateSelect.value === 'products';

            // Show/hide product images preview when products template selected
            const productImagesPreview = document.getElementById('productImagesPreview');
            if (productImagesPreview) {
                if (useProductImages && currentDraftProducts.length > 0) {
                    const productImages = currentDraftProducts.filter(p => p.image).slice(0, 6);
                    if (productImages.length > 0) {
                        productImagesPreview.innerHTML = `
                            <div style="margin-top: 15px; padding: 15px; background: #f0f7ff; border-radius: 8px; border: 1px solid #cce0ff;">
                                <div style="font-weight: 500; margin-bottom: 10px; color: #0056b3;">Product images that will be included:</div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    ${productImages.map(p => `<img src="${p.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">`).join('')}
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 8px;">${productImages.length} product image${productImages.length > 1 ? 's' : ''} will be sent to AI</div>
                            </div>
                        `;
                        productImagesPreview.style.display = 'block';
                    } else {
                        productImagesPreview.innerHTML = `
                            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                                <div style="color: #856404;">No product images available for this list. The AI will generate generic product imagery.</div>
                            </div>
                        `;
                        productImagesPreview.style.display = 'block';
                    }
                } else {
                    productImagesPreview.style.display = 'none';
                }
            }
        }

        // Generate images using Nano Banana (Gemini) API
        async function generateDraftImages() {
            const dimensionSelect = document.getElementById('imageDimensions').value;
            const variations = parseInt(document.getElementById('imageCount')?.value) || 3;
            const grid = document.getElementById('draftImagesGrid');
            const prompt = document.getElementById('draftImagePrompt').value;

            // Determine which sizes to generate
            const sizesToGenerate = dimensionSelect === 'all'
                ? Object.keys(FB_AD_SIZES)
                : [dimensionSelect];

            // Store initial prompt in history
            if (imagePromptHistory.length === 0) {
                imagePromptHistory.push({ type: 'initial', prompt: prompt });
            }

            // Reset abort flag and show loading state
            imageGenerationAborted = false;
            const btn = document.getElementById('generateImagesBtn');
            const btnText = document.getElementById('generateBtnText');
            const btnSpinner = document.getElementById('generateBtnSpinner');
            const stopBtn = document.getElementById('stopGenerateBtn');
            btn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline';
            stopBtn.style.display = 'inline-block';

            // Clear grid and show loading placeholders with correct aspect ratios
            grid.innerHTML = '';
            let placeholderIndex = 0;
            for (const size of sizesToGenerate) {
                const sizeConfig = FB_AD_SIZES[size];
                const cssAspect = sizeConfig.cssAspect;
                for (let v = 0; v < variations; v++) {
                    grid.innerHTML += `
                        <div class="creative-card" id="image-placeholder-${placeholderIndex}" style="border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                            <div style="aspect-ratio: ${cssAspect}; background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999; font-size: 10px;">⏳</span>
                            </div>
                            <div style="padding: 6px;"><span style="font-size: 9px; color: #999;">${sizeConfig.name} - V${v + 1}</span></div>
                        </div>
                    `;
                    placeholderIndex++;
                }
            }

            generatedImages = [];
            let imageIndex = 0;

            try {
                for (const size of sizesToGenerate) {
                    // Check if generation was stopped
                    if (imageGenerationAborted) break;

                    const sizeConfig = FB_AD_SIZES[size];

                    // Get product images if using products template
                    const productImageUrls = useProductImages
                        ? currentDraftProducts.filter(p => p.image).slice(0, 4).map(p => p.image)
                        : [];

                    for (let v = 0; v < variations; v++) {
                        // Check if generation was stopped
                        if (imageGenerationAborted) {
                            console.log('Image generation stopped by user');
                            break;
                        }

                        const variationPrompt = variations > 1
                            ? `${prompt}\n\nVariation ${v + 1}: Create a unique visual approach.`
                            : prompt;

                        try {
                            const imageData = await generateImageWithGemini(variationPrompt, sizeConfig, null, productImageUrls);

                            if (imageData) {
                                generatedImages.push({
                                    index: imageIndex,
                                    size: size,
                                    sizeName: sizeConfig.name,
                                    variation: v + 1,
                                    data: imageData,
                                    prompt: variationPrompt
                                });

                                // Update the placeholder with actual image
                                updateImageCard(imageIndex, imageData, sizeConfig.name, v + 1, size);
                            } else {
                                // Show error for this image
                                updateImageCardError(imageIndex, sizeConfig.name, v + 1, size);
                            }
                        } catch (err) {
                            console.error(`Error generating image ${imageIndex}:`, err);
                            updateImageCardError(imageIndex, sizeConfig.name, v + 1, size, err.message);
                        }

                        imageIndex++;
                    }
                }
            } catch (error) {
                console.error('Image generation error:', error);
                alert('Error generating images: ' + error.message);
            }

            // Reset button state
            btn.disabled = false;
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
            stopBtn.style.display = 'none';

            // Show follow-up section if we generated any images
            if (generatedImages.length > 0) {
                document.getElementById('imageFollowupSection').style.display = 'block';
                updatePromptHistory('image');
            }
        }

        // Helper: Fetch image URL and convert to base64
        async function fetchImageAsBase64(url) {
            try {
                // Use a proxy or direct fetch depending on CORS
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.error('Failed to fetch image:', url, e);
                return null;
            }
        }

        // Call Gemini API to generate image
        async function generateImageWithGemini(prompt, sizeConfig, referenceImage = null, productImages = []) {
            const apiKey = window.GEMINI_API_KEY;
            if (!apiKey) {
                throw new Error('Gemini API key not configured');
            }

            // Using Gemini 2.0 Flash for image generation
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp-image-generation:generateContent?key=${apiKey}`;

            // Build parts array
            const parts = [];

            // Add product images if provided (for "Use Product Images" template)
            if (productImages && productImages.length > 0) {
                // Add each product image
                for (const imgUrl of productImages) {
                    try {
                        // Fetch and convert image to base64
                        const imgData = await fetchImageAsBase64(imgUrl);
                        if (imgData) {
                            parts.push({
                                inlineData: {
                                    mimeType: 'image/jpeg',
                                    data: imgData
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Could not load product image:', imgUrl);
                    }
                }
                parts.push({
                    text: `Create a Facebook ad image featuring these products. Use the provided product images as reference - showcase these exact products in an attractive ad layout.

Specifications:
- Aspect ratio: ${sizeConfig.aspectRatio}
- Dimensions: ${sizeConfig.width}x${sizeConfig.height}
- Style: Professional product showcase ad
- Purpose: Facebook/Instagram ad for e-commerce

Creative brief:
${prompt}`
                });
            }
            // Add reference/inspiration image if provided
            else if (referenceImage) {
                const base64Data = referenceImage.split(',')[1]; // Remove data:image/...;base64, prefix
                const mimeType = referenceImage.match(/data:([^;]+);/)?.[1] || 'image/jpeg';
                parts.push({
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Data
                    }
                });
                parts.push({
                    text: `Use the uploaded image as style inspiration and reference. Generate a new Facebook ad image with these specifications:
- Aspect ratio: ${sizeConfig.aspectRatio}
- Dimensions: ${sizeConfig.width}x${sizeConfig.height}
- Style: Match the visual style, colors, and mood of the reference image
- Purpose: Facebook/Instagram ad for e-commerce products

Creative brief:
${prompt}`
                });
            } else {
                parts.push({
                    text: `Generate a Facebook ad image with these specifications:
- Aspect ratio: ${sizeConfig.aspectRatio}
- Dimensions: ${sizeConfig.width}x${sizeConfig.height}
- Style: Professional, high-quality advertising creative
- Purpose: Facebook/Instagram ad for e-commerce products

Creative brief:
${prompt}`
                });
            }

            const requestBody = {
                contents: [{
                    parts: parts
                }],
                generationConfig: {
                    responseModalities: ["TEXT", "IMAGE"]
                }
            };

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();

            // Extract image from response
            const responseParts = data.candidates?.[0]?.content?.parts || [];
            for (const part of responseParts) {
                if (part.inlineData?.mimeType?.startsWith('image/')) {
                    return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                }
            }

            return null;
        }

        // Update image card with generated image
        function updateImageCard(index, imageData, sizeName, variation, sizeKey) {
            const placeholder = document.getElementById(`image-placeholder-${index}`);
            const cssAspect = sizeKey && FB_AD_SIZES[sizeKey] ? FB_AD_SIZES[sizeKey].cssAspect : '1/1';
            const imageId = String(index + 1);
            if (placeholder) {
                placeholder.outerHTML = `
                    <div class="creative-card" onclick="toggleImageSelect(this)" data-image="${imageId}" data-image-data="${index}"
                         style="border: 2px solid #667eea; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);">
                        <div style="aspect-ratio: ${cssAspect}; background-image: url('${imageData}'); background-size: cover; background-position: center;"></div>
                        <div style="padding: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 9px; font-weight: 600;">${sizeName}</div>
                                <div style="font-size: 8px; color: #666;">Var ${variation}</div>
                            </div>
                            <input type="checkbox" style="width: 12px; height: 12px;" checked>
                        </div>
                    </div>
                `;
                // Add to selectedImages since it's checked by default
                selectedImages.add(imageId);
                updateCreativeSummary();

                // Auto-save to image library
                addToLibrary(imageData, {
                    listName: currentDraftList?.name || 'Campaign Image',
                    size: sizeName,
                    prompt: document.getElementById('draftImagePrompt')?.value || ''
                });
            }
        }

        // Update image card with error state
        function updateImageCardError(index, sizeName, variation, sizeKey, errorMsg = 'Failed') {
            const placeholder = document.getElementById(`image-placeholder-${index}`);
            const cssAspect = sizeKey && FB_AD_SIZES[sizeKey] ? FB_AD_SIZES[sizeKey].cssAspect : '1/1';
            if (placeholder) {
                placeholder.outerHTML = `
                    <div class="creative-card" data-image="${index + 1}"
                         style="border: 1px solid #f5c6cb; border-radius: 8px; overflow: hidden; background: #fff5f5;">
                        <div style="aspect-ratio: ${cssAspect}; display: flex; align-items: center; justify-content: center; color: #721c24; font-size: 9px; text-align: center; padding: 5px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 3px;">❌ Failed</div>
                                <div style="font-size: 8px; opacity: 0.8;">${errorMsg.substring(0, 30)}</div>
                            </div>
                        </div>
                        <div style="padding: 6px;">
                            <div style="font-size: 9px;">${sizeName} - V${variation}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Handle image file upload
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            const grid = document.getElementById('draftImagesGrid');

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageIndex = grid.children.length + 1;
                    const card = document.createElement('div');
                    card.className = 'creative-card';
                    card.onclick = function() { toggleImageSelect(this); };
                    card.dataset.image = imageIndex;
                    card.style.cssText = 'border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s;';
                    card.innerHTML = `
                        <div style="height: 120px; background-image: url('${e.target.result}'); background-size: cover; background-position: center;"></div>
                        <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px;"><strong>${file.name.substring(0, 15)}...</strong></span>
                            <input type="checkbox" style="width: 16px; height: 16px;">
                        </div>
                    `;
                    grid.appendChild(card);
                };
                reader.readAsDataURL(file);
            });

            // Show follow-up section
            document.getElementById('imageFollowupSection').style.display = 'block';
        }

        // Refine images with follow-up prompt
        async function refineImages() {
            const followupPrompt = document.getElementById('imageFollowupPrompt').value;
            if (!followupPrompt.trim()) return;

            // Add to history
            imagePromptHistory.push({ type: 'followup', prompt: followupPrompt });
            updatePromptHistory('image');

            // Clear input
            document.getElementById('imageFollowupPrompt').value = '';

            // Build full prompt with history
            const basePrompt = document.getElementById('draftImagePrompt').value;
            const fullPrompt = `${basePrompt}\n\nRefinement request: ${followupPrompt}`;

            // Get current settings
            const dimensionSelect = document.getElementById('imageDimensions').value;
            const variations = parseInt(document.getElementById('imageCount')?.value) || 3;
            const grid = document.getElementById('draftImagesGrid');

            const sizesToGenerate = dimensionSelect === 'all'
                ? Object.keys(FB_AD_SIZES)
                : [dimensionSelect];

            // Show loading state
            const btn = document.querySelector('#imageFollowupSection .btn');
            const originalBtnText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Refining...';

            // Clear grid and show loading placeholders
            grid.innerHTML = '';
            let placeholderIndex = 0;
            for (const size of sizesToGenerate) {
                const sizeConfig = FB_AD_SIZES[size];
                const cssAspect = sizeConfig.cssAspect;
                for (let v = 0; v < variations; v++) {
                    grid.innerHTML += `
                        <div class="creative-card" id="image-placeholder-${placeholderIndex}" style="border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                            <div style="aspect-ratio: ${cssAspect}; background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999; font-size: 10px;">⏳</span>
                            </div>
                            <div style="padding: 6px;"><span style="font-size: 9px; color: #999;">${sizeConfig.name} - V${v + 1}</span></div>
                        </div>
                    `;
                    placeholderIndex++;
                }
            }

            generatedImages = [];
            let imageIndex = 0;

            try {
                for (const size of sizesToGenerate) {
                    const sizeConfig = FB_AD_SIZES[size];

                    for (let v = 0; v < variations; v++) {
                        const variationPrompt = variations > 1
                            ? `${fullPrompt}\n\nVariation ${v + 1}: Create a unique visual approach.`
                            : fullPrompt;

                        try {
                            // Pass inspiration image if uploaded
                            const imageData = await generateImageWithGemini(variationPrompt, sizeConfig, inspoImageData);

                            if (imageData) {
                                generatedImages.push({
                                    index: imageIndex,
                                    size: size,
                                    sizeName: sizeConfig.name,
                                    variation: v + 1,
                                    data: imageData,
                                    prompt: variationPrompt
                                });
                                updateImageCard(imageIndex, imageData, sizeConfig.name, v + 1, size);
                            } else {
                                updateImageCardError(imageIndex, sizeConfig.name, v + 1, size);
                            }
                        } catch (err) {
                            console.error(`Error refining image ${imageIndex}:`, err);
                            updateImageCardError(imageIndex, sizeConfig.name, v + 1, size, err.message);
                        }

                        imageIndex++;
                    }
                }
            } catch (error) {
                console.error('Image refinement error:', error);
                alert('Error refining images: ' + error.message);
            }

            // Reset button state
            btn.disabled = false;
            btn.textContent = originalBtnText;

            // Clear inspo image after use
            clearInspoImage();
        }

        // Refine ad copy with follow-up prompt
        function refineAdCopy() {
            const followupPrompt = document.getElementById('adCopyFollowupPrompt').value;
            if (!followupPrompt.trim()) return;

            // Add to history
            adCopyPromptHistory.push({ type: 'followup', prompt: followupPrompt });
            updatePromptHistory('adCopy');

            // Clear input
            document.getElementById('adCopyFollowupPrompt').value = '';

            // Mock: regenerate ad copy (in real app, would call API with history)
            alert('Refining ad copy with: "' + followupPrompt + '"\n\n(In production, this would call the AI API with the full prompt history)');
        }

        // Update prompt history display
        function updatePromptHistory(type) {
            const history = type === 'image' ? imagePromptHistory : adCopyPromptHistory;
            const container = document.getElementById(type + 'PromptHistory');
            if (!container) return;

            if (history.length <= 1) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<strong>Prompt History:</strong><br>' +
                history.map((h, i) => `${i + 1}. ${h.type === 'initial' ? '[Initial]' : '[Refinement]'} ${h.prompt.substring(0, 50)}...`).join('<br>');
        }

        // Toggle image selection
        function toggleImageSelect(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            const imageId = element.dataset.image;

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                element.style.borderColor = '#667eea';
                element.style.boxShadow = '0 0 0 2px rgba(102, 126, 234, 0.3)';
                selectedImages.add(imageId);
            } else {
                element.style.borderColor = '#eee';
                element.style.boxShadow = 'none';
                selectedImages.delete(imageId);
            }

            updateCreativeSummary();
        }

        // Selected ad copy tracking
        let selectedTitles = new Set();
        let selectedDescriptions = new Set();
        let selectedPostTexts = new Set();

        // Ad Copy Style Templates
        const AD_COPY_STYLES = {
            default: {
                titles: `Generate 5 ad titles (40 chars max). Punchy, attention-grabbing.

List: {{list_name}}{{list_description_section}}`,
                descriptions: `Generate 5 short descriptions (90 chars max). Highlight benefits.

List: {{list_name}}{{list_description_section}}`,
                postTexts: `Generate 5 post texts (125 chars max). Hook + value prop + CTA.

List: {{list_name}}{{list_description_section}}`
            },
            emotional: {
                titles: `Generate 5 emotional ad titles (40 chars max). Evoke feelings and desires.

List: {{list_name}}{{list_description_section}}`,
                descriptions: `Generate 5 emotional descriptions (90 chars max). Connect with feelings.

List: {{list_name}}{{list_description_section}}`,
                postTexts: `Generate 5 emotional post texts (125 chars max). Tell a story, create connection.

List: {{list_name}}{{list_description_section}}`
            },
            urgency: {
                titles: `Generate 5 urgent ad titles (40 chars max). Create FOMO, limited time/stock.

List: {{list_name}}{{list_description_section}}`,
                descriptions: `Generate 5 urgent descriptions (90 chars max). Scarcity, deadlines, exclusivity.

List: {{list_name}}{{list_description_section}}`,
                postTexts: `Generate 5 urgent post texts (125 chars max). Limited time, act now, don't miss out.

List: {{list_name}}{{list_description_section}}`
            },
            benefit: {
                titles: `Generate 5 benefit-focused titles (40 chars max). What user gains.

List: {{list_name}}{{list_description_section}}`,
                descriptions: `Generate 5 benefit descriptions (90 chars max). Transform, solve problems.

List: {{list_name}}{{list_description_section}}`,
                postTexts: `Generate 5 benefit post texts (125 chars max). Results and outcomes.

List: {{list_name}}{{list_description_section}}`
            },
            question: {
                titles: `Generate 5 question-based titles (40 chars max). Curiosity-driven.

List: {{list_name}}{{list_description_section}}`,
                descriptions: `Generate 5 question descriptions (90 chars max). Engage with questions.

List: {{list_name}}{{list_description_section}}`,
                postTexts: `Generate 5 question post texts (125 chars max). Rhetorical questions, engage reader.

List: {{list_name}}{{list_description_section}}`
            }
        };

        // Change ad copy style
        function changeAdCopyStyle() {
            const styleSelect = document.getElementById('adCopyStyleSelect');
            const listName = currentDraftList?.name || '{{list_name}}';
            const listDescription = currentDraftList?.description || '';
            const style = AD_COPY_STYLES[styleSelect.value] || AD_COPY_STYLES.default;

            // Build description section if description exists
            const descriptionSection = listDescription
                ? `\nDescription: "${listDescription}"`
                : '';

            document.getElementById('draftTitlesPrompt').value = style.titles
                .replace(/\{\{list_name\}\}/g, listName)
                .replace(/\{\{list_description_section\}\}/g, descriptionSection);
            document.getElementById('draftDescriptionsPrompt').value = style.descriptions
                .replace(/\{\{list_name\}\}/g, listName)
                .replace(/\{\{list_description_section\}\}/g, descriptionSection);
            document.getElementById('draftPostTextsPrompt').value = style.postTexts
                .replace(/\{\{list_name\}\}/g, listName)
                .replace(/\{\{list_description_section\}\}/g, descriptionSection);

            // Auto-expand the prompt dropdown
            const promptBody = document.getElementById('adCopyPromptBody');
            const promptToggle = document.getElementById('adCopyPromptToggle');
            if (promptBody && promptBody.style.display === 'none') {
                promptBody.style.display = 'block';
                if (promptToggle) promptToggle.textContent = '▲';
            }
        }

        // Generate mock ad copy (titles, descriptions, post texts)
        function generateDraftAdCopy() {
            const listName = currentDraftList?.name || 'Collection';

            // Store initial prompts in history
            if (adCopyPromptHistory.length === 0) {
                adCopyPromptHistory.push({ type: 'initial', prompt: 'Generated all ad copy' });
            }

            // Mock titles
            const titles = [
                `Shop ${listName} Now!`,
                `${listName} Sale - Limited Time`,
                `Best ${listName} Picks`,
                `Top ${listName} Deals`,
                `Discover ${listName}`
            ];

            // Mock descriptions
            const descriptions = [
                `Hand-picked by top creators. Quality guaranteed.`,
                `Top-rated products at unbeatable prices.`,
                `Curated collection for smart shoppers.`,
                `Trending items you'll love. Shop now!`,
                `Premium selection, amazing value.`
            ];

            // Mock post texts
            const postTexts = [
                `Discover amazing deals on ${listName}. Hand-picked by top creators. Shop now and save!`,
                `Don't miss out on our curated ${listName} collection. Top-rated products at unbeatable prices!`,
                `Looking for the perfect ${listName}? Our experts found the best for you. Limited time only!`,
                `Upgrade your life with these top-rated ${listName} products. Trusted by thousands!`,
                `Your search for the best ${listName} ends here. Shop the collection now!`
            ];

            // Populate titles
            const titlesList = document.getElementById('adTitlesList');
            const titleLabels = titlesList.querySelectorAll('.ad-copy-item');
            titles.forEach((t, i) => {
                if (titleLabels[i]) {
                    titleLabels[i].querySelector('span').textContent = t;
                    titleLabels[i].querySelector('span').style.color = '#333';
                }
            });

            // Populate descriptions
            const descList = document.getElementById('adDescriptionsList');
            const descLabels = descList.querySelectorAll('.ad-copy-item');
            descriptions.forEach((d, i) => {
                if (descLabels[i]) {
                    descLabels[i].querySelector('span').textContent = d;
                    descLabels[i].querySelector('span').style.color = '#333';
                }
            });

            // Populate post texts
            const postList = document.getElementById('adPostTextsList');
            const postLabels = postList.querySelectorAll('.ad-copy-item');
            postTexts.forEach((p, i) => {
                if (postLabels[i]) {
                    postLabels[i].querySelector('span').textContent = p;
                    postLabels[i].querySelector('span').style.color = '#333';
                }
            });

            // Select all ad copy by default
            document.querySelectorAll('input[data-type="title"]').forEach(cb => cb.checked = true);
            document.querySelectorAll('input[data-type="description"]').forEach(cb => cb.checked = true);
            document.querySelectorAll('input[data-type="posttext"]').forEach(cb => cb.checked = true);

            // Update selection counts and styling
            updateAdCopySelection();

            // Show follow-up section
            document.getElementById('adCopyFollowupSection').style.display = 'block';
            updatePromptHistory('adCopy');
        }

        // Update ad copy selection counts
        function updateAdCopySelection() {
            // Count selected items
            selectedTitles = new Set();
            selectedDescriptions = new Set();
            selectedPostTexts = new Set();

            document.querySelectorAll('input[data-type="title"]:checked').forEach(cb => {
                selectedTitles.add(cb.dataset.index);
            });
            document.querySelectorAll('input[data-type="description"]:checked').forEach(cb => {
                selectedDescriptions.add(cb.dataset.index);
            });
            document.querySelectorAll('input[data-type="posttext"]:checked').forEach(cb => {
                selectedPostTexts.add(cb.dataset.index);
            });

            // Update count displays
            document.getElementById('selectedTitlesCount').textContent = `(${selectedTitles.size} selected)`;
            document.getElementById('selectedDescriptionsCount').textContent = `(${selectedDescriptions.size} selected)`;
            document.getElementById('selectedPostTextsCount').textContent = `(${selectedPostTexts.size} selected)`;

            // Update totals in summary
            document.getElementById('selectedTitlesTotal').textContent = selectedTitles.size;
            document.getElementById('selectedDescTotal').textContent = selectedDescriptions.size;
            document.getElementById('selectedPostTotal').textContent = selectedPostTexts.size;

            // Calculate total combinations
            updateCreativeSummary();

            // Style selected items
            document.querySelectorAll('.ad-copy-item').forEach(label => {
                const cb = label.querySelector('input[type="checkbox"]');
                if (cb && cb.checked) {
                    label.style.borderColor = '#667eea';
                    label.style.background = '#f8f9ff';
                } else {
                    label.style.borderColor = '#eee';
                    label.style.background = 'white';
                }
            });
        }

        // Update creative summary
        function updateCreativeSummary() {
            // Update image count
            const imgCount = document.getElementById('selectedImagesCount');
            if (imgCount) imgCount.textContent = selectedImages.size;

            // Calculate total combinations: images × titles × descriptions × post texts
            const titlesCount = selectedTitles?.size || 0;
            const descCount = selectedDescriptions?.size || 0;
            const postCount = selectedPostTexts?.size || 0;

            // Total = images × (titles × descriptions × post texts)
            // If any category is 0, use 1 as minimum for calculation display
            const effectiveTitles = titlesCount || 1;
            const effectiveDesc = descCount || 1;
            const effectivePost = postCount || 1;
            const effectiveImages = selectedImages.size || 1;

            let total = 0;
            if (selectedImages.size > 0 && (titlesCount > 0 || descCount > 0 || postCount > 0)) {
                total = selectedImages.size * Math.max(1, titlesCount) * Math.max(1, descCount) * Math.max(1, postCount);
            }

            const totalCount = document.getElementById('totalCombinations');
            if (totalCount) totalCount.textContent = total;
        }

        // Navigate between draft steps
        function goToDraftStep(step) {
            currentDraftStep = step;

            // Hide list selector and all sections
            document.getElementById('draftListSelector').style.display = 'none';
            document.getElementById('draftSection1').style.display = 'none';
            document.getElementById('draftSection2').style.display = 'none';
            document.getElementById('draftSection3').style.display = 'none';
            document.getElementById('draftSection4').style.display = 'none';
            document.getElementById('draftSuccess').style.display = 'none';

            // Show current section
            if (step === 0) {
                document.getElementById('draftListSelector').style.display = 'block';
            } else {
                document.getElementById(`draftSection${step}`).style.display = 'block';
            }

            // Update step indicators
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`draftStep${i}`);
                if (stepEl) {
                    const circle = stepEl.querySelector('div');
                    if (i <= step) {
                        stepEl.style.color = '#667eea';
                        circle.style.background = '#667eea';
                        circle.style.color = 'white';
                    } else {
                        stepEl.style.color = '#999';
                        circle.style.background = '#eee';
                        circle.style.color = '#666';
                    }
                }
            }

            // Step-specific updates
            if (step === 2) {
                updateCampaignNamePreview();
            }
            if (step === 3 && !creativesAutoGenerated) {
                // Auto-generate creatives on first visit to step 3
                creativesAutoGenerated = true;
                // Set default prompt from template
                changePromptTemplate();
                // Auto-trigger image generation and ad copy after a short delay
                setTimeout(() => {
                    generateDraftImages();
                    generateDraftAdCopy();
                }, 500);
            }
            if (step === 4) {
                updateReviewPage();
            }
        }

        // Validate creatives selection before going to review step
        function validateAndGoToStep4() {
            const titlesCount = selectedTitles?.size || 0;
            const descCount = selectedDescriptions?.size || 0;
            const postCount = selectedPostTexts?.size || 0;
            const totalTexts = titlesCount + descCount + postCount;

            const errors = [];
            if (selectedImages.size < 1) {
                errors.push('• Select at least 1 image');
            }
            if (totalTexts < 3) {
                errors.push('• Select at least 3 text items (titles, descriptions, or post texts)');
            }

            if (errors.length > 0) {
                alert('Please complete the following before proceeding:\n\n' + errors.join('\n'));
                return;
            }

            goToDraftStep(4);
        }

        // Update the review page (step 4)
        function updateReviewPage() {
            // Campaign summary
            document.getElementById('reviewCampaignName').textContent = document.getElementById('campaignNamePreview')?.value || '-';
            document.getElementById('reviewObjective').textContent = document.getElementById('campaignObjective')?.options[document.getElementById('campaignObjective').selectedIndex]?.text || 'Conversions';
            document.getElementById('reviewBudget').textContent = '$' + (document.getElementById('dailyBudget')?.value || '20');
            document.getElementById('reviewAudience').textContent = document.getElementById('targetAudience')?.options[document.getElementById('targetAudience').selectedIndex]?.text || 'Broad';
            document.getElementById('reviewListName').textContent = currentDraftList?.name || '-';

            // Creative summary - new multi-select format
            const titlesCount = selectedTitles?.size || 0;
            const descCount = selectedDescriptions?.size || 0;
            const postCount = selectedPostTexts?.size || 0;

            document.getElementById('reviewImagesCount').textContent = selectedImages.size;
            document.getElementById('reviewTitlesCount').textContent = titlesCount;
            document.getElementById('reviewDescCount').textContent = descCount;
            document.getElementById('reviewPostCount').textContent = postCount;

            // Calculate total combinations
            let total = 0;
            if (selectedImages.size > 0 && (titlesCount > 0 || descCount > 0 || postCount > 0)) {
                total = selectedImages.size * Math.max(1, titlesCount) * Math.max(1, descCount) * Math.max(1, postCount);
            }
            document.getElementById('reviewTotalAds').textContent = total;
            document.getElementById('reviewProductCount').textContent = currentDraftList?.products || currentDraftProducts.length || 0;

            // Warnings
            const warningsDiv = document.getElementById('reviewWarnings');
            const warningText = document.getElementById('reviewWarningText');
            const hasAdCopy = titlesCount > 0 || descCount > 0 || postCount > 0;
            if (selectedImages.size === 0 || !hasAdCopy) {
                warningsDiv.style.display = 'block';
                warningText.textContent = 'Please go back and select at least one image and some ad copy (titles, descriptions, or post texts).';
            } else {
                warningsDiv.style.display = 'none';
            }

            // Reset confirmation checkbox
            const confirmCheckbox = document.getElementById('confirmUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            if (confirmCheckbox) {
                confirmCheckbox.checked = false;
                confirmCheckbox.onchange = () => {
                    const fbConnected = !!fbAccessToken;
                    uploadBtn.disabled = !confirmCheckbox.checked || selectedImages.size === 0 || !hasAdCopy || !fbConnected;
                    uploadBtn.style.opacity = uploadBtn.disabled ? '0.6' : '1';
                };
            }
        }

        // Update campaign name preview
        function updateCampaignNamePreview() {
            const template = document.getElementById('campaignNameTemplate')?.value || '{{storefront}}_{{list_name}}_{{date}}';
            const today = new Date().toISOString().split('T')[0];

            let preview = template
                .replace('{{storefront}}', currentDraftStorefront?.username || currentDraftStorefront?.id || 'storefront')
                .replace('{{list_name}}', (currentDraftList?.name || 'list').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30))
                .replace('{{date}}', today);

            const previewEl = document.getElementById('campaignNamePreview');
            if (previewEl) {
                previewEl.value = preview;
            }
        }

        // ========================================
        // FACEBOOK ADS API INTEGRATION
        // ========================================

        let fbAccessToken = null;
        let fbUserId = null;
        let fbInitialized = false;
        let fbPages = []; // User's Facebook Pages
        let selectedFbPageId = null;
        let selectedFbPageAccessToken = null;

        // Objective to Optimization Goal mapping
        const OBJECTIVE_TO_OPTIMIZATION = {
            'OUTCOME_SALES': 'OFFSITE_CONVERSIONS',
            'OUTCOME_LEADS': 'LEAD_GENERATION',
            'OUTCOME_TRAFFIC': 'LINK_CLICKS',
            'OUTCOME_AWARENESS': 'REACH',
            'OUTCOME_ENGAGEMENT': 'POST_ENGAGEMENT'
        };

        // Initialize Facebook SDK
        function initFacebookSDK() {
            if (fbInitialized) return;

            window.fbAsyncInit = function() {
                FB.init({
                    appId: window.FB_APP_ID,
                    cookie: true,
                    xfbml: true,
                    version: window.FB_API_VERSION || 'v21.0'
                });

                fbInitialized = true;

                // Check login status
                FB.getLoginStatus(function(response) {
                    handleFBLoginStatus(response);
                });
            };

            // Load SDK if not already loaded
            if (typeof FB === 'undefined') {
                (function(d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id)) return;
                    js = d.createElement(s); js.id = id;
                    js.src = "https://connect.facebook.net/en_US/sdk.js";
                    fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));
            } else {
                window.fbAsyncInit();
            }
        }

        // Handle FB login status
        function handleFBLoginStatus(response) {
            if (response.status === 'connected') {
                fbAccessToken = response.authResponse.accessToken;
                fbUserId = response.authResponse.userID;
                updateFBConnectionUI(true);
                fetchFBUserInfo();
                fetchFacebookPages(); // Fetch user's Pages for ad creative
            } else {
                fbAccessToken = null;
                fbUserId = null;
                fbPages = [];
                selectedFbPageId = null;
                selectedFbPageAccessToken = null;
                updateFBConnectionUI(false);
            }
        }

        // Update Facebook connection UI
        function updateFBConnectionUI(connected) {
            const statusEl = document.getElementById('fbConnectionStatus');
            const loginSection = document.getElementById('fbLoginSection');
            const connectedSection = document.getElementById('fbConnectedSection');
            const uploadBtn = document.getElementById('uploadBtn');
            const confirmCheckbox = document.getElementById('confirmUpload');

            // Step 2 page selector sections
            const pageLoginSection = document.getElementById('fbPageLoginSection');
            const pageSelectSection = document.getElementById('fbPageSelectSection');

            if (connected) {
                statusEl.textContent = 'Connected';
                statusEl.style.color = '#28a745';
                loginSection.style.display = 'none';
                connectedSection.style.display = 'block';

                // Show page selector, hide login button in Step 2
                if (pageLoginSection) pageLoginSection.style.display = 'none';
                if (pageSelectSection) pageSelectSection.style.display = 'block';

                // Enable upload button if confirmed
                if (confirmCheckbox && uploadBtn) {
                    uploadBtn.disabled = !confirmCheckbox.checked;
                    uploadBtn.style.opacity = confirmCheckbox.checked ? '1' : '0.6';
                }
            } else {
                statusEl.textContent = 'Not connected';
                statusEl.style.color = '#666';
                loginSection.style.display = 'block';
                connectedSection.style.display = 'none';

                // Show login button, hide page selector in Step 2
                if (pageLoginSection) pageLoginSection.style.display = 'flex';
                if (pageSelectSection) pageSelectSection.style.display = 'none';

                // Disable upload button
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                    uploadBtn.style.opacity = '0.6';
                }
            }
        }

        // Fetch Facebook user info
        function fetchFBUserInfo() {
            if (!fbAccessToken) return;

            FB.api('/me', { fields: 'name,picture' }, function(response) {
                if (response && !response.error) {
                    document.getElementById('fbUserName').textContent = response.name;
                    if (response.picture && response.picture.data) {
                        document.getElementById('fbUserPic').src = response.picture.data.url;
                    }
                }
            });
        }

        // Fetch Facebook Pages the user manages
        function fetchFacebookPages() {
            if (!fbAccessToken) return;

            FB.api('/me/accounts', { access_token: fbAccessToken }, function(response) {
                if (response && response.data && response.data.length > 0) {
                    fbPages = response.data;
                    populateFacebookPageSelector();
                    console.log('Facebook Pages loaded:', fbPages.length);
                } else {
                    console.log('No Facebook Pages found or error:', response?.error);
                    fbPages = [];
                }
            });
        }

        // Populate Facebook Page dropdown in Campaign Setup
        function populateFacebookPageSelector() {
            const select = document.getElementById('fbPageSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Select a Page...</option>';

            fbPages.forEach(page => {
                const option = document.createElement('option');
                option.value = page.id;
                option.textContent = page.name;
                option.dataset.accessToken = page.access_token;
                select.appendChild(option);
            });

            // Auto-select first page if only one
            if (fbPages.length === 1) {
                select.value = fbPages[0].id;
                handleFbPageChange();
            }
        }

        // Handle Facebook Page selection change
        function handleFbPageChange() {
            const select = document.getElementById('fbPageSelect');
            if (!select || !select.value) {
                selectedFbPageId = null;
                selectedFbPageAccessToken = null;
                return;
            }

            selectedFbPageId = select.value;
            const selectedOption = select.options[select.selectedIndex];
            selectedFbPageAccessToken = selectedOption.dataset.accessToken;
            console.log('Selected FB Page:', selectedFbPageId);
        }

        // Login to Facebook
        function loginToFacebook() {
            if (!fbInitialized) {
                initFacebookSDK();
                setTimeout(loginToFacebook, 1000);
                return;
            }

            FB.login(function(response) {
                handleFBLoginStatus(response);
            }, {
                scope: 'ads_management,ads_read,business_management,pages_read_engagement,pages_show_list'
            });
        }

        // Logout from Facebook
        function logoutFromFacebook() {
            FB.logout(function(response) {
                fbAccessToken = null;
                fbUserId = null;
                updateFBConnectionUI(false);
            });
        }

        // Upload campaign to Facebook
        async function uploadToFacebook() {
            const titlesCount = selectedTitles?.size || 0;
            const descCount = selectedDescriptions?.size || 0;
            const postCount = selectedPostTexts?.size || 0;
            const hasAdCopy = titlesCount > 0 || descCount > 0 || postCount > 0;

            if (selectedImages.size === 0 || !hasAdCopy) {
                alert('Please select at least one image and some ad copy (titles, descriptions, or post texts)');
                return;
            }

            if (!fbAccessToken) {
                alert('Please connect your Facebook account first');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const originalBtnText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>Uploading...';

            try {
                // Validate Facebook Page is selected
                if (!selectedFbPageId) {
                    throw new Error('Please select a Facebook Page in Campaign Setup (Step 2)');
                }

                // 1. Create Campaign
                let campaignName = document.getElementById('campaignNamePreview')?.value || `Campaign_${Date.now()}`;
                // Add [Auto-List] prefix for tracking
                if (!campaignName.includes('[Auto-List]')) {
                    campaignName = '[Auto-List] ' + campaignName;
                }
                const objective = document.getElementById('campaignObjective')?.value || 'OUTCOME_TRAFFIC';

                const campaign = await createFBCampaign(campaignName, objective);
                console.log('Campaign created:', campaign);

                // 2. Create Ad Set
                const dailyBudget = parseFloat(document.getElementById('dailyBudget')?.value || '20') * 100; // Convert to cents
                const adSet = await createFBAdSet(campaign.id, campaignName + '_AdSet', dailyBudget, objective);
                console.log('Ad Set created:', adSet);

                // 3. Upload images and create ad creatives
                const selectedImagesArray = Array.from(selectedImages);
                const selectedTitlesArray = Array.from(selectedTitles);
                const selectedDescArray = Array.from(selectedDescriptions);
                const selectedPostArray = Array.from(selectedPostTexts);

                let adsCreated = 0;

                for (const imageId of selectedImagesArray) {
                    // Find the image data
                    const imageIndex = parseInt(imageId) - 1;
                    const imageData = generatedImages[imageIndex]?.data;

                    if (!imageData) continue;

                    // Upload image to Facebook
                    const imageHash = await uploadFBImage(imageData);
                    console.log('Image uploaded, hash:', imageHash);

                    // Create ad for each combination of title/desc/post
                    const title = selectedTitlesArray[0] || currentDraftList?.name || 'Shop Now';
                    const description = selectedDescArray[0] || '';
                    const postText = selectedPostArray[0] || '';
                    const linkUrl = currentDraftList?.url || 'https://www.amazon.com';

                    // Create ad creative
                    const creative = await createFBAdCreative(imageHash, title, description, postText, linkUrl);
                    console.log('Creative created:', creative);

                    // Create ad
                    const ad = await createFBAd(adSet.id, creative.id, `${campaignName}_Ad_${adsCreated + 1}`);
                    console.log('Ad created:', ad);

                    adsCreated++;
                }

                // Success - show success screen
                document.getElementById('draftSection4').style.display = 'none';
                document.getElementById('draftSuccess').style.display = 'block';

                document.getElementById('finalCampaignName').textContent = campaignName;
                document.getElementById('finalBudget').textContent = document.getElementById('dailyBudget')?.value || '20';
                document.getElementById('finalAdsCount').textContent = adsCreated;

                // Save the uploaded list ID for tracking
                if (currentDraftList?.id) {
                    saveUploadedListId(currentDraftList.id);
                }

            } catch (error) {
                console.error('Facebook upload error:', error);
                alert('Error uploading to Facebook: ' + (error.message || 'Unknown error'));
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalBtnText;
            }
        }

        // Create Facebook Campaign
        async function createFBCampaign(name, objective) {
            const adAccountId = window.FB_AD_ACCOUNT_ID;

            const campaignParams = {
                name: name,
                objective: objective,
                status: 'PAUSED',
                special_ad_categories: [],
                // Use ad set level budgets (not campaign budget optimization)
                // Disable budget sharing between ad sets
                is_adset_budget_sharing_enabled: false,
                access_token: fbAccessToken
            };

            console.log('Creating Campaign with params:', campaignParams);

            return new Promise((resolve, reject) => {
                FB.api(
                    `/${adAccountId}/campaigns`,
                    'POST',
                    campaignParams,
                    function(response) {
                        console.log('Campaign API response:', response);
                        if (response && !response.error) {
                            resolve(response);
                        } else {
                            const errorMsg = response?.error?.error_user_msg || response?.error?.message || 'Failed to create campaign';
                            reject(new Error(errorMsg));
                        }
                    }
                );
            });
        }

        // Create Facebook Ad Set
        async function createFBAdSet(campaignId, name, dailyBudget, objective) {
            const adAccountId = window.FB_AD_ACCOUNT_ID;

            // Set start time to tomorrow to avoid "start time in the past" errors
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            tomorrow.setHours(0, 0, 0, 0);
            const startTime = Math.floor(tomorrow.getTime() / 1000);
            const endTime = startTime + (30 * 24 * 60 * 60);

            // Get selected countries from UI
            const selectedCountries = Array.from(
                document.querySelectorAll('#targetCountries input:checked')
            ).map(cb => cb.value);

            // Default to US if nothing selected
            const countries = selectedCountries.length > 0 ? selectedCountries : ['US'];

            // Get selected performance goal from UI
            const optimizationGoal = document.getElementById('performanceGoal')?.value || 'OFFSITE_CONVERSIONS';

            // Get age range from UI
            const ageMin = parseInt(document.getElementById('ageMin')?.value) || 18;
            const ageMax = parseInt(document.getElementById('ageMax')?.value) || 65;

            // Get gender from UI (all = no filter, 1 = male, 2 = female)
            const genderValue = document.querySelector('input[name="gender"]:checked')?.value;
            const genders = genderValue === 'all' ? [1, 2] : [parseInt(genderValue)];

            // Get device targeting from UI
            const deviceValue = document.querySelector('input[name="devices"]:checked')?.value;

            // Build targeting object
            const targeting = {
                geo_locations: {
                    countries: countries
                },
                age_min: ageMin,
                age_max: ageMax,
                genders: genders
            };

            // Add device targeting if not "all"
            if (deviceValue === 'mobile') {
                targeting.device_platforms = ['mobile'];
                targeting.publisher_platforms = ['facebook', 'instagram'];
                targeting.facebook_positions = ['feed', 'story'];
                targeting.instagram_positions = ['stream', 'story'];
            } else if (deviceValue === 'desktop') {
                targeting.device_platforms = ['desktop'];
                targeting.publisher_platforms = ['facebook'];
                targeting.facebook_positions = ['feed', 'right_hand_column'];
            }

            const adSetParams = {
                name: name,
                campaign_id: campaignId,
                daily_budget: dailyBudget,
                billing_event: 'IMPRESSIONS',
                optimization_goal: optimizationGoal,
                bid_strategy: 'LOWEST_COST_WITHOUT_CAP',
                is_dynamic_creative: false,
                targeting: targeting,
                status: 'PAUSED',
                start_time: startTime,
                end_time: endTime,
                access_token: fbAccessToken
            };

            console.log('Creating Ad Set with params:', adSetParams);

            return new Promise((resolve, reject) => {
                FB.api(
                    `/${adAccountId}/adsets`,
                    'POST',
                    adSetParams,
                    function(response) {
                        console.log('Ad Set API response:', response);
                        if (response && !response.error) {
                            resolve(response);
                        } else {
                            reject(new Error(response?.error?.message || 'Failed to create ad set'));
                        }
                    }
                );
            });
        }

        // Upload image to Facebook
        async function uploadFBImage(imageDataUrl) {
            const adAccountId = window.FB_AD_ACCOUNT_ID;

            // Convert data URL to blob
            const response = await fetch(imageDataUrl);
            const blob = await response.blob();

            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('filename', blob, 'ad_image.jpg');
                formData.append('access_token', fbAccessToken);

                fetch(`https://graph.facebook.com/${window.FB_API_VERSION}/${adAccountId}/adimages`, {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.images) {
                        const imageKey = Object.keys(data.images)[0];
                        resolve(data.images[imageKey].hash);
                    } else if (data.error) {
                        reject(new Error(data.error.message));
                    } else {
                        reject(new Error('Failed to upload image'));
                    }
                })
                .catch(reject);
            });
        }

        // Create Facebook Ad Creative
        async function createFBAdCreative(imageHash, title, description, postText, linkUrl) {
            const adAccountId = window.FB_AD_ACCOUNT_ID;

            // Use the selected Facebook Page ID (required for ad creatives)
            if (!selectedFbPageId) {
                throw new Error('No Facebook Page selected. Please select a Page in Campaign Setup.');
            }

            const creativeParams = {
                name: `Creative_${Date.now()}`,
                object_story_spec: {
                    page_id: selectedFbPageId,
                    link_data: {
                        image_hash: imageHash,
                        link: linkUrl,
                        message: postText || 'Check out these amazing products!',
                        name: title || 'Shop Now',
                        description: description || '',
                        call_to_action: {
                            type: 'SHOP_NOW',
                            value: {
                                link: linkUrl
                            }
                        }
                    }
                },
                access_token: fbAccessToken
            };

            console.log('Creating Ad Creative with params:', creativeParams);

            return new Promise((resolve, reject) => {
                FB.api(
                    `/${adAccountId}/adcreatives`,
                    'POST',
                    creativeParams,
                    function(response) {
                        console.log('Ad Creative API response:', response);
                        if (response && !response.error) {
                            resolve(response);
                        } else {
                            const errorMsg = response?.error?.error_user_msg || response?.error?.message || 'Failed to create ad creative';
                            reject(new Error(errorMsg));
                        }
                    }
                );
            });
        }

        // Create Facebook Ad
        async function createFBAd(adSetId, creativeId, name) {
            const adAccountId = window.FB_AD_ACCOUNT_ID;

            return new Promise((resolve, reject) => {
                FB.api(
                    `/${adAccountId}/ads`,
                    'POST',
                    {
                        name: name,
                        adset_id: adSetId,
                        creative: { creative_id: creativeId },
                        status: 'PAUSED',
                        access_token: fbAccessToken
                    },
                    function(response) {
                        if (response && !response.error) {
                            resolve(response);
                        } else {
                            reject(new Error(response?.error?.message || 'Failed to create ad'));
                        }
                    }
                );
            });
        }

        // Initialize FB SDK when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (window.FB_APP_ID) {
                initFacebookSDK();
            }
        });

        // Export draft list
        function exportDraftList() {
            if (!currentDraftList) return;

            const exportData = {
                list: currentDraftList,
                title: document.getElementById('draftFinalTitle').value,
                description: document.getElementById('draftFinalDesc').value,
                products: currentDraftProducts.map(p => ({
                    asin: p.asin,
                    title: p.title,
                    url: `https://www.amazon.com/dp/${p.asin}`,
                    price: p.price
                }))
            };

            downloadJSON(exportData, `draft-${currentDraftList.id}.json`);
        }

        // Back to lists
        function backToLists() {
            // Switch to lists tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.nav-tab[data-tab="lists"]').classList.add('active');
            document.getElementById('lists-tab').classList.add('active');

            // Reset draft state
            currentDraftList = null;
            currentDraftStorefront = null;
            currentDraftProducts = [];
            selectedImages = new Set();
            selectedTitles = new Set();
            selectedDescriptions = new Set();
            selectedPostTexts = new Set();
            imagePromptHistory = [];
            adCopyPromptHistory = [];
            creativesAutoGenerated = false; // Reset auto-generation flag
        }

        // Override tab switching for draft tab
        function handleDraftTabClick() {
            // If no list selected, show selector
            if (!currentDraftList) {
                showDraftSelector();
            }
            // Otherwise keep current state
        }

        // Add event listeners after data loads
        function setupDraftEventListeners() {
            const templateInput = document.getElementById('campaignNameTemplate');
            if (templateInput) {
                templateInput.addEventListener('input', updateCampaignNamePreview);
            }

            // Override draft tab click
            const draftTab = document.getElementById('draftTab');
            if (draftTab) {
                draftTab.addEventListener('click', (e) => {
                    // Only trigger if clicking the draft tab itself
                    if (e.target === draftTab || e.target.parentElement === draftTab) {
                        handleDraftTabClick();
                    }
                });
            }
        }

        // Initialize draft tab when data is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for data to load, then init
            setTimeout(() => {
                initDraftTab();
                setupDraftEventListeners();
            }, 500);
        });
    </script>
    </div><!-- End mainApp -->

    <script>
        // Login credentials
        const VALID_USER = 'snir';
        const VALID_PASS = 'snir';

        // Check if already logged in
        if (sessionStorage.getItem('loggedIn') === 'true') {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (username === VALID_USER && password === VALID_PASS) {
                sessionStorage.setItem('loggedIn', 'true');
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginPassword').value = '';
            }
            return false;
        }

        // ========================================
        // SCRAPING STATUS & CONTROL
        // ========================================

        const SCRAPER_SERVER = 'http://localhost:3001';
        const SERPAPI_COST_PER_SEARCH = 0.01; // $50/5000 = $0.01 per search
        let scrapingPollInterval = null;

        // Check scraping status on load and periodically
        async function checkScrapingStatus() {
            try {
                // First check Supabase for status (works even without local server)
                const { data, error } = await supabaseClient
                    .from('scraping_status')
                    .select('*')
                    .eq('id', 1)
                    .single();

                if (data) {
                    updateScrapingUI(data);
                }
            } catch (e) {
                // Server not available, show offline
                updateScrapingUI({ is_active: false });
            }
        }

        function updateScrapingUI(status) {
            const dot = document.getElementById('scrapingDot');
            const statusText = document.getElementById('scrapingStatusText');
            const detail = document.getElementById('scrapingDetail');

            if (status.is_active) {
                dot.classList.add('active');
                statusText.textContent = 'Scraping';

                const progress = status.total_storefronts > 0
                    ? Math.round((status.processed / status.total_storefronts) * 100)
                    : 0;
                const eta = status.eta_seconds
                    ? `ETA: ${Math.floor(status.eta_seconds / 60)}m ${status.eta_seconds % 60}s`
                    : '';

                detail.textContent = `${status.processed || 0}/${status.total_storefronts || 0} (${progress}%) ${eta}`;
            } else {
                dot.classList.remove('active');
                statusText.textContent = 'Offline';
                detail.textContent = 'Click to start';
            }

            // Update modal if open
            updateScrapingModal(status);
        }

        function openScrapingModal() {
            const modal = document.getElementById('scrapingModal');
            modal.classList.add('show');
            checkScrapingStatus();
        }

        function closeScrapingModal() {
            const modal = document.getElementById('scrapingModal');
            modal.classList.remove('show');
        }

        function updateScrapingModal(status) {
            const modalBody = document.getElementById('scrapingModalBody');
            if (!modalBody) return;

            if (status.is_active) {
                const progress = status.total_storefronts > 0
                    ? Math.round((status.processed / status.total_storefronts) * 100)
                    : 0;
                const eta = status.eta_seconds
                    ? `${Math.floor(status.eta_seconds / 60)}m ${status.eta_seconds % 60}s`
                    : '-';

                let logs = [];
                try {
                    logs = typeof status.logs === 'string' ? JSON.parse(status.logs) : (status.logs || []);
                } catch (e) {
                    logs = [];
                }

                modalBody.innerHTML = `
                    <div class="scraping-stats-grid">
                        <div class="scraping-stat-card">
                            <div class="value">${status.processed || 0}</div>
                            <div class="label">Processed</div>
                        </div>
                        <div class="scraping-stat-card">
                            <div class="value">${status.success || 0}</div>
                            <div class="label">Success</div>
                        </div>
                        <div class="scraping-stat-card">
                            <div class="value">${status.lists_scraped || 0}</div>
                            <div class="label">Lists</div>
                        </div>
                        <div class="scraping-stat-card">
                            <div class="value">${eta}</div>
                            <div class="label">ETA</div>
                        </div>
                    </div>
                    <div class="scraping-progress-bar">
                        <div class="scraping-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <p style="margin-bottom: 10px; color: #666;">
                        <strong>Current:</strong> ${status.current_storefront || 'Waiting...'}
                    </p>
                    <div class="scraping-logs" id="scrapingLogs">
                        ${logs.slice(0, 50).map(log => `
                            <div class="log-entry ${log.type || ''}">
                                <span class="log-time">${new Date(log.time).toLocaleTimeString()}</span>
                                ${log.message}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-secondary" onclick="stopScraping()" style="background: #ef4444; color: white; border: none;">
                            Stop Scraping
                        </button>
                    </div>
                `;
            } else {
                modalBody.innerHTML = `
                    <div class="scraping-start-form">
                        <div class="scraping-form-group">
                            <label>Google Search Query</label>
                            <input type="text" id="scrapingQuery" value="site:amazon.com/shop/" placeholder="site:amazon.com/shop/">
                        </div>
                        <div class="scraping-form-group">
                            <label>Number of Searches</label>
                            <div class="scraping-presets">
                                <button class="scraping-preset-btn active" onclick="setSearchCount(50)">50</button>
                                <button class="scraping-preset-btn" onclick="setSearchCount(100)">100</button>
                                <button class="scraping-preset-btn" onclick="setSearchCount(250)">250</button>
                                <button class="scraping-preset-btn" onclick="setSearchCount(500)">500</button>
                            </div>
                            <input type="number" id="scrapingSearchCount" value="50" min="1" max="1000" style="margin-top: 10px;">
                        </div>
                        <div class="scraping-cost-estimate">
                            <strong>Estimated Cost:</strong>
                            <span class="cost-value" id="scrapingCostEstimate">$0.50</span>
                            <span style="color: #666;"> (SerpAPI: $0.01/search)</span>
                            <br>
                            <span style="font-size: 12px; color: #666;">
                                ~<span id="estimatedStorefronts">500</span> new storefronts expected
                            </span>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="startScraping()" style="font-size: 16px; padding: 15px 40px;">
                                🚀 Start Scraping
                            </button>
                        </div>
                        <p style="margin-top: 15px; font-size: 12px; color: #888; text-align: center;">
                            Make sure the scraper server is running: <code>node scripts/scraper-server.js</code>
                        </p>
                    </div>
                `;
            }
        }

        function setSearchCount(count) {
            document.getElementById('scrapingSearchCount').value = count;
            document.querySelectorAll('.scraping-preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent == count);
            });
            updateCostEstimate();
        }

        function updateCostEstimate() {
            const count = parseInt(document.getElementById('scrapingSearchCount')?.value || 50);
            const cost = (count * SERPAPI_COST_PER_SEARCH).toFixed(2);
            const storefronts = count * 10; // ~10 storefronts per search

            const costEl = document.getElementById('scrapingCostEstimate');
            const storefrontsEl = document.getElementById('estimatedStorefronts');

            if (costEl) costEl.textContent = '$' + cost;
            if (storefrontsEl) storefrontsEl.textContent = storefronts;
        }

        async function startScraping() {
            const searches = parseInt(document.getElementById('scrapingSearchCount').value) || 50;
            const query = document.getElementById('scrapingQuery').value || 'site:amazon.com/shop/';

            try {
                const response = await fetch(SCRAPER_SERVER + '/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ searches, query })
                });

                const result = await response.json();

                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    // Start polling for updates
                    if (scrapingPollInterval) clearInterval(scrapingPollInterval);
                    scrapingPollInterval = setInterval(checkScrapingStatus, 2000);
                    checkScrapingStatus();
                }
            } catch (e) {
                alert('Could not connect to scraper server. Make sure it is running:\n\nnode scripts/scraper-server.js');
            }
        }

        async function stopScraping() {
            if (!confirm('Are you sure you want to stop scraping?')) return;

            try {
                await fetch(SCRAPER_SERVER + '/stop', { method: 'POST' });
                if (scrapingPollInterval) {
                    clearInterval(scrapingPollInterval);
                    scrapingPollInterval = null;
                }
                checkScrapingStatus();
            } catch (e) {
                alert('Could not connect to scraper server');
            }
        }

        // Check status on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkScrapingStatus();
            // Poll every 5 seconds
            setInterval(checkScrapingStatus, 5000);
        });
    </script>

    <!-- Scraping Modal -->
    <div class="scraping-modal" id="scrapingModal" onclick="if(event.target === this) closeScrapingModal()">
        <div class="scraping-modal-content">
            <div class="scraping-modal-header">
                <h2>🔄 Scraping Control</h2>
                <button class="scraping-modal-close" onclick="closeScrapingModal()">&times;</button>
            </div>
            <div class="scraping-modal-body" id="scrapingModalBody">
                <!-- Dynamic content loaded here -->
            </div>
        </div>
    </div>
</body>
</html>
