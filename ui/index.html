<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Storefronts Manager</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Config (Supabase credentials) -->
    <script src="/ui/config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 500;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            padding: 0 30px;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px 30px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 15px;
            width: 300px;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 14px;
        }

        .search-box svg {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            color: #999;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9ff;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .ad-copy-item:hover {
            border-color: #667eea !important;
            background: #fafbff !important;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: #eef0f2;
        }

        th .sort-icon {
            margin-left: 5px;
            opacity: 0.3;
        }

        th.sorted .sort-icon {
            opacity: 1;
        }

        tr:hover {
            background: #f8f9ff;
        }

        td {
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #e7f1ff;
            color: #0056b3;
        }

        .likes-count {
            font-weight: 600;
            color: #e91e63;
        }

        .creator-link {
            color: #667eea;
            text-decoration: none;
        }

        .creator-link:hover {
            text-decoration: underline;
        }

        .checkbox-cell {
            width: 40px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination-btn:hover {
            background: #f5f5f5;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .selected-count {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-left: 10px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            border: 2px dashed #ddd;
        }

        .upload-section h3 {
            margin-bottom: 15px;
            color: #666;
        }

        .upload-section p {
            color: #999;
            margin-bottom: 20px;
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 14px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover, .filter-chip.active {
            background: #667eea;
            color: white;
        }

        .truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Amazon Storefronts Manager</h1>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalStorefronts">-</div>
                <div class="stat-label">Storefronts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalLists">-</div>
                <div class="stat-label">Lists</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalLikes">-</div>
                <div class="stat-label">Total Likes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="topCreators">-</div>
                <div class="stat-label">Top Creators</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalProducts">-</div>
                <div class="stat-label">Products</div>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" data-tab="storefronts">Storefronts</div>
        <div class="nav-tab" data-tab="lists">Lists</div>
        <div class="nav-tab" data-tab="products">Products</div>
        <div class="nav-tab" data-tab="draft" id="draftTab">Draft</div>
        <a href="import.html" class="nav-tab" style="margin-left: auto; text-decoration: none;">Import Data</a>
    </div>

    <!-- Storefronts Tab -->
    <div id="storefronts-tab" class="tab-content active">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="storefrontSearch" placeholder="Search storefronts...">
                    </div>
                    <div class="filter-chips">
                        <div class="filter-chip active" data-filter="all">All</div>
                        <div class="filter-chip" data-filter="top">Top Creators</div>
                        <div class="filter-chip" data-filter="high-likes">High Likes (100+)</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="exportStorefronts()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="storefrontsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="selectAllStorefronts"></th>
                            <th data-sort="username">Username <span class="sort-icon">↕</span></th>
                            <th data-sort="name">Creator Name <span class="sort-icon">↕</span></th>
                            <th data-sort="isTop">Top Creator <span class="sort-icon">↕</span></th>
                            <th data-sort="likes">Storefront Likes <span class="sort-icon">↕</span></th>
                            <th data-sort="lists">Lists <span class="sort-icon">↕</span></th>
                            <th data-sort="totalListLikes">Total List Likes <span class="sort-icon">↕</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="storefrontsBody">
                        <tr><td colspan="8" class="loading"><div class="loading-spinner"></div>Loading storefronts...</td></tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="pagination-info" id="storefrontsPaginationInfo">Showing 0-0 of 0</div>
                    <div class="pagination-controls" id="storefrontsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lists Tab -->
    <div id="lists-tab" class="tab-content">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="listSearch" placeholder="Search lists...">
                    </div>
                    <select id="storefrontFilter" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">All Storefronts</option>
                    </select>
                </div>
                <div class="btn-group">
                    <span id="selectedListsCount" class="selected-count" style="display: none;">0 selected</span>
                    <button class="btn btn-primary" onclick="exportSelectedLists()" id="exportSelectedBtn" style="display: none;">
                        Export Selected
                    </button>
                    <button class="btn btn-secondary" onclick="exportLists()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export All CSV
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="listsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="selectAllLists"></th>
                            <th data-sort="storefront">Storefront <span class="sort-icon">↕</span></th>
                            <th data-sort="name">List Name <span class="sort-icon">↕</span></th>
                            <th data-sort="likes">Likes <span class="sort-icon">↕</span></th>
                            <th data-sort="products">Products <span class="sort-icon">↕</span></th>
                            <th>List URL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="listsBody">
                        <tr><td colspan="7" class="loading"><div class="loading-spinner"></div>Loading lists...</td></tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="pagination-info" id="listsPaginationInfo">Showing 0-0 of 0</div>
                    <div class="pagination-controls" id="listsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Tab -->
    <div id="products-tab" class="tab-content">
        <div class="container">
            <div class="toolbar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="productSearch" placeholder="Search products by ASIN or title...">
                    </div>
                    <select id="productStorefrontFilter" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">All Storefronts</option>
                    </select>
                    <select id="productListFilter" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">All Lists</option>
                    </select>
                </div>
                <div class="btn-group">
                    <span id="selectedProductsCount" class="selected-count" style="display: none;">0 selected</span>
                    <button class="btn btn-primary" onclick="exportSelectedProducts()" id="exportSelectedProductsBtn" style="display: none;">
                        Export Selected
                    </button>
                    <select id="productExportFormat" style="padding: 10px 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="txt">ASINs Only</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportAllProducts()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export All
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="selectAllProducts"></th>
                            <th data-sort="asin">ASIN <span class="sort-icon">↕</span></th>
                            <th data-sort="title">Product Title <span class="sort-icon">↕</span></th>
                            <th data-sort="price">Price <span class="sort-icon">↕</span></th>
                            <th data-sort="storefront">Storefront <span class="sort-icon">↕</span></th>
                            <th>Amazon URL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                        <tr><td colspan="7" class="loading"><div class="loading-spinner"></div>Loading products...</td></tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="pagination-info" id="productsPaginationInfo">Showing 0-0 of 0</div>
                    <div class="pagination-controls" id="productsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Draft Tab -->
    <div id="draft-tab" class="tab-content">
        <div class="container">
            <!-- Draft Step Indicator -->
            <div class="draft-steps" style="display: flex; justify-content: center; margin-bottom: 30px; gap: 0; flex-wrap: wrap;">
                <div class="draft-step active" id="draftStep1" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #667eea; position: relative;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">1</div>
                    <span>List Overview</span>
                </div>
                <div style="width: 30px; height: 2px; background: #ddd; align-self: center;"></div>
                <div class="draft-step" id="draftStep2" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #999;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">2</div>
                    <span>Campaign Setup</span>
                </div>
                <div style="width: 30px; height: 2px; background: #ddd; align-self: center;"></div>
                <div class="draft-step" id="draftStep3" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #999;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">3</div>
                    <span>Creatives</span>
                </div>
                <div style="width: 30px; height: 2px; background: #ddd; align-self: center;"></div>
                <div class="draft-step" id="draftStep4" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; color: #999;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">4</div>
                    <span>Review & Upload</span>
                </div>
            </div>

            <!-- List Selector (shown when no list selected) -->
            <div id="draftListSelector" class="table-container" style="margin-bottom: 20px;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee;">
                    <h2 style="font-size: 18px; font-weight: 600;">Select a List to Draft</h2>
                </div>
                <div style="padding: 25px;">
                    <p style="color: #666; margin-bottom: 20px;">Choose a list from your storefronts to start creating a Facebook campaign.</p>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; max-width: 800px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Storefront</label>
                            <select id="draftStorefrontSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" onchange="updateDraftListOptions()">
                                <option value="">Select storefront...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">List</label>
                            <select id="draftListSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" disabled>
                                <option value="">Select a storefront first...</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="startDraftFromSelector()" id="startDraftBtn" disabled>
                        Start Draft
                    </button>
                </div>
            </div>

            <!-- Step 1: List Overview -->
            <div id="draftSection1" class="table-container" style="margin-bottom: 20px;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 18px; font-weight: 600;">List Overview</h2>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 1 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h3 id="draftListTitle" style="font-size: 24px; margin-bottom: 10px;">Select a list</h3>
                            <p id="draftListDesc" style="color: #666; line-height: 1.6; margin-bottom: 15px;">Click "Draft" on any list to start creating a campaign.</p>
                            <div style="display: flex; gap: 20px; margin-top: 15px;">
                                <div style="text-align: center; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                                    <div id="draftProductCount" style="font-size: 24px; font-weight: 600; color: #667eea;">0</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Products</div>
                                </div>
                                <div style="text-align: center; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                                    <div id="draftListLikes" style="font-size: 24px; font-weight: 600; color: #667eea;">0</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Likes</div>
                                </div>
                                <div style="text-align: center; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                                    <div id="draftStorefront" style="font-size: 14px; font-weight: 600; color: #667eea;">-</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Storefront</div>
                                </div>
                            </div>
                        </div>
                        <div id="draftProductsPreview" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                            <p style="color: #999; text-align: center; padding: 20px;">No list selected</p>
                        </div>
                    </div>

                    <!-- AI Prompts Section -->
                    <div style="margin-top: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div onclick="toggleDraftPrompt('titlePrompt')" style="padding: 15px 20px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>AI Title & Description Generator</span>
                            <span id="titlePromptToggle" style="font-size: 20px; color: #999;">▼</span>
                        </div>
                        <div id="titlePromptBody" style="display: none; padding: 20px; border-top: 1px solid #e0e0e0;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">System Prompt for Title</label>
                                <textarea id="draftTitlePrompt" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px;">Generate 3 catchy titles for this Amazon product list. Keep under 60 characters. Make it engaging and highlight value.

List: {{list_name}}
Products: {{products}}</textarea>
                            </div>
                            <button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="generateDraftTitles()">Generate Titles</button>
                            <div id="generatedTitles" style="margin-top: 15px; display: none;"></div>

                            <div style="margin: 20px 0 15px; border-top: 1px solid #eee; padding-top: 20px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">System Prompt for Description</label>
                                <textarea id="draftDescPrompt" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px;">Generate 3 descriptions (2-3 sentences each) for this product list. Create urgency and highlight benefits.

List: {{list_name}}
Products: {{products}}</textarea>
                            </div>
                            <button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="generateDraftDescriptions()">Generate Descriptions</button>
                            <div id="generatedDescriptions" style="margin-top: 15px; display: none;"></div>
                        </div>
                    </div>

                    <!-- Editable Fields -->
                    <div style="margin-top: 25px;">
                        <h4 style="margin-bottom: 15px;">Final Title & Description</h4>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">List Title</label>
                            <input type="text" id="draftFinalTitle" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" value="">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">List Description</label>
                            <textarea id="draftFinalDesc" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="exportDraftList()">Export List</button>
                    <button class="btn btn-primary" onclick="goToDraftStep(2)">Next: Campaign Setup →</button>
                </div>
            </div>

            <!-- Step 2: Campaign Setup -->
            <div id="draftSection2" class="table-container" style="margin-bottom: 20px; display: none;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 18px; font-weight: 600;">Campaign Setup</h2>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 2 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <div style="max-width: 600px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Campaign Objective</label>
                            <select id="campaignObjective" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="CONVERSIONS">Conversions</option>
                                <option value="TRAFFIC">Traffic</option>
                                <option value="ENGAGEMENT">Engagement</option>
                                <option value="REACH">Reach</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Campaign Name Template</label>
                            <input type="text" id="campaignNameTemplate" value="{{storefront}}_{{list_name}}_{{date}}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <small style="color: #999;">Variables: {{storefront}}, {{list_name}}, {{date}}</small>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Preview Campaign Name</label>
                            <input type="text" id="campaignNamePreview" readonly style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Daily Budget ($)</label>
                            <input type="number" id="dailyBudget" value="20" min="1" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Target Audience</label>
                            <select id="targetAudience" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="broad">Broad - Let Facebook optimize</option>
                                <option value="interest">Interest-based targeting</option>
                                <option value="lookalike">Lookalike audience</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="goToDraftStep(1)">← Back</button>
                    <button class="btn btn-primary" onclick="goToDraftStep(3)">Next: Creatives →</button>
                </div>
            </div>

            <!-- Step 3: Facebook Creative -->
            <div id="draftSection3" class="table-container" style="margin-bottom: 20px; display: none;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 18px; font-weight: 600;">Facebook Creatives</h2>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 3 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <!-- Image Generation Section -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Ad Images</h3>
                        <div style="display: flex; gap: 10px;">
                            <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                Upload Images
                                <input type="file" id="uploadImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            </label>
                        </div>
                    </div>

                    <!-- Image Prompt Section -->
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <div onclick="toggleDraftPrompt('imagePrompt')" style="padding: 15px 20px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Image Generation Prompts (Nano Banana)</span>
                            <span id="imagePromptToggle" style="font-size: 20px; color: #999;">▼</span>
                        </div>
                        <div id="imagePromptBody" style="display: none; padding: 20px; border-top: 1px solid #e0e0e0;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Initial Prompt</label>
                            <textarea id="draftImagePrompt" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px;">Create a vibrant product collage for Facebook ads.
Style: Modern, clean, lifestyle photography
Background: Soft gradient (#f8f9fa to #e9ecef)
Include price tags and brand accents.

Products: {{products}}
Theme: {{list_name}}</textarea>
                            <div style="margin-top: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <select id="imageDimensions" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="1200x628">Facebook Feed (1200x628)</option>
                                    <option value="1080x1080">Square (1080x1080)</option>
                                    <option value="1080x1920">Story (1080x1920)</option>
                                </select>
                                <select id="imageCount" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="6">6 images</option>
                                    <option value="3">3 images</option>
                                    <option value="9">9 images</option>
                                </select>
                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="generateDraftImages()">Generate Images</button>
                            </div>

                            <!-- Follow-up Prompt Section -->
                            <div id="imageFollowupSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; display: none;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Refine Results (Follow-up Prompt)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="imageFollowupPrompt" placeholder="e.g., Make image 2 more colorful, add sale badge to image 4..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <button class="btn btn-secondary" onclick="refineImages()">Refine</button>
                                </div>
                                <div id="imagePromptHistory" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Images Grid (6 images) -->
                    <div id="draftImagesGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                        <!-- Placeholder images -->
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="1" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; padding: 10px; text-align: center;">Generate or upload</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 1</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="2" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 2</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="3" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 3</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="4" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 4</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="5" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 5</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div class="creative-card" onclick="toggleImageSelect(this)" data-image="6" style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer;">
                            <div style="height: 120px; background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px;">Waiting...</div>
                            <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px;"><strong>Image 6</strong></span><input type="checkbox" style="width: 16px; height: 16px;"></div>
                        </div>
                    </div>

                    <!-- Ad Copy Generation Section -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px;">
                        <h3>Ad Copy</h3>
                    </div>

                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <div onclick="toggleDraftPrompt('adCopyPrompt')" style="padding: 15px 20px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Ad Copy Generation Prompts</span>
                            <span id="adCopyPromptToggle" style="font-size: 20px; color: #999;">▼</span>
                        </div>
                        <div id="adCopyPromptBody" style="display: none; padding: 20px; border-top: 1px solid #e0e0e0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Titles Prompt</label>
                                    <textarea id="draftTitlesPrompt" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px;">Generate 5 ad titles (40 chars max). Punchy, attention-grabbing.

List: {{list_name}}</textarea>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Descriptions Prompt</label>
                                    <textarea id="draftDescriptionsPrompt" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px;">Generate 5 short descriptions (90 chars max). Highlight benefits.

List: {{list_name}}</textarea>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Post Texts Prompt</label>
                                    <textarea id="draftPostTextsPrompt" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px;">Generate 5 post texts (125 chars max). Hook + value prop + CTA.

List: {{list_name}}</textarea>
                                </div>
                            </div>
                            <button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="generateDraftAdCopy()">Generate All Ad Copy</button>

                            <!-- Follow-up Prompt Section -->
                            <div id="adCopyFollowupSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; display: none;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Refine Ad Copy (Follow-up Prompt)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="adCopyFollowupPrompt" placeholder="e.g., Make title 2 more urgent, add emoji to post text 3..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <button class="btn btn-secondary" onclick="refineAdCopy()">Refine</button>
                                </div>
                                <div id="adCopyPromptHistory" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Three Column Ad Copy Selection -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <!-- Titles Column -->
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #555;">Titles <span id="selectedTitlesCount" style="color: #667eea;">(0 selected)</span></h4>
                            <div id="adTitlesList" style="display: flex; flex-direction: column; gap: 8px;">
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                    <input type="checkbox" data-type="title" data-index="1" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Click "Generate" to create...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="2" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="3" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="4" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="title" data-index="5" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <!-- Custom Title -->
                                <div style="padding: 10px; border: 1px dashed #ddd; border-radius: 6px;">
                                    <input type="text" id="customTitle" placeholder="+ Add custom title..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                            </div>
                        </div>

                        <!-- Descriptions Column -->
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #555;">Descriptions <span id="selectedDescriptionsCount" style="color: #667eea;">(0 selected)</span></h4>
                            <div id="adDescriptionsList" style="display: flex; flex-direction: column; gap: 8px;">
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="1" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Click "Generate" to create...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="2" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="3" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="4" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="description" data-index="5" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <!-- Custom Description -->
                                <div style="padding: 10px; border: 1px dashed #ddd; border-radius: 6px;">
                                    <input type="text" id="customDescription" placeholder="+ Add custom description..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                            </div>
                        </div>

                        <!-- Post Texts Column -->
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #555;">Post Texts <span id="selectedPostTextsCount" style="color: #667eea;">(0 selected)</span></h4>
                            <div id="adPostTextsList" style="display: flex; flex-direction: column; gap: 8px;">
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="1" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Click "Generate" to create...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="2" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="3" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="4" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <label class="ad-copy-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" data-type="posttext" data-index="5" onchange="updateAdCopySelection()" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #999;">Waiting...</span>
                                </label>
                                <!-- Custom Post Text -->
                                <div style="padding: 10px; border: 1px dashed #ddd; border-radius: 6px;">
                                    <textarea id="customPostText" placeholder="+ Add custom post text..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-height: 40px;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selection Summary -->
                    <div style="margin-top: 25px; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <strong>Selected:</strong>
                                <span id="selectedImagesCount" style="margin-left: 10px;">0</span> images ×
                                <span id="selectedTitlesTotal" style="margin-left: 5px;">0</span> titles ×
                                <span id="selectedDescTotal" style="margin-left: 5px;">0</span> descriptions ×
                                <span id="selectedPostTotal" style="margin-left: 5px;">0</span> post texts
                                = <span id="totalCombinations" style="color: #667eea; font-weight: 600;">0</span> total ad combinations
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="goToDraftStep(2)">← Back</button>
                    <button class="btn btn-primary" onclick="goToDraftStep(4)">Next: Review & Upload →</button>
                </div>
            </div>

            <!-- Step 4: Review & Upload -->
            <div id="draftSection4" class="table-container" style="margin-bottom: 20px; display: none;">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 18px; font-weight: 600;">Review & Upload</h2>
                    <span style="background: #e7f1ff; color: #0056b3; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Step 4 of 4</span>
                </div>
                <div style="padding: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Left Column: Campaign Summary -->
                        <div>
                            <h3 style="margin-bottom: 20px; color: #333;">Campaign Summary</h3>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Campaign Name</label>
                                    <p id="reviewCampaignName" style="font-weight: 600; margin-top: 5px;">-</p>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Objective</label>
                                    <p id="reviewObjective" style="font-weight: 600; margin-top: 5px;">Conversions</p>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Daily Budget</label>
                                    <p id="reviewBudget" style="font-weight: 600; margin-top: 5px;">$20</p>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">Target Audience</label>
                                    <p id="reviewAudience" style="font-weight: 600; margin-top: 5px;">Broad</p>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; text-transform: uppercase;">List</label>
                                    <p id="reviewListName" style="font-weight: 600; margin-top: 5px;">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Creative Summary -->
                        <div>
                            <h3 style="margin-bottom: 20px; color: #333;">Creative Summary</h3>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <span>Images Selected</span>
                                    <strong id="reviewImagesCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Titles</span>
                                    <strong id="reviewTitlesCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Descriptions</span>
                                    <strong id="reviewDescCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <span>Post Texts</span>
                                    <strong id="reviewPostCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <span>Total Ad Combinations</span>
                                    <strong id="reviewTotalAds" style="color: #667eea;">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Products in List</span>
                                    <strong id="reviewProductCount">0</strong>
                                </div>
                            </div>

                            <!-- Warnings -->
                            <div id="reviewWarnings" style="margin-top: 15px; display: none;">
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px;">
                                    <strong style="color: #856404;">Warning:</strong>
                                    <p id="reviewWarningText" style="color: #856404; margin-top: 5px; font-size: 14px;"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Confirmation Checkbox -->
                    <div style="margin-top: 30px; padding: 20px; background: #e7f1ff; border-radius: 8px;">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="confirmUpload" style="margin-top: 3px; width: 18px; height: 18px;">
                            <span style="line-height: 1.5;">
                                I confirm that all campaign settings and creatives are correct. I understand that the campaign will be submitted to Facebook Ads Manager for review.
                            </span>
                        </label>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="goToDraftStep(3)">← Back to Creatives</button>
                    <button class="btn btn-success" id="uploadBtn" onclick="uploadToFacebook()" disabled style="opacity: 0.6;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17,8 12,3 7,8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Upload to Facebook
                    </button>
                </div>
            </div>

            <!-- Success State -->
            <div id="draftSuccess" class="table-container" style="display: none;">
                <div style="text-align: center; padding: 60px 40px;">
                    <div style="width: 80px; height: 80px; background: #d4edda; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                    </div>
                    <h2 style="color: #28a745; margin-bottom: 10px;">Campaign Created Successfully!</h2>
                    <p style="color: #666; margin-bottom: 30px;">Your campaign has been uploaded to Facebook Ads Manager.</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto 30px; text-align: left;">
                        <p><strong>Campaign:</strong> <span id="finalCampaignName">-</span></p>
                        <p><strong>Status:</strong> Pending Review</p>
                        <p><strong>Budget:</strong> $<span id="finalBudget">20</span>/day</p>
                        <p><strong>Ads Created:</strong> <span id="finalAdsCount">0</span></p>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="backToLists()">Back to Lists</button>
                        <button class="btn btn-primary" onclick="window.open('https://business.facebook.com/adsmanager', '_blank')">Open Ads Manager</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Lists Modal -->
    <div class="modal-overlay" id="viewListsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Lists for <span id="modalStorefrontName"></span></h2>
                <button class="modal-close" onclick="closeModal('viewListsModal')">&times;</button>
            </div>
            <div class="modal-body" id="modalListsBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewListsModal')">Close</button>
                <button class="btn btn-primary" onclick="exportModalLists()">Export These Lists</button>
            </div>
        </div>
    </div>

    <script>
        // Global data
        let storefronts = [];
        let lists = [];
        let products = [];
        let selectedLists = new Set();
        let selectedProducts = new Set();
        let currentStorefrontPage = 1;
        let currentListPage = 1;
        let currentProductPage = 1;
        const pageSize = 50;

        // Sort state
        let storefrontSort = { column: 'totalListLikes', direction: 'desc' };
        let listSort = { column: 'likes', direction: 'desc' };
        let productSort = { column: 'title', direction: 'asc' };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        // Global stats from JSON
        let globalStats = {};

        // Supabase configuration - set these for your project
        const SUPABASE_URL = window.SUPABASE_URL || '';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
        let supabase = null;

        // Initialize Supabase client
        function initSupabase() {
            if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return true;
            }
            return false;
        }

        // Load data from Supabase
        async function loadFromSupabase() {
            // Load storefronts
            const { data: storefrontsData, error: storefrontsError } = await supabase
                .from('storefronts')
                .select('*')
                .order('total_list_likes', { ascending: false });

            if (storefrontsError) throw storefrontsError;
            storefronts = storefrontsData.map(s => ({
                id: s.id,
                url: s.url,
                username: s.username,
                name: s.name,
                bio: s.bio,
                image: s.image,
                isTop: s.is_top,
                likes: s.likes,
                lists: s.lists,
                totalListLikes: s.total_list_likes,
                marketplace: s.marketplace
            }));

            // Load lists
            const { data: listsData, error: listsError } = await supabase
                .from('lists')
                .select('*')
                .order('likes', { ascending: false });

            if (listsError) throw listsError;
            lists = listsData.map(l => ({
                id: l.id,
                storefront: l.storefront_id,
                name: l.name,
                url: l.url,
                likes: l.likes,
                products: l.products
            }));

            // Load products
            const { data: productsData, error: productsError } = await supabase
                .from('products')
                .select('*')
                .order('position', { ascending: true });

            if (productsError) throw productsError;
            products = productsData.map(p => ({
                asin: p.asin,
                title: p.title,
                url: p.url,
                price: p.price,
                currency: p.currency,
                image: p.image,
                listId: p.list_id,
                storefront: p.storefront_id,
                position: p.position
            }));

            // Load stats
            const { data: statsData } = await supabase
                .from('stats')
                .select('*')
                .single();

            if (statsData) {
                globalStats = {
                    total: statsData.total_storefronts,
                    topCreators: statsData.top_creators,
                    totalLists: statsData.total_lists,
                    totalLikes: statsData.total_likes,
                    totalProducts: statsData.total_products,
                    lastUpdated: statsData.last_updated
                };
            } else {
                // Calculate from data if stats table is empty
                globalStats = {
                    total: storefronts.length,
                    topCreators: storefronts.filter(s => s.isTop).length,
                    totalLists: lists.length,
                    totalLikes: storefronts.reduce((sum, s) => sum + (s.totalListLikes || 0), 0),
                    totalProducts: products.length
                };
            }
        }

        // Load data from JSON files
        async function loadFromJSON() {
            const basePath = window.location.pathname.includes('/ui/') ? './data/' : '/ui/data/';

            // Load storefronts
            const storefrontsResponse = await fetch(basePath + 'storefronts.json');
            const storefrontsJSON = await storefrontsResponse.json();
            storefronts = storefrontsJSON.data;
            globalStats = storefrontsJSON.stats;

            // Load lists
            const listsResponse = await fetch(basePath + 'lists.json');
            const listsJSON = await listsResponse.json();
            lists = listsJSON.data;

            // Load products (if available)
            try {
                const productsResponse = await fetch(basePath + 'products.json');
                if (productsResponse.ok) {
                    const productsJSON = await productsResponse.json();
                    products = productsJSON.data || [];
                }
            } catch (e) {
                console.log('No products data available');
                products = [];
            }
        }

        // Main data loading function
        async function loadData() {
            try {
                // Try Supabase first
                if (initSupabase()) {
                    console.log('Loading data from Supabase...');
                    console.log('Supabase URL:', SUPABASE_URL);
                    try {
                        await loadFromSupabase();
                        console.log('Data loaded from Supabase');
                    } catch (supabaseError) {
                        console.error('Supabase error, falling back to JSON:', supabaseError);
                        await loadFromJSON();
                        console.log('Data loaded from JSON (fallback)');
                    }
                } else {
                    // Fallback to JSON files
                    console.log('Supabase not configured, loading from JSON files...');
                    await loadFromJSON();
                    console.log('Data loaded from JSON');
                }

                // Update stats from pre-calculated values
                updateStats();

                // Populate filter dropdowns
                populateStorefrontFilter();
                populateProductFilters();

                // Render tables
                renderStorefronts();
                renderLists();
                renderProducts();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('storefrontsBody').innerHTML =
                    '<tr><td colspan="8" class="empty-state">Error loading data: ' + error.message + '</td></tr>';
            }
        }

        // Update stats from pre-calculated JSON stats
        function updateStats() {
            document.getElementById('totalStorefronts').textContent = globalStats.total || storefronts.length;
            document.getElementById('totalLists').textContent = (globalStats.totalLists || lists.length).toLocaleString();
            document.getElementById('totalLikes').textContent = formatNumber(globalStats.totalLikes || 0);
            document.getElementById('topCreators').textContent = globalStats.topCreators || storefronts.filter(s => s.isTop).length;
            document.getElementById('totalProducts').textContent = formatNumber(globalStats.totalProducts || products.length);
        }

        // Format number
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        // Render storefronts table
        function renderStorefronts() {
            let filtered = [...storefronts];

            // Apply search
            const search = document.getElementById('storefrontSearch').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(s =>
                    s.username.toLowerCase().includes(search) ||
                    (s.name || '').toLowerCase().includes(search)
                );
            }

            // Apply filter
            const activeFilter = document.querySelector('.filter-chip.active')?.dataset.filter;
            if (activeFilter === 'top') {
                filtered = filtered.filter(s => s.isTop);
            } else if (activeFilter === 'high-likes') {
                filtered = filtered.filter(s => s.likes >= 100);
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[storefrontSort.column];
                let bVal = b[storefrontSort.column];

                // Handle numeric columns
                if (['likes', 'lists', 'totalListLikes'].includes(storefrontSort.column)) {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                if (aVal < bVal) return storefrontSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return storefrontSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Paginate
            const start = (currentStorefrontPage - 1) * pageSize;
            const paginated = filtered.slice(start, start + pageSize);

            // Render
            const tbody = document.getElementById('storefrontsBody');
            if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No storefronts found</td></tr>';
            } else {
                tbody.innerHTML = paginated.map(s => `
                    <tr>
                        <td class="checkbox-cell"><input type="checkbox" data-id="${s.id}"></td>
                        <td><a href="${s.url}" target="_blank" class="creator-link">${s.username}</a></td>
                        <td class="truncate">${s.name || '-'}</td>
                        <td>${s.isTop ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">No</span>'}</td>
                        <td class="likes-count">${formatNumber(s.likes || 0)}</td>
                        <td>${s.lists || 0}</td>
                        <td class="likes-count">${formatNumber(s.totalListLikes || 0)}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="viewLists('${s.id}')">
                                View Lists
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Update pagination
            renderPagination('storefronts', filtered.length, currentStorefrontPage);
        }

        // Render lists table
        function renderLists() {
            let filtered = [...lists];

            // Apply search
            const search = document.getElementById('listSearch').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(l =>
                    l.name.toLowerCase().includes(search) ||
                    l.storefront.toLowerCase().includes(search)
                );
            }

            // Apply storefront filter
            const storefrontFilter = document.getElementById('storefrontFilter').value;
            if (storefrontFilter) {
                filtered = filtered.filter(l => l.storefront === storefrontFilter);
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[listSort.column];
                let bVal = b[listSort.column];

                if (['likes', 'products'].includes(listSort.column)) {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                if (aVal < bVal) return listSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return listSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Paginate
            const start = (currentListPage - 1) * pageSize;
            const paginated = filtered.slice(start, start + pageSize);

            // Render
            const tbody = document.getElementById('listsBody');
            if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No lists found</td></tr>';
            } else {
                tbody.innerHTML = paginated.map(l => `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" data-id="${l.id}" ${selectedLists.has(l.id) ? 'checked' : ''}>
                        </td>
                        <td><a href="https://www.amazon.com/shop/${l.storefront}" target="_blank" class="creator-link">${l.storefront}</a></td>
                        <td class="truncate" title="${l.name}">${l.name}</td>
                        <td class="likes-count">${formatNumber(l.likes || 0)}</td>
                        <td>${l.products || 0}</td>
                        <td><a href="${l.url}" target="_blank" class="creator-link">Open</a></td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="addToExport('${l.id}')">
                                Export
                            </button>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="openDraft('${l.id}', '${l.storefront}')">
                                Draft
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Update pagination
            renderPagination('lists', filtered.length, currentListPage);
        }

        // Render products table
        function renderProducts() {
            let filtered = [...products];

            // Apply search
            const search = document.getElementById('productSearch')?.value?.toLowerCase() || '';
            if (search) {
                filtered = filtered.filter(p =>
                    (p.asin || '').toLowerCase().includes(search) ||
                    (p.title || '').toLowerCase().includes(search)
                );
            }

            // Apply storefront filter
            const storefrontFilter = document.getElementById('productStorefrontFilter')?.value || '';
            if (storefrontFilter) {
                filtered = filtered.filter(p => p.storefront === storefrontFilter);
            }

            // Apply list filter
            const listFilter = document.getElementById('productListFilter')?.value || '';
            if (listFilter) {
                filtered = filtered.filter(p => p.listId === listFilter);
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[productSort.column];
                let bVal = b[productSort.column];

                if (productSort.column === 'price') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return productSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return productSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Paginate
            const start = (currentProductPage - 1) * pageSize;
            const paginated = filtered.slice(start, start + pageSize);

            // Render
            const tbody = document.getElementById('productsBody');
            if (!tbody) return;

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No products scraped yet. Run scraper with products enabled.</td></tr>';
            } else if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No products found matching filters</td></tr>';
            } else {
                tbody.innerHTML = paginated.map(p => {
                    const amazonUrl = `https://www.amazon.com/dp/${p.asin}`;
                    const priceDisplay = p.price ? `$${p.price.toFixed(2)}` : '-';
                    const titleShort = (p.title || '').substring(0, 60) + ((p.title || '').length > 60 ? '...' : '');
                    return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" data-asin="${p.asin}" ${selectedProducts.has(p.asin) ? 'checked' : ''}>
                        </td>
                        <td><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${p.asin}</code></td>
                        <td class="truncate" title="${(p.title || '').replace(/"/g, '&quot;')}">${titleShort}</td>
                        <td>${priceDisplay}</td>
                        <td><a href="https://www.amazon.com/shop/${p.storefront}" target="_blank" class="creator-link">${p.storefront}</a></td>
                        <td><a href="${amazonUrl}" target="_blank" class="creator-link">Open</a></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectProduct('${p.asin}')">
                                + Select
                            </button>
                        </td>
                    </tr>
                `}).join('');
            }

            // Update pagination
            renderPagination('products', filtered.length, currentProductPage);
        }

        // Render pagination
        function renderPagination(type, total, currentPage) {
            const totalPages = Math.ceil(total / pageSize);
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);

            document.getElementById(`${type}PaginationInfo`).textContent =
                `Showing ${total > 0 ? start : 0}-${end} of ${total}`;

            const container = document.getElementById(`${type}Pagination`);
            let html = '';

            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage('${type}', ${currentPage - 1})">←</button>`;

            for (let i = 1; i <= totalPages && i <= 5; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage('${type}', ${i})">${i}</button>`;
            }

            if (totalPages > 5) {
                html += `<span style="padding: 8px;">...</span>`;
                html += `<button class="pagination-btn" onclick="goToPage('${type}', ${totalPages})">${totalPages}</button>`;
            }

            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage('${type}', ${currentPage + 1})">→</button>`;

            container.innerHTML = html;
        }

        // Go to page
        function goToPage(type, page) {
            if (type === 'storefronts') {
                currentStorefrontPage = page;
                renderStorefronts();
            } else if (type === 'lists') {
                currentListPage = page;
                renderLists();
            } else if (type === 'products') {
                currentProductPage = page;
                renderProducts();
            }
        }

        // Populate storefront filter
        function populateStorefrontFilter() {
            const select = document.getElementById('storefrontFilter');

            // JSON already contains only successful storefronts
            const sortedStorefronts = [...storefronts]
                .sort((a, b) => (b.totalListLikes || 0) - (a.totalListLikes || 0));

            sortedStorefronts.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.username} (${formatNumber(s.totalListLikes || 0)} likes)`;
                select.appendChild(option);
            });
        }

        // Populate product filters
        function populateProductFilters() {
            const storefrontSelect = document.getElementById('productStorefrontFilter');
            const listSelect = document.getElementById('productListFilter');
            if (!storefrontSelect || !listSelect) return;

            // Get unique storefronts from products
            const productStorefronts = [...new Set(products.map(p => p.storefront))];
            productStorefronts.sort().forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                storefrontSelect.appendChild(option);
            });

            // Get unique lists from products
            const productLists = [...new Set(products.map(p => p.listId))];
            productLists.forEach(listId => {
                const list = lists.find(l => l.id === listId);
                const option = document.createElement('option');
                option.value = listId;
                option.textContent = list ? list.name : listId;
                listSelect.appendChild(option);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });

            // Search
            document.getElementById('storefrontSearch').addEventListener('input', () => {
                currentStorefrontPage = 1;
                renderStorefronts();
            });

            document.getElementById('listSearch').addEventListener('input', () => {
                currentListPage = 1;
                renderLists();
            });

            // Storefront filter
            document.getElementById('storefrontFilter').addEventListener('change', () => {
                currentListPage = 1;
                renderLists();
            });

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentStorefrontPage = 1;
                    renderStorefronts();
                });
            });

            // Sort headers
            document.querySelectorAll('#storefrontsTable th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (storefrontSort.column === column) {
                        storefrontSort.direction = storefrontSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        storefrontSort.column = column;
                        storefrontSort.direction = 'desc';
                    }
                    renderStorefronts();
                });
            });

            document.querySelectorAll('#listsTable th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (listSort.column === column) {
                        listSort.direction = listSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        listSort.column = column;
                        listSort.direction = 'desc';
                    }
                    renderLists();
                });
            });

            // List checkboxes
            document.getElementById('listsBody').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const listId = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedLists.add(listId);
                    } else {
                        selectedLists.delete(listId);
                    }
                    updateSelectedCount();
                }
            });

            // Product search and filters
            const productSearch = document.getElementById('productSearch');
            if (productSearch) {
                productSearch.addEventListener('input', () => {
                    currentProductPage = 1;
                    renderProducts();
                });
            }

            const productStorefrontFilter = document.getElementById('productStorefrontFilter');
            if (productStorefrontFilter) {
                productStorefrontFilter.addEventListener('change', () => {
                    currentProductPage = 1;
                    // Update list filter based on storefront
                    const listFilter = document.getElementById('productListFilter');
                    const storefrontId = productStorefrontFilter.value;
                    listFilter.innerHTML = '<option value="">All Lists</option>';
                    if (storefrontId) {
                        const storefrontLists = lists.filter(l => l.storefront === storefrontId);
                        storefrontLists.forEach(l => {
                            const option = document.createElement('option');
                            option.value = l.id;
                            option.textContent = l.name;
                            listFilter.appendChild(option);
                        });
                    }
                    renderProducts();
                });
            }

            const productListFilter = document.getElementById('productListFilter');
            if (productListFilter) {
                productListFilter.addEventListener('change', () => {
                    currentProductPage = 1;
                    renderProducts();
                });
            }

            // Products table sorting
            document.querySelectorAll('#productsTable th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (productSort.column === column) {
                        productSort.direction = productSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        productSort.column = column;
                        productSort.direction = 'asc';
                    }
                    renderProducts();
                });
            });

            // Product checkboxes
            const productsBody = document.getElementById('productsBody');
            if (productsBody) {
                productsBody.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const asin = e.target.dataset.asin;
                        if (asin) {
                            if (e.target.checked) {
                                selectedProducts.add(asin);
                            } else {
                                selectedProducts.delete(asin);
                            }
                            updateSelectedProductsCount();
                        }
                    }
                });
            }

            // Select all products checkbox
            const selectAllProducts = document.getElementById('selectAllProducts');
            if (selectAllProducts) {
                selectAllProducts.addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('#productsBody input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                        const asin = cb.dataset.asin;
                        if (asin) {
                            if (e.target.checked) {
                                selectedProducts.add(asin);
                            } else {
                                selectedProducts.delete(asin);
                            }
                        }
                    });
                    updateSelectedProductsCount();
                });
            }
        }

        // Update selected count
        function updateSelectedCount() {
            const countEl = document.getElementById('selectedListsCount');
            const exportBtn = document.getElementById('exportSelectedBtn');

            if (selectedLists.size > 0) {
                countEl.textContent = `${selectedLists.size} selected`;
                countEl.style.display = 'inline';
                exportBtn.style.display = 'flex';
            } else {
                countEl.style.display = 'none';
                exportBtn.style.display = 'none';
            }
        }

        // Update selected products count
        function updateSelectedProductsCount() {
            const countEl = document.getElementById('selectedProductsCount');
            const exportBtn = document.getElementById('exportSelectedProductsBtn');

            if (selectedProducts.size > 0) {
                countEl.textContent = `${selectedProducts.size} selected`;
                countEl.style.display = 'inline';
                exportBtn.style.display = 'flex';
            } else {
                countEl.style.display = 'none';
                exportBtn.style.display = 'none';
            }
        }

        // Select a product
        function selectProduct(asin) {
            selectedProducts.add(asin);
            updateSelectedProductsCount();
            renderProducts();
        }

        // Export selected products
        function exportSelectedProducts() {
            const selected = products.filter(p => selectedProducts.has(p.asin));
            exportProductsData(selected, 'selected-products');
        }

        // Export all products (filtered)
        function exportAllProducts() {
            let filtered = [...products];

            // Apply current filters
            const search = document.getElementById('productSearch')?.value?.toLowerCase() || '';
            if (search) {
                filtered = filtered.filter(p =>
                    (p.asin || '').toLowerCase().includes(search) ||
                    (p.title || '').toLowerCase().includes(search)
                );
            }

            const storefrontFilter = document.getElementById('productStorefrontFilter')?.value || '';
            if (storefrontFilter) {
                filtered = filtered.filter(p => p.storefront === storefrontFilter);
            }

            const listFilter = document.getElementById('productListFilter')?.value || '';
            if (listFilter) {
                filtered = filtered.filter(p => p.listId === listFilter);
            }

            exportProductsData(filtered, 'products-export');
        }

        // Export products data in selected format
        function exportProductsData(data, filename) {
            const format = document.getElementById('productExportFormat')?.value || 'csv';

            if (format === 'txt') {
                // ASINs only
                const text = data.map(p => p.asin).join('\n');
                download(text, `${filename}-asins.txt`, 'text/plain');
            } else if (format === 'json') {
                // Full JSON
                const exportData = data.map(p => ({
                    asin: p.asin,
                    title: p.title,
                    url: `https://www.amazon.com/dp/${p.asin}`,
                    price: p.price,
                    currency: p.currency || 'USD',
                    storefront: p.storefront,
                    listId: p.listId
                }));
                downloadJSON(exportData, `${filename}.json`);
            } else {
                // CSV
                const exportData = data.map(p => ({
                    asin: p.asin,
                    product_title: p.title,
                    amazon_url: `https://www.amazon.com/dp/${p.asin}`,
                    price: p.price || '',
                    currency: p.currency || 'USD',
                    storefront_id: p.storefront,
                    list_id: p.listId
                }));
                downloadCSV(exportData, `${filename}.csv`);
            }
        }

        // View lists modal
        function viewLists(storefrontId) {
            const storefront = storefronts.find(s => s.id === storefrontId);
            const storefrontLists = lists.filter(l => l.storefront === storefrontId)
                .sort((a, b) => (b.likes || 0) - (a.likes || 0));

            document.getElementById('modalStorefrontName').textContent = storefront?.username || storefrontId;

            const body = document.getElementById('modalListsBody');
            body.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>List Name</th>
                            <th>Likes</th>
                            <th>Products</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${storefrontLists.map(l => `
                            <tr>
                                <td><a href="${l.url}" target="_blank" class="creator-link">${l.name}</a></td>
                                <td class="likes-count">${formatNumber(l.likes || 0)}</td>
                                <td>${l.products || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('viewListsModal').classList.add('active');
            window.currentModalStorefront = storefrontId;
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Export functions
        function exportStorefronts() {
            // JSON already contains only successful storefronts
            downloadCSV(storefronts, 'storefronts-export.csv');
        }

        function exportLists() {
            downloadCSV(lists, 'lists-export.csv');
        }

        function exportSelectedLists() {
            const selected = lists.filter(l => selectedLists.has(l.id));
            downloadCSV(selected, 'selected-lists-export.csv');
        }

        function exportModalLists() {
            const storefrontLists = lists.filter(l => l.storefront === window.currentModalStorefront);
            downloadCSV(storefrontLists, `${window.currentModalStorefront}-lists.csv`);
            closeModal('viewListsModal');
        }

        function addToExport(listId) {
            selectedLists.add(listId);
            updateSelectedCount();
            renderLists();
        }

        // Download helpers
        function downloadCSV(data, filename) {
            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            const csv = [
                '\uFEFF' + headers.join(','),
                ...data.map(row => headers.map(h => {
                    const val = row[h] || '';
                    return val.toString().includes(',') ? `"${val}"` : val;
                }).join(','))
            ].join('\n');

            download(csv, filename, 'text/csv');
        }

        function downloadJSON(data, filename) {
            download(JSON.stringify(data, null, 2), filename, 'application/json');
        }

        function downloadText(text, filename) {
            download(text, filename, 'text/plain');
        }

        function download(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // DRAFT WORKFLOW FUNCTIONS
        // ========================================

        let currentDraftList = null;
        let currentDraftStorefront = null;
        let currentDraftProducts = [];
        let selectedImages = new Set();
        let selectedAdCopy = new Set();
        let currentDraftStep = 0; // 0 = list selector, 1-4 = workflow steps

        // Initialize draft tab (populate list selector)
        function initDraftTab() {
            const storefrontSelect = document.getElementById('draftStorefrontSelect');
            if (!storefrontSelect) return;

            storefrontSelect.innerHTML = '<option value="">Select storefront...</option>';
            const sortedStorefronts = [...storefronts].sort((a, b) => (b.totalListLikes || 0) - (a.totalListLikes || 0));
            sortedStorefronts.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.username} (${s.lists || 0} lists)`;
                storefrontSelect.appendChild(option);
            });
        }

        // Update list options when storefront is selected
        function updateDraftListOptions() {
            const storefrontId = document.getElementById('draftStorefrontSelect').value;
            const listSelect = document.getElementById('draftListSelect');
            const startBtn = document.getElementById('startDraftBtn');

            if (!storefrontId) {
                listSelect.innerHTML = '<option value="">Select a storefront first...</option>';
                listSelect.disabled = true;
                startBtn.disabled = true;
                return;
            }

            const storefrontLists = lists.filter(l => l.storefront === storefrontId)
                .sort((a, b) => (b.likes || 0) - (a.likes || 0));

            listSelect.innerHTML = '<option value="">Select a list...</option>';
            storefrontLists.forEach(l => {
                const option = document.createElement('option');
                option.value = l.id;
                option.textContent = `${l.name} (${formatNumber(l.likes || 0)} likes, ${l.products || 0} products)`;
                listSelect.appendChild(option);
            });
            listSelect.disabled = false;

            listSelect.onchange = () => {
                startBtn.disabled = !listSelect.value;
            };
        }

        // Start draft from selector
        function startDraftFromSelector() {
            const storefrontId = document.getElementById('draftStorefrontSelect').value;
            const listId = document.getElementById('draftListSelect').value;
            if (storefrontId && listId) {
                openDraft(listId, storefrontId);
            }
        }

        // Open draft for a specific list
        function openDraft(listId, storefrontId) {
            // Find the list and storefront data
            const list = lists.find(l => l.id === listId);
            const storefront = storefronts.find(s => s.id === storefrontId);

            if (!list) {
                alert('List not found');
                return;
            }

            currentDraftList = list;
            currentDraftStorefront = storefront;
            currentDraftProducts = products.filter(p => p.listId === listId);

            // Reset state
            selectedImages = new Set();
            selectedAdCopy = new Set();

            // Hide list selector, show workflow
            document.getElementById('draftListSelector').style.display = 'none';

            // Populate Step 1 - List Overview
            document.getElementById('draftListTitle').textContent = list.name;
            document.getElementById('draftListDesc').textContent = `Curated collection from ${storefrontId} storefront`;
            document.getElementById('draftProductCount').textContent = list.products || currentDraftProducts.length;
            document.getElementById('draftListLikes').textContent = formatNumber(list.likes || 0);
            document.getElementById('draftStorefront').textContent = storefrontId;
            document.getElementById('draftFinalTitle').value = list.name;
            document.getElementById('draftFinalDesc').value = `Discover amazing products from ${storefrontId}'s ${list.name} collection.`;

            // Populate products preview
            const productsPreview = document.getElementById('draftProductsPreview');
            if (currentDraftProducts.length > 0) {
                productsPreview.innerHTML = currentDraftProducts.slice(0, 10).map(p => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee;">
                        <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${p.asin}</code>
                        <span style="font-size: 13px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${(p.title || '').substring(0, 40)}...</span>
                        ${p.price ? `<span style="font-size: 12px; color: #28a745;">$${p.price.toFixed(2)}</span>` : ''}
                    </div>
                `).join('') + (currentDraftProducts.length > 10 ? `<div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">+ ${currentDraftProducts.length - 10} more products</div>` : '');
            } else {
                productsPreview.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No products scraped for this list</p>';
            }

            // Go to step 1
            goToDraftStep(1);

            // Switch to draft tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('draftTab').classList.add('active');
            document.getElementById('draft-tab').classList.add('active');

            // Update campaign name preview
            updateCampaignNamePreview();
        }

        // Show draft tab without a list selected (show list selector)
        function showDraftSelector() {
            currentDraftList = null;
            currentDraftStorefront = null;
            currentDraftStep = 0;

            // Reset all selections
            selectedImages = new Set();
            selectedTitles = new Set();
            selectedDescriptions = new Set();
            selectedPostTexts = new Set();
            imagePromptHistory = [];
            adCopyPromptHistory = [];

            // Hide all workflow sections
            document.getElementById('draftSection1').style.display = 'none';
            document.getElementById('draftSection2').style.display = 'none';
            document.getElementById('draftSection3').style.display = 'none';
            document.getElementById('draftSection4').style.display = 'none';
            document.getElementById('draftSuccess').style.display = 'none';

            // Show list selector
            document.getElementById('draftListSelector').style.display = 'block';

            // Reset step indicators
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`draftStep${i}`);
                if (stepEl) {
                    const circle = stepEl.querySelector('div');
                    stepEl.style.color = '#999';
                    circle.style.background = '#eee';
                    circle.style.color = '#666';
                }
            }

            // Initialize dropdowns
            initDraftTab();
        }

        // Toggle collapsible prompt sections
        function toggleDraftPrompt(sectionId) {
            const body = document.getElementById(sectionId + 'Body');
            const toggle = document.getElementById(sectionId + 'Toggle');

            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.textContent = '▲';
            } else {
                body.style.display = 'none';
                toggle.textContent = '▼';
            }
        }

        // Generate mock titles
        function generateDraftTitles() {
            const listName = currentDraftList?.name || 'Product Collection';
            const container = document.getElementById('generatedTitles');

            // Mock AI-generated titles
            const titles = [
                `Top ${listName} Picks for 2025`,
                `Must-Have ${listName} Items`,
                `${listName} Essentials You'll Love`
            ];

            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h5 style="margin-bottom: 10px;">Generated Titles:</h5>
                    ${titles.map((t, i) => `
                        <label style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;"
                               onmouseover="this.style.background='#eee'" onmouseout="this.style.background='transparent'">
                            <input type="radio" name="titleChoice" value="${t}" onchange="document.getElementById('draftFinalTitle').value=this.value">
                            <span>${t}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            container.style.display = 'block';
        }

        // Generate mock descriptions
        function generateDraftDescriptions() {
            const listName = currentDraftList?.name || 'Product Collection';
            const container = document.getElementById('generatedDescriptions');

            // Mock AI-generated descriptions
            const descriptions = [
                `Discover our hand-picked ${listName} selection. Each item has been carefully chosen for quality and value. Shop now and transform your experience!`,
                `Looking for the best ${listName}? Our experts have curated this collection just for you. Don't miss out on these amazing deals!`,
                `Upgrade your life with these top-rated ${listName} products. Trusted by thousands of happy customers. Limited time offers available!`
            ];

            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h5 style="margin-bottom: 10px;">Generated Descriptions:</h5>
                    ${descriptions.map((d, i) => `
                        <label style="display: block; padding: 10px; cursor: pointer; border-radius: 4px; margin-bottom: 8px; border: 1px solid #eee;"
                               onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                            <input type="radio" name="descChoice" value="${d}" onchange="document.getElementById('draftFinalDesc').value=this.value" style="margin-right: 10px;">
                            <span style="font-size: 13px; line-height: 1.5;">${d}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            container.style.display = 'block';
        }

        // Image prompt history for refinement
        let imagePromptHistory = [];
        let adCopyPromptHistory = [];

        // Generate mock images (6 by default)
        function generateDraftImages() {
            const dimensions = document.getElementById('imageDimensions').value;
            const count = parseInt(document.getElementById('imageCount')?.value) || 6;
            const grid = document.getElementById('draftImagesGrid');

            // Mock image generation with placeholder gradients
            const imageStyles = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
                'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',
                'linear-gradient(135deg, #f6d365 0%, #fda085 100%)',
                'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)'
            ];

            const imageTypes = ['Product Collage', 'Lifestyle Shot', 'Deal Banner', 'Feature Highlight', 'Brand Story', 'Social Proof', 'Comparison', 'Seasonal', 'Testimonial'];

            // Store initial prompt in history
            const initialPrompt = document.getElementById('draftImagePrompt').value;
            if (imagePromptHistory.length === 0) {
                imagePromptHistory.push({ type: 'initial', prompt: initialPrompt });
            }

            grid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const style = imageStyles[i % imageStyles.length];
                const type = imageTypes[i % imageTypes.length];
                const isLight = i >= 3;

                grid.innerHTML += `
                    <div class="creative-card" onclick="toggleImageSelect(this)" data-image="${i + 1}"
                         style="border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s;">
                        <div style="height: 120px; background: ${style}; display: flex; align-items: center; justify-content: center; color: ${isLight ? '#666' : 'white'}; font-size: 12px; text-align: center; padding: 10px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 3px;">${type}</div>
                                <div style="font-size: 10px; opacity: 0.8;">${dimensions}</div>
                            </div>
                        </div>
                        <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px;"><strong>Image ${i + 1}</strong></span>
                            <input type="checkbox" style="width: 16px; height: 16px;">
                        </div>
                    </div>
                `;
            }

            // Show follow-up section
            document.getElementById('imageFollowupSection').style.display = 'block';
            updatePromptHistory('image');
        }

        // Handle image file upload
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            const grid = document.getElementById('draftImagesGrid');

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageIndex = grid.children.length + 1;
                    const card = document.createElement('div');
                    card.className = 'creative-card';
                    card.onclick = function() { toggleImageSelect(this); };
                    card.dataset.image = imageIndex;
                    card.style.cssText = 'border: 2px solid #eee; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s;';
                    card.innerHTML = `
                        <div style="height: 120px; background-image: url('${e.target.result}'); background-size: cover; background-position: center;"></div>
                        <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px;"><strong>${file.name.substring(0, 15)}...</strong></span>
                            <input type="checkbox" style="width: 16px; height: 16px;">
                        </div>
                    `;
                    grid.appendChild(card);
                };
                reader.readAsDataURL(file);
            });

            // Show follow-up section
            document.getElementById('imageFollowupSection').style.display = 'block';
        }

        // Refine images with follow-up prompt
        function refineImages() {
            const followupPrompt = document.getElementById('imageFollowupPrompt').value;
            if (!followupPrompt.trim()) return;

            // Add to history
            imagePromptHistory.push({ type: 'followup', prompt: followupPrompt });
            updatePromptHistory('image');

            // Clear input
            document.getElementById('imageFollowupPrompt').value = '';

            // Mock: regenerate images (in real app, would call API with history)
            alert('Refining images with: "' + followupPrompt + '"\n\n(In production, this would call the AI API with the full prompt history)');
        }

        // Refine ad copy with follow-up prompt
        function refineAdCopy() {
            const followupPrompt = document.getElementById('adCopyFollowupPrompt').value;
            if (!followupPrompt.trim()) return;

            // Add to history
            adCopyPromptHistory.push({ type: 'followup', prompt: followupPrompt });
            updatePromptHistory('adCopy');

            // Clear input
            document.getElementById('adCopyFollowupPrompt').value = '';

            // Mock: regenerate ad copy (in real app, would call API with history)
            alert('Refining ad copy with: "' + followupPrompt + '"\n\n(In production, this would call the AI API with the full prompt history)');
        }

        // Update prompt history display
        function updatePromptHistory(type) {
            const history = type === 'image' ? imagePromptHistory : adCopyPromptHistory;
            const container = document.getElementById(type + 'PromptHistory');
            if (!container) return;

            if (history.length <= 1) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<strong>Prompt History:</strong><br>' +
                history.map((h, i) => `${i + 1}. ${h.type === 'initial' ? '[Initial]' : '[Refinement]'} ${h.prompt.substring(0, 50)}...`).join('<br>');
        }

        // Toggle image selection
        function toggleImageSelect(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            const imageId = element.dataset.image;

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                element.style.borderColor = '#667eea';
                element.style.boxShadow = '0 0 0 2px rgba(102, 126, 234, 0.3)';
                selectedImages.add(imageId);
            } else {
                element.style.borderColor = '#eee';
                element.style.boxShadow = 'none';
                selectedImages.delete(imageId);
            }

            updateCreativeSummary();
        }

        // Selected ad copy tracking
        let selectedTitles = new Set();
        let selectedDescriptions = new Set();
        let selectedPostTexts = new Set();

        // Generate mock ad copy (titles, descriptions, post texts)
        function generateDraftAdCopy() {
            const listName = currentDraftList?.name || 'Collection';

            // Store initial prompts in history
            if (adCopyPromptHistory.length === 0) {
                adCopyPromptHistory.push({ type: 'initial', prompt: 'Generated all ad copy' });
            }

            // Mock titles
            const titles = [
                `Shop ${listName} Now!`,
                `${listName} Sale - Limited Time`,
                `Best ${listName} Picks`,
                `Top ${listName} Deals`,
                `Discover ${listName}`
            ];

            // Mock descriptions
            const descriptions = [
                `Hand-picked by top creators. Quality guaranteed.`,
                `Top-rated products at unbeatable prices.`,
                `Curated collection for smart shoppers.`,
                `Trending items you'll love. Shop now!`,
                `Premium selection, amazing value.`
            ];

            // Mock post texts
            const postTexts = [
                `Discover amazing deals on ${listName}. Hand-picked by top creators. Shop now and save!`,
                `Don't miss out on our curated ${listName} collection. Top-rated products at unbeatable prices!`,
                `Looking for the perfect ${listName}? Our experts found the best for you. Limited time only!`,
                `Upgrade your life with these top-rated ${listName} products. Trusted by thousands!`,
                `Your search for the best ${listName} ends here. Shop the collection now!`
            ];

            // Populate titles
            const titlesList = document.getElementById('adTitlesList');
            const titleLabels = titlesList.querySelectorAll('.ad-copy-item');
            titles.forEach((t, i) => {
                if (titleLabels[i]) {
                    titleLabels[i].querySelector('span').textContent = t;
                    titleLabels[i].querySelector('span').style.color = '#333';
                }
            });

            // Populate descriptions
            const descList = document.getElementById('adDescriptionsList');
            const descLabels = descList.querySelectorAll('.ad-copy-item');
            descriptions.forEach((d, i) => {
                if (descLabels[i]) {
                    descLabels[i].querySelector('span').textContent = d;
                    descLabels[i].querySelector('span').style.color = '#333';
                }
            });

            // Populate post texts
            const postList = document.getElementById('adPostTextsList');
            const postLabels = postList.querySelectorAll('.ad-copy-item');
            postTexts.forEach((p, i) => {
                if (postLabels[i]) {
                    postLabels[i].querySelector('span').textContent = p;
                    postLabels[i].querySelector('span').style.color = '#333';
                }
            });

            // Show follow-up section
            document.getElementById('adCopyFollowupSection').style.display = 'block';
            updatePromptHistory('adCopy');
        }

        // Update ad copy selection counts
        function updateAdCopySelection() {
            // Count selected items
            selectedTitles = new Set();
            selectedDescriptions = new Set();
            selectedPostTexts = new Set();

            document.querySelectorAll('input[data-type="title"]:checked').forEach(cb => {
                selectedTitles.add(cb.dataset.index);
            });
            document.querySelectorAll('input[data-type="description"]:checked').forEach(cb => {
                selectedDescriptions.add(cb.dataset.index);
            });
            document.querySelectorAll('input[data-type="posttext"]:checked').forEach(cb => {
                selectedPostTexts.add(cb.dataset.index);
            });

            // Update count displays
            document.getElementById('selectedTitlesCount').textContent = `(${selectedTitles.size} selected)`;
            document.getElementById('selectedDescriptionsCount').textContent = `(${selectedDescriptions.size} selected)`;
            document.getElementById('selectedPostTextsCount').textContent = `(${selectedPostTexts.size} selected)`;

            // Update totals in summary
            document.getElementById('selectedTitlesTotal').textContent = selectedTitles.size;
            document.getElementById('selectedDescTotal').textContent = selectedDescriptions.size;
            document.getElementById('selectedPostTotal').textContent = selectedPostTexts.size;

            // Calculate total combinations
            updateCreativeSummary();

            // Style selected items
            document.querySelectorAll('.ad-copy-item').forEach(label => {
                const cb = label.querySelector('input[type="checkbox"]');
                if (cb && cb.checked) {
                    label.style.borderColor = '#667eea';
                    label.style.background = '#f8f9ff';
                } else {
                    label.style.borderColor = '#eee';
                    label.style.background = 'white';
                }
            });
        }

        // Update creative summary
        function updateCreativeSummary() {
            // Update image count
            const imgCount = document.getElementById('selectedImagesCount');
            if (imgCount) imgCount.textContent = selectedImages.size;

            // Calculate total combinations: images × titles × descriptions × post texts
            const titlesCount = selectedTitles?.size || 0;
            const descCount = selectedDescriptions?.size || 0;
            const postCount = selectedPostTexts?.size || 0;

            // Total = images × (titles × descriptions × post texts)
            // If any category is 0, use 1 as minimum for calculation display
            const effectiveTitles = titlesCount || 1;
            const effectiveDesc = descCount || 1;
            const effectivePost = postCount || 1;
            const effectiveImages = selectedImages.size || 1;

            let total = 0;
            if (selectedImages.size > 0 && (titlesCount > 0 || descCount > 0 || postCount > 0)) {
                total = selectedImages.size * Math.max(1, titlesCount) * Math.max(1, descCount) * Math.max(1, postCount);
            }

            const totalCount = document.getElementById('totalCombinations');
            if (totalCount) totalCount.textContent = total;
        }

        // Navigate between draft steps
        function goToDraftStep(step) {
            currentDraftStep = step;

            // Hide list selector and all sections
            document.getElementById('draftListSelector').style.display = 'none';
            document.getElementById('draftSection1').style.display = 'none';
            document.getElementById('draftSection2').style.display = 'none';
            document.getElementById('draftSection3').style.display = 'none';
            document.getElementById('draftSection4').style.display = 'none';
            document.getElementById('draftSuccess').style.display = 'none';

            // Show current section
            if (step === 0) {
                document.getElementById('draftListSelector').style.display = 'block';
            } else {
                document.getElementById(`draftSection${step}`).style.display = 'block';
            }

            // Update step indicators
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`draftStep${i}`);
                if (stepEl) {
                    const circle = stepEl.querySelector('div');
                    if (i <= step) {
                        stepEl.style.color = '#667eea';
                        circle.style.background = '#667eea';
                        circle.style.color = 'white';
                    } else {
                        stepEl.style.color = '#999';
                        circle.style.background = '#eee';
                        circle.style.color = '#666';
                    }
                }
            }

            // Step-specific updates
            if (step === 2) {
                updateCampaignNamePreview();
            }
            if (step === 4) {
                updateReviewPage();
            }
        }

        // Update the review page (step 4)
        function updateReviewPage() {
            // Campaign summary
            document.getElementById('reviewCampaignName').textContent = document.getElementById('campaignNamePreview')?.value || '-';
            document.getElementById('reviewObjective').textContent = document.getElementById('campaignObjective')?.options[document.getElementById('campaignObjective').selectedIndex]?.text || 'Conversions';
            document.getElementById('reviewBudget').textContent = '$' + (document.getElementById('dailyBudget')?.value || '20');
            document.getElementById('reviewAudience').textContent = document.getElementById('targetAudience')?.options[document.getElementById('targetAudience').selectedIndex]?.text || 'Broad';
            document.getElementById('reviewListName').textContent = currentDraftList?.name || '-';

            // Creative summary - new multi-select format
            const titlesCount = selectedTitles?.size || 0;
            const descCount = selectedDescriptions?.size || 0;
            const postCount = selectedPostTexts?.size || 0;

            document.getElementById('reviewImagesCount').textContent = selectedImages.size;
            document.getElementById('reviewTitlesCount').textContent = titlesCount;
            document.getElementById('reviewDescCount').textContent = descCount;
            document.getElementById('reviewPostCount').textContent = postCount;

            // Calculate total combinations
            let total = 0;
            if (selectedImages.size > 0 && (titlesCount > 0 || descCount > 0 || postCount > 0)) {
                total = selectedImages.size * Math.max(1, titlesCount) * Math.max(1, descCount) * Math.max(1, postCount);
            }
            document.getElementById('reviewTotalAds').textContent = total;
            document.getElementById('reviewProductCount').textContent = currentDraftList?.products || currentDraftProducts.length || 0;

            // Warnings
            const warningsDiv = document.getElementById('reviewWarnings');
            const warningText = document.getElementById('reviewWarningText');
            const hasAdCopy = titlesCount > 0 || descCount > 0 || postCount > 0;
            if (selectedImages.size === 0 || !hasAdCopy) {
                warningsDiv.style.display = 'block';
                warningText.textContent = 'Please go back and select at least one image and some ad copy (titles, descriptions, or post texts).';
            } else {
                warningsDiv.style.display = 'none';
            }

            // Reset confirmation checkbox
            const confirmCheckbox = document.getElementById('confirmUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            if (confirmCheckbox) {
                confirmCheckbox.checked = false;
                confirmCheckbox.onchange = () => {
                    uploadBtn.disabled = !confirmCheckbox.checked || selectedImages.size === 0 || !hasAdCopy;
                    uploadBtn.style.opacity = uploadBtn.disabled ? '0.6' : '1';
                };
            }
        }

        // Update campaign name preview
        function updateCampaignNamePreview() {
            const template = document.getElementById('campaignNameTemplate')?.value || '{{storefront}}_{{list_name}}_{{date}}';
            const today = new Date().toISOString().split('T')[0];

            let preview = template
                .replace('{{storefront}}', currentDraftStorefront?.username || currentDraftStorefront?.id || 'storefront')
                .replace('{{list_name}}', (currentDraftList?.name || 'list').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30))
                .replace('{{date}}', today);

            const previewEl = document.getElementById('campaignNamePreview');
            if (previewEl) {
                previewEl.value = preview;
            }
        }

        // Mock upload to Facebook
        function uploadToFacebook() {
            const titlesCount = selectedTitles?.size || 0;
            const descCount = selectedDescriptions?.size || 0;
            const postCount = selectedPostTexts?.size || 0;
            const hasAdCopy = titlesCount > 0 || descCount > 0 || postCount > 0;

            if (selectedImages.size === 0 || !hasAdCopy) {
                alert('Please select at least one image and some ad copy (titles, descriptions, or post texts)');
                return;
            }

            // Hide all workflow sections
            document.getElementById('draftSection1').style.display = 'none';
            document.getElementById('draftSection2').style.display = 'none';
            document.getElementById('draftSection3').style.display = 'none';
            document.getElementById('draftSection4').style.display = 'none';
            document.getElementById('draftSuccess').style.display = 'block';

            // Calculate total ads
            const total = selectedImages.size * Math.max(1, titlesCount) * Math.max(1, descCount) * Math.max(1, postCount);

            // Update success info
            document.getElementById('finalCampaignName').textContent = document.getElementById('campaignNamePreview')?.value || '-';
            document.getElementById('finalBudget').textContent = document.getElementById('dailyBudget')?.value || '20';
            document.getElementById('finalAdsCount').textContent = total;
        }

        // Export draft list
        function exportDraftList() {
            if (!currentDraftList) return;

            const exportData = {
                list: currentDraftList,
                title: document.getElementById('draftFinalTitle').value,
                description: document.getElementById('draftFinalDesc').value,
                products: currentDraftProducts.map(p => ({
                    asin: p.asin,
                    title: p.title,
                    url: `https://www.amazon.com/dp/${p.asin}`,
                    price: p.price
                }))
            };

            downloadJSON(exportData, `draft-${currentDraftList.id}.json`);
        }

        // Back to lists
        function backToLists() {
            // Switch to lists tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.nav-tab[data-tab="lists"]').classList.add('active');
            document.getElementById('lists-tab').classList.add('active');

            // Reset draft state
            currentDraftList = null;
            currentDraftStorefront = null;
            currentDraftProducts = [];
            selectedImages = new Set();
            selectedTitles = new Set();
            selectedDescriptions = new Set();
            selectedPostTexts = new Set();
            imagePromptHistory = [];
            adCopyPromptHistory = [];
        }

        // Override tab switching for draft tab
        function handleDraftTabClick() {
            // If no list selected, show selector
            if (!currentDraftList) {
                showDraftSelector();
            }
            // Otherwise keep current state
        }

        // Add event listeners after data loads
        function setupDraftEventListeners() {
            const templateInput = document.getElementById('campaignNameTemplate');
            if (templateInput) {
                templateInput.addEventListener('input', updateCampaignNamePreview);
            }

            // Override draft tab click
            const draftTab = document.getElementById('draftTab');
            if (draftTab) {
                draftTab.addEventListener('click', (e) => {
                    // Only trigger if clicking the draft tab itself
                    if (e.target === draftTab || e.target.parentElement === draftTab) {
                        handleDraftTabClick();
                    }
                });
            }
        }

        // Initialize draft tab when data is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for data to load, then init
            setTimeout(() => {
                initDraftTab();
                setupDraftEventListeners();
            }, 500);
        });
    </script>
</body>
</html>
